"use strict";var DataTypesCache,OrderComments,MediaStatusComments,StarTypes,MediaType,EventTypes,HTTP_VERBS,Picked,MovieStatus,SortTypeSubtitles,SubtitleTypes,SubtitleLanguages,DaysOfWeek,NotifTypes;!function(e){e.shows="shows",e.episodes="episodes",e.movies="movies",e.members="members",e.updates="updateAuto"}(DataTypesCache=DataTypesCache||{});class CacheUS{_data;constructor(){return this._init()}_init(){return this._data={},this._data[DataTypesCache.shows]={},this._data[DataTypesCache.episodes]={},this._data[DataTypesCache.movies]={},this._data[DataTypesCache.members]={},this}keys(e=null){return e?Object.keys(this._data[e]):Object.keys(this._data)}has(e,t){return void 0!==this._data[e]&&void 0!==this._data[e][t]}clear(e=null){if(e&&void 0!==this._data[e])for(const t in this._data[e])delete this._data[e][t];else this._init();return this}get(e,t){return this.has(e,t)?this._data[e][t]:null}getOrDefault(e,t,s){return this.has(e,t)?this.get(e,t):s}set(e,t,s){return void 0!==this._data[e]&&(this._data[e][t]=s),this}remove(e,t){return this.has(e,t)&&delete this._data[e][t],this}}class Character{actor;description;guest;id;name;picture;role;show_id;movie_id;person_id;constructor(e){this.actor=e.actor||"",this.picture=e.picture||"",this.name=e.name||"",this.guest=!!e.guest||!1,this.id=void 0!==e.id?parseInt(e.id,10):0,this.description=e.description||"",this.role=e.role||"",this.show_id=void 0!==e.show_id?parseInt(e.show_id,10):0,this.movie_id=void 0!==e.movie_id?parseInt(e.movie_id,10):0,this.person_id=void 0!==e.person_id?parseInt(e.person_id,10):0}}class personMedia{show;movie;role;type;constructor(e,t){t===MediaType.show?this.show=new Show(e.show):t===MediaType.movie&&(this.movie=new Movie(e.movie)),this.role=e.name,this.type=t}get media(){return this.type===MediaType.show?this.show:this.type===MediaType.movie?this.movie:void 0}}class Person{static fetch(e){return Base.callApi(HTTP_VERBS.GET,"persons","person",{id:e}).then(e=>e?new Person(e.person):null)}id;name;birthday;deathday;description;last;shows;movies;constructor(t){this.id=void 0!==t.id?parseInt(t.id,10):0,this.name=t.name||"",this.birthday=t.birthday?new Date(t.birthday):null,this.deathday=t.deathday?new Date(t.deathday):null,this.description=t.description||"",this.shows=[];for(let e=0;e<t.shows.length;e++)this.shows.push(new personMedia(t.shows[e],MediaType.show));this.movies=[];for(let e=0;e<t.movies.length;e++)this.movies.push(new personMedia(t.movies[e],MediaType.movie));t.last?.show?this.last=new personMedia(t.last,MediaType.show):t.last?.movie&&(this.last=new personMedia(t.last,MediaType.movie))}}!function(e){e.DESC="desc",e.ASC="asc"}(OrderComments=OrderComments||{}),function(e){e.OPEN="open",e.CLOSED="close"}(MediaStatusComments=MediaStatusComments||{});class CommentsBS{static EventTypes=["update","save","add","added","delete","show"];static sendComment(t,e){e={type:t.mediaType.singular,id:t.id,text:e};return Base.callApi(HTTP_VERBS.POST,"comments","comment",e).then(e=>{e=new CommentBS(e.comment,t.comments);return t.comments.addComment(e),t.comments.is_subscribed=!0,e}).catch(e=>{Base.notification("Commentaire","Erreur durant l'ajout d'un commentaire"),console.error(e)})}comments;nbComments;is_subscribed;status;_parent;_events;_listeners;_order;constructor(e,t){this.comments=[],this._parent=t,this.is_subscribed=!1,this.status=MediaStatusComments.OPEN,this.nbComments=e,this._order=OrderComments.DESC,this._initListeners()}init(){const i=this;function e(){const t=jQuery("#comments .slides_flex .slide_flex .slide__comment");let s;for(let e=0;e<t.length;e++)(s=jQuery(t.get(e))).attr("data-comment-id",i.comments[e].id)}var t;this.comments.length<=0&&0<this.nbComments?(t=jQuery("#comments .slides_flex .slide_flex"),this.fetchComments(t.length).then(e)):e()}_initListeners(){this._listeners={};var t=CommentsBS.EventTypes;for(let e=0;e<t.length;e++)this._listeners[t[e]]=[];return this}addListener(e,t,...s){if(CommentsBS.EventTypes.indexOf(e)<0)throw new Error(e+" ne fait pas partit des events gérés par cette classe");void 0===this._listeners[e]&&(this._listeners[e]=[]);for(const i in this._listeners[e])if(i.toString()==t.toString())return void(Base.debug&&console.warn("Cette fonction est déjà présente pour event[%s]",e));return 0<s.length?this._listeners[e].push({fn:t,args:s}):this._listeners[e].push(t),Base.debug&&console.log("Base[%s] add Listener on event %s",this.constructor.name,e,this._listeners[e]),this}removeListener(t,s){if(void 0!==this._listeners[t])for(let e=0;e<this._listeners[t].length;e++)("function"==typeof this._listeners[t][e]&&this._listeners[t][e].toString()===s.toString()||this._listeners[t][e].fn.toString()==s.toString())&&this._listeners[t].splice(e,1);return this}_callListeners(t){if(void 0!==this._listeners[t]&&0<this._listeners[t].length){var s=new CustomEvent("betaseries",{detail:{name:t}});Base.debug&&console.log("Comments call %d Listeners on event %s",this._listeners[t].length,t);for(let e=0;e<this._listeners[t].length;e++)"function"==typeof this._listeners[t][e]?this._listeners[t][e].call(this,s,this):this._listeners[t][e].fn.apply(this,this._listeners[t][e].args)}return this}get length(){return this.comments.length}get media(){return this._parent}get order(){return this._order}set order(e){this._order=e}fetchComments(i=50,n=0,e=OrderComments.DESC){e!==this._order&&(this.order=e);const a=this;return new Promise((e,t)=>{const s={type:a._parent.mediaType.singular,id:a._parent.id,nbpp:i,replies:0,order:a.order};0<n&&(s.since_id=n),Base.callApi(HTTP_VERBS.GET,"comments","comments",s).then(t=>{if(void 0!==t.comments){n<=0&&(a.comments=[]);for(let e=0;e<t.comments.length;e++)a.comments.push(new CommentBS(t.comments[e],a))}a.nbComments=parseInt(t.total,10),a.is_subscribed=!!t.is_subscribed,a.status=t.status,e(a)}).catch(e=>{console.warn("fetchComments",e),Base.notification("Récupération des commentaires","Une erreur est apparue durant la récupération des commentaires"),t(e)})})}addComment(e){const t=this.order==OrderComments.DESC?Array.prototype.unshift:Array.prototype.push;return Base.debug&&console.log("addComment order: %s - method: %s",this.order,t.name),e instanceof CommentBS?t.call(this.comments,e):t.call(this.comments,new CommentBS(e,this)),this.nbComments++,this.media.nbComments++,Base.debug&&console.log("addComment listeners",this._listeners),this._callListeners(EventTypes.ADD),this}removeComment(t){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t){this.comments.splice(e,1),this.removeFromPage(t),this.nbComments--,this.media.nbComments--,this._callListeners("delete");break}return this}isFirst(e){return this.comments[0].id===e}isLast(e){return this.comments[this.comments.length-1].id===e}isOpen(){return this.status===MediaStatusComments.OPEN}getComment(t){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t)return this.comments[e];return null}getPrevComment(t){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t&&0<e)return this.comments[e-1];return null}getNextComment(t){var s=this.comments.length;for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t&&e<s-1)return this.comments[e+1];return null}async fetchReplies(e,t=OrderComments.ASC){var s=await Base.callApi(HTTP_VERBS.GET,"comments","replies",{id:e,order:t});const i=[];if(s.comments)for(let e=0;e<s.comments.length;e++)i.push(new CommentBS(s.comments[e],this));return i}changeThumbs(t,s,i){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t)return this.comments[e].thumbs=s,this.comments[e].thumbed=i,!0;return!1}async getTemplate(i){const n=this;return new Promise((e,t)=>{let s=Promise.resolve(n);Base.debug&&console.log("Base ",{length:n.comments.length,nbComments:n.nbComments}),n.comments.length<=0&&0<n.nbComments&&(Base.debug&&console.log("Base fetchComments call"),s=n.fetchComments(i)),s.then(async()=>{let t,s=`
                        <div data-media-type="${n._parent.mediaType.singular}"
                            data-media-id="${n._parent.id}"
                            class="displayFlex flexDirectionColumn"
                            style="margin-top: 2px; min-height: 0">`;Base.userIdentified()&&(s+=`
                    <button type="button" class="btn-reset btnSubscribe" style="position: absolute; top: 3px; right: 31px; padding: 8px;">
                        <span class="svgContainer">
                            <svg></svg>
                        </span>
                    </button>`),s+='<div class="comments overflowYScroll">';for(let e=0;e<n.comments.length;e++){t=n.comments[e],s+=CommentBS.getTemplateComment(t),0<t.nbReplies&&t.replies.length<=0&&(Base.debug&&console.log("Comments render getTemplate fetchReplies"),await t.fetchReplies());for(let e=0;e<t.replies.length;e++)s+=CommentBS.getTemplateComment(t.replies[e])}n.comments.length<n.nbComments&&(s+=`
                        <button type="button" class="btn-reset btn-greyBorder moreComments" style="margin-top: 10px; width: 100%;">
                            ${Base.trans("timeline.comments.display_more")}
                            <i class="fa fa-cog fa-spin fa-2x fa-fw" style="display:none;margin-left:15px;vertical-align:middle;"></i>
                            <span class="sr-only">Loading...</span>
                        </button>`),s+="</div>",n.isOpen()&&Base.userIdentified()&&(s+=CommentBS.getTemplateWriting()),e(s+"</div>")}).catch(e=>{t(e)})})}getLogins(){const t=[];for(let e=0;e<this.comments.length;e++)t.includes(this.comments[e].login)||t.push(this.comments[e].login);return t}updateCounter(){const e=jQuery("#comments .blockTitle");e.text(e.text().replace(/\d+/,this.nbComments.toString()))}loadEvents(h,p,u){this._events=[];async function m(t){var s=parseInt(t.data("commentId"),10);let i;if(t.hasClass("reply")){let e=t.prev();for(;e.hasClass("reply");)e=e.prev();t=parseInt(e.data("commentId"),10);if(s==t)i=g.getComment(s);else{const n=g.getComment(t);i=await n.getReply(s)}}else i=g.getComment(s);return i}const g=this,s=jQuery("#popin-dialog"),e=jQuery("#popin-showClose"),t=(e.click(()=>{u.hidePopup(),s.removeAttr("data-popin-type")}),this._events.push({elt:e,event:"click"}),h.find(".toggleAllReplies")),i=(t.click(e=>{const t=jQuery(e.currentTarget);e=t.attr("data-toggle");const s=h.find(`.toggleReplies[data-toggle="${e}"]`);"1"==e?(s.trigger("click"),t.attr("data-toggle","0"),t.text("Afficher toutes les réponses")):(s.trigger("click"),t.attr("data-toggle","1"),t.text("Masquer toutes les réponses"))}),this._events.push({elt:t,event:"click"}),h.find(".btnSubscribe"));function n(e){g.is_subscribed?g.is_subscribed&&(e.addClass("active"),e.attr("title","Ne plus recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg width="20" height="22" viewBox="0 0 20 22" style="width: 17px;">
                        <g transform="translate(-4)" fill="none">
                            <path d="M0 0h24v24h-24z"></path>
                            <path fill="${"dark"==Base.theme?"rgba(255, 255, 255, .5)":"#333"}" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32v-.68c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68c-2.87.68-4.5 3.24-4.5 6.32v5l-2 2v1h16v-1l-2-2z"></path>
                        </g>
                    </svg>
                `)):(e.removeClass("active"),e.attr("title","Recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg fill="${"dark"==Base.theme?"rgba(255, 255, 255, .5)":"#333"}" width="14" height="16" style="position: relative; top: 1px; left: -1px;">
                        <path fill-rule="nonzero" d="M13.176 13.284L3.162 2.987 1.046.812 0 1.854l2.306 2.298v.008c-.428.812-.659 1.772-.659 2.806v4.103L0 12.709v.821h11.307l1.647 1.641L14 14.13l-.824-.845zM6.588 16c.914 0 1.647-.73 1.647-1.641H4.941c0 .91.733 1.641 1.647 1.641zm4.941-6.006v-3.02c0-2.527-1.35-4.627-3.705-5.185V1.23C7.824.55 7.272 0 6.588 0c-.683 0-1.235.55-1.235 1.23v.559c-.124.024-.239.065-.346.098a2.994 2.994 0 0 0-.247.09h-.008c-.008 0-.008 0-.017.009-.19.073-.379.164-.56.254 0 0-.008 0-.008.008l7.362 7.746z"></path>
                    </svg>
                `))}i.click(e=>{if(e.stopPropagation(),e.preventDefault(),Base.userIdentified()){const t=$(e.currentTarget);e={type:g._parent.mediaType.singular,id:g._parent.id};t.hasClass("active")?Base.callApi(HTTP_VERBS.DELETE,"comments","subscription",e).then(()=>{g.is_subscribed=!1,n(t)}):Base.callApi(HTTP_VERBS.POST,"comments","subscription",e).then(()=>{g.is_subscribed=!0,n(t)})}else faceboxDisplay("inscription",{},()=>{})}),n(i),this._events.push({elt:i,event:"click"});const a=h.find(".view-spoiler"),r=(0<a.length&&a.click(e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget),s=t.next(".comment-text").find(".spoiler");s.is(":visible")?(s.fadeOut("fast"),t.text("Voir le spoiler")):(s.fadeIn("fast"),t.text("Cacher le spoiler"))}),this._events.push({elt:a,event:"click"}),h.find(".comments .comment .btnThumb")),o=(r.click(async i=>{if(i.stopPropagation(),i.preventDefault(),Base.userIdentified()){const a=jQuery(i.currentTarget),r=a.parents(".comment");i=parseInt(r.data("commentId"),10);let t;if(r.hasClass("reply")){let e=r.prev();for(;e.hasClass("reply");)e=e.prev();var n=parseInt(e.data("commentId"),10);if(i==n)t=this.getComment(i);else{const l=this.getComment(n);t=await l.getReply(i)}}else t=this.getComment(i);let e=HTTP_VERBS.POST;const o=a.hasClass("btnUpVote")?1:-1;let s={id:i,type:o,switch:!1};if(t.thumbed==o)e=HTTP_VERBS.DELETE,s={id:i};else if(0!=t.thumbed)return void console.warn("Le vote est impossible. Annuler votre vote et recommencer");Base.callApi(e,"comments","thumb",s).then(e=>{t.thumbs=parseInt(e.comment.thumbs,10),t.thumbed=e.comment.thumbed?parseInt(e.comment.thumbed,10):0,t.updateRenderThumbs(o)}).catch(e=>{e=void 0!==e.text?e.text:e;Base.notification("Thumb commentaire","Une erreur est apparue durant le vote: "+e)})}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:r,event:"click"}),h.find(".btnToggleOptions")),l=(o.click(e=>{e.stopPropagation(),e.preventDefault(),jQuery(e.currentTarget).parents(".actionsCmt").first().find(".options-comment").each((e,t)=>{const s=jQuery(t);s.is(":visible")?s.hide():s.show()})}),this._events.push({elt:o,event:"click"}),h.find(".sendComment")),d=(l.click(async t=>{if(t.stopPropagation(),t.preventDefault(),Base.userIdentified()){var i=function(e){return jQuery(t.currentTarget).parents(".writing").prev(".comments").find(`.comment[data-comment-id="${e.toString()}"]`)};const o=$(t.currentTarget).siblings("textarea");if(0<o.val().length){var n=o.data("action"),a=o.val();let e,s;if(o.data("replyTo")){var r=parseInt(o.data("replyTo"),10);e=g.getComment(r);const l=i(r);s=e.sendReply(o.val()).then(s=>{if(s instanceof CommentBS){o.val(""),o.siblings("button").attr("disabled","true"),o.removeAttr("data-reply-to");s=CommentBS.getTemplateComment(s);if(l.next(".comment").hasClass("reply")){let e=l.next(".comment"),t;for(;e.hasClass("reply");)e=(t=e).next(".comment");t.after(s)}else l.after(s)}})}else if(n&&"edit"===n){const d=parseInt(o.data("commentId"),10);let t=i(d);const c=await m(t);s=c.edit(a).then(e=>{t.find(".comment-text").text(e.text),(t=jQuery(`#comments .slide_flex .slide__comment[data-comment-id="${d}"]`)).find("p").text(e.text),o.removeAttr("data-action"),o.removeAttr("data-comment-id"),o.val(""),o.siblings("button").attr("disabled","true")})}else s=CommentsBS.sendComment(g._parent,o.val()).then(e=>{if(e){o.val(""),o.siblings("button").attr("disabled","true");const t=o.parents(".writing").prev(".comments");this.order===OrderComments.DESC?t.prepend(CommentBS.getTemplateComment(e)):t.append(CommentBS.getTemplateComment(e)),t.find(`.comment[data-comment-id="${e.id}"]`).get(0).scrollIntoView(),g.addToPage(e.id)}});s.then(()=>{g.cleanEvents(()=>{g.loadEvents(h,p,u)})})}}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:l,event:"click"}),h.find("textarea")),c=(d.keypress(e=>{const t=$(e.currentTarget);0<t.val().length?t.siblings("button").removeAttr("disabled"):t.siblings("button").attr("disabled","true")}),this._events.push({elt:d,event:"keypress"}),h.find(".baliseSpoiler")),f=(c.click(()=>{const e=s.find("textarea");var t;/\[spoiler\]/.test(e.val())||(t="[spoiler]"+e.val()+"[/spoiler]",e.val(t))}),this._events.push({elt:c,event:"click"}),h.find(".comments .toggleReplies")),v=(f.click(e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget);e=t.attr("data-toggle");const s=t.parents(".comment");var i=s.data("commentInner");const n=s.parents(".comments").find(`.comment[data-comment-reply="${i}"]`);"0"==e?(n.fadeIn("fast"),t.find(".btnText").text(Base.trans("comment.hide_answers")),t.find("svg").attr("style","transition: transform 200ms ease 0s; transform: rotate(180deg);"),t.attr("data-toggle","1")):(n.fadeOut("fast"),t.find(".btnText").text(Base.trans("comment.button.reply",{"%count%":n.length.toString()},n.length)),t.find("svg").attr("style","transition: transform 200ms ease 0s;"),t.attr("data-toggle","0"))}),this._events.push({elt:f,event:"click"}),h.find(".btnResponse")),b=(v.click(async e=>{if(e.stopPropagation(),e.preventDefault(),Base.userIdentified()){const t=$(e.currentTarget);e=t.parents(".comment"),e=await m(e);h.find("textarea").val("@"+e.login).attr("data-reply-to",e.id)}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:v,event:"click"}),h.find(".moreComments")),_=(b.click(e=>{e.stopPropagation(),e.preventDefault();const i=jQuery(e.currentTarget);if(g.comments.length>=g.nbComments)i.hide();else{const t=i.find(".fa-spin");t.show();e=g.comments[g.comments.length-1].id;const n=g.comments.length-1;g.fetchComments(p,e).then(async()=>{let t="",s;const e=g.comments[1+n].id;for(let e=1+n;e<g.comments.length;e++){s=g.comments[e],t+=CommentBS.getTemplateComment(s),0<s.nbReplies&&s.replies.length<=0&&(s.replies=await g.fetchReplies(s.id));for(let e=0;e<s.replies.length;e++)t+=CommentBS.getTemplateComment(s.replies[e])}i.before(t),jQuery(`.comment[data-comment-id="${e.toString()}"]`).get(0).scrollIntoView(),g.cleanEvents(()=>{g.loadEvents(h,p,u)}),g.comments.length>=g.nbComments&&i.hide()}).finally(()=>{t.hide()})}}),this._events.push({elt:b,event:"click"}),h.find(".btnEditComment")),y=(_.click(async e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget).parents(".comment");var e=parseInt(t.data("commentId"),10),s=await m(t);d.val(s.text),d.attr("data-action","edit"),d.attr("data-comment-id",e)}),this._events.push({elt:_,event:"click"}),h.find(".btnDeleteComment"));y.click(async e=>{e.stopPropagation(),e.preventDefault();const i=jQuery(e.currentTarget).parents(".comment"),t=jQuery(e.currentTarget).parents(".options-options");t.hide().after(`
                <div class="options-delete">
                    <span class="mainTime">Supprimer mon commentaire :</span>
                    <button type="button" class="btn-reset fontWeight700 btnYes" style="vertical-align: 0px; padding-left: 10px; padding-right: 10px; color: rgb(208, 2, 27);">Oui</button>
                    <button type="button" class="btn-reset mainLink btnNo" style="vertical-align: 0px;">Non</button>
                </div>
            `);const s=i.find(".options-delete .btnYes"),n=i.find(".options-delete .btnNo"),a=await m(i);s.click(e=>{e.stopPropagation(),e.preventDefault(),a.delete();let t=i.next(".comment"),s;for(;t.hasClass("reply");)t=(s=t).next(".comment"),s.remove();i.remove(),g.updateCounter()}),n.click(e=>{e.stopPropagation(),e.preventDefault(),i.find(".options-delete").remove(),t.show(),s.off("click"),n.off("click")})}),this._events.push({elt:y,event:"click"}),this._callListeners(EventTypes.SHOW)}cleanEvents(e=Base.noop){if(this._events&&0<this._events.length){let t;for(let e=0;e<this._events.length;e++)0<(t=this._events[e]).elt.length&&t.elt.off(t.event)}this._events=[],e()}render(){Base.debug&&console.log("CommentsBS render");const t=this,s=jQuery("#popin-dialog"),e=s.find(".popin-content-html"),i=s.find(".popin-content-reactmodule"),n=s.find("#popin-showClose"),a=()=>{document.body.style.overflow="visible",document.body.style.paddingRight="",s.attr("aria-hidden","true"),s.find("#popupalertyes").show(),s.find("#popupalertno").show(),e.hide(),i.empty(),t.cleanEvents()},r=()=>{document.body.style.overflow="hidden",document.body.style.paddingRight=getScrollbarWidth()+"px",s.find("#popupalertyes").hide(),s.find("#popupalertno").hide(),e.hide(),i.show(),n.show(),s.attr("aria-hidden","false")},o=(i.empty().append(`<div class="title" id="dialog-title" tabindex="0">${Base.trans("blog.title.comments")}</div>`),i.find(".title"));o.append('<button type="button" class="btn-primary toggleAllReplies" data-toggle="1" style="border-radius:4px;margin-left:10px;">Cacher toutes les réponses</button>');let l=`
            <div class="loaderCmt">
                <svg class="sr-only">
                    <defs>
                        <clipPath id="placeholder">
                            <path d="M50 25h160v8H50v-8zm0-18h420v8H50V7zM20 40C8.954 40 0 31.046 0 20S8.954 0 20 0s20 8.954 20 20-8.954 20-20 20z"></path>
                        </clipPath>
                    </defs>
                </svg>
        `;for(let e=0;e<4;e++)l+=`
                <div class="er_ex null"><div class="ComponentPlaceholder er_et " style="height: 40px;"></div></div>`;i.append(l+"</div>"),r();t.getTemplate(20).then(e=>{s.attr("data-popin-type","comments"),i.fadeOut("fast",()=>{i.find(".loaderCmt").remove(),i.append(e),i.fadeIn(),t.cleanEvents(),t.loadEvents(i,20,{hidePopup:a,showPopup:r})})})}addToPage(e){const t=this.getComment(e);e=t.text.substring(0,210);let s="";210<t.text.length&&(s='<span class="u-colorWhiteOpacity05 u-show-fulltext positionRelative zIndex1"></span><span class="sr-only">'+t.text.substring(210)+"</span>");var i=t.avatar||"https://img.betaseries.com/NkUiybcFbxbsT_EnzkGza980XP0=/42x42/smart/https%3A%2F%2Fwww.betaseries.com%2Fimages%2Fsite%2Favatar-default.png",e=`
            <div class="slide_flex">
                <div class="slide__comment positionRelative u-insideBorderOpacity u-insideBorderOpacity--01" data-comment-id="${t.id}">
                    <p>${e} ${s}</p>
                    <button type="button" class="btn-reset js-popup-comments zIndex10" data-comment-id="${t.id}"></button>
                </div>
                <div class="slide__author">
                    <div class="media">
                        <span class="media-left avatar">
                            <a href="https://www.betaseries.com/membre/${t.login}">
                                <img class="u-opacityBackground" src="${i}" width="42" height="42" alt="avatar de ${t.login}" />
                            </a>
                        </span>
                        <div class="media-body">
                            <div class="displayFlex alignItemsCenter">
                                ${t.login}
                                <span class="stars">${Note.renderStars(t.user_note,t.user_id===Base.userId?"blue":"")}</span>
                            </div>
                            <div>
                                <time class="u-colorWhiteOpacity05" style="font-size: 14px;">
                                    ${t.date.format("dd mmmm yyyy")}
                                </time>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;jQuery("#comments .slides_flex").prepend(e),jQuery("#comments .blockTitle").text(jQuery("#comments .blockTitle").text().replace(/\d+/,this._parent.nbComments.toString())),this._callListeners(EventTypes.ADDED)}removeFromPage(e){const t=jQuery(`#comments .slides_flex .slide__comment[data-comment-id="${e}"]`);t.parents(".slide_flex").remove()}showEvaluations(){const r=this;var e={type:this.media.mediaType.singular,id:this.media.id,replies:1,nbpp:this.media.nbComments};return Base.callApi(HTTP_VERBS.GET,"comments","comments",e).then(e=>{let t=e.comments||[];t=t.filter(e=>0<e.user_note);const s={1:0,2:0,3:0,4:0,5:0},i=[];let n=0;for(let e=0;e<t.length;e++)i.includes(t[e].user_id)||(i.push(t[e].user_id),n++,s[t[e].user_note]++);let a=`
                <div class="evaluations">
                    <div class="size-base">${n} évaluation${1<n?"s":""} parmis les commentaires et ${this.media.objNote.total} au total</div>
                    <div class="size-base average">Note globale: <strong>${r._parent.objNote.mean.toFixed(2)}</strong></div>
                    <div><table><tbody>`;for(let e=5;0<e;e--)a+=function(e,t){const s=0<n?100*t[e]/n:0;return`<tr class="histogram-row">
                    <td class="nowrap">${e} étoile${1<e?"s":""}</td>
                    <td class="span10">
                        <div class="meter" role="progressbar" aria-valuenow="${s.toFixed(1)}%">
                            <div class="meter-filled" style="width: ${s.toFixed(1)}%"></div>
                        </div>
                    </td>
                    <td class="nowrap">${s.toFixed(1)}%</td>
                </tr>`}(e,s);return a+'</tbody></table><p class="alert alert-info"><small>Les pourcentages sont calculés uniquement sur les évaluations dans les commentaires.</small></p></div>'})}}class CommentBS{static EventTypes=["update","save","add","delete","show","hide"];static classNamesCSS={reply:"it_i3",actions:"it_i1",comment:"it_ix"};id;reference;type;ref_id;user_id;login;avatar;date;text;inner_id;in_reply_to;in_reply_id;in_reply_user;user_note;thumbs;thumbed;nbReplies;replies;from_admin;user_rank;_parent;_events;_listeners;constructor(e,t){return this._parent=t,this.fill(e)._initListeners()}fill(e){return this.id=parseInt(e.id,10),this.reference=e.reference,this.type=e.type,this.ref_id=parseInt(e.ref_id,10),this.user_id=parseInt(e.user_id,10),this.login=e.login,this.avatar=e.avatar,this.date=new Date(e.date),this.text=e.text,this.inner_id=parseInt(e.inner_id,10),this.in_reply_to=parseInt(e.in_reply_to,10),this.in_reply_id=parseInt(e.in_reply_id,10),this.in_reply_user=e.in_reply_user,this.user_note=e.user_note?parseInt(e.user_note,10):0,this.thumbs=parseInt(e.thumbs,10),this.thumbed=e.thumbed?parseInt(e.thumbed,10):0,this.nbReplies=parseInt(e.replies,10),this.replies=[],this.from_admin=e.from_admin,this.user_rank=e.user_rank,this}_initListeners(){this._listeners={};var t=CommentBS.EventTypes;for(let e=0;e<t.length;e++)this._listeners[t[e]]=[];return this}addListener(e,t,...s){if(!CommentBS.EventTypes.includes(e))throw new Error(e+" ne fait pas partit des events gérés par cette classe");void 0===this._listeners[e]&&(this._listeners[e]=[]);for(const i in this._listeners[e])if(i.toString()==t.toString())return void(Base.debug&&console.warn("Cette fonction est déjà présente pour event[%s]",e));return 0<s.length?this._listeners[e].push({fn:t,args:s}):this._listeners[e].push(t),Base.debug&&console.log("Base[%s] add Listener on event %s",this.constructor.name,e,this._listeners[e]),this}removeListener(t,s){if(void 0!==this._listeners[t])for(let e=0;e<this._listeners[t].length;e++)("function"==typeof this._listeners[t][e]&&this._listeners[t][e].toString()===s.toString()||this._listeners[t][e].fn.toString()==s.toString())&&this._listeners[t].splice(e,1);return this}_callListeners(t){if(void 0!==this._listeners[t]&&0<this._listeners[t].length){var s=new CustomEvent("betaseries",{detail:{name:t}});Base.debug&&console.log("Comment call %d Listeners on event %s",this._listeners[t].length,t);for(let e=0;e<this._listeners[t].length;e++)"function"==typeof this._listeners[t][e]?this._listeners[t][e].call(this,s,this):this._listeners[t][e].fn.apply(this,this._listeners[t][e].args)}return this}async fetchReplies(e=OrderComments.ASC){if(this.nbReplies<=0)return this;var t=await Base.callApi(HTTP_VERBS.GET,"comments","replies",{id:this.id,order:e});if(this.replies=[],t.comments)for(let e=0;e<t.comments.length;e++)this.replies.push(new CommentBS(t.comments[e],this));return this}edit(e){const t=this;this.text=e;e={edit_id:this.id,text:e};return Base.callApi(HTTP_VERBS.POST,"comments","comment",e).then(e=>t.fill(e.comment))}delete(){const e=this,t=[];if(0<this.nbReplies)for(let e=0;e<this.replies.length;e++)t.push(Base.callApi(HTTP_VERBS.DELETE,"comments","comment",{id:this.replies[e].id}));Promise.all(t).then(()=>{Base.callApi(HTTP_VERBS.DELETE,"comments","comment",{id:this.id}).then(()=>{e._parent instanceof CommentsBS?e._parent.removeComment(e.id):e._parent instanceof CommentBS&&e._parent.removeReply(e.id),e.getCollectionComments().nbComments=e.getCollectionComments().nbComments-(t.length+1)})})}isFirst(){return this._parent.isFirst(this.id)}isLast(){return this._parent.isLast(this.id)}static getTemplateComment(e){let t=new Option(e.text).innerHTML;/@\w+/.test(t)&&(t=t.replace(/@(\w+)/g,'<a href="/membre/$1" class="mainLink mainLink--regular">@$1</a>'));var s=/\[spoiler\]/.test(t)?`<button type="button" class="btn-reset mainLink view-spoiler">${Base.trans("comment.button.display_spoiler")}</button>`:"",i=(t=t.replace(/\[spoiler\](.*)\[\/spoiler\]/g,'<span class="spoiler" style="display:none">$1</span>'),0<e.in_reply_to),n=i?CommentBS.classNamesCSS.reply+" reply ":"",a=0<e.nbReplies?`
            <button type="button" class="btn-reset mainLink mainLink--regular toggleReplies" data-toggle="1">
                <span class="svgContainer">
                    <svg width="8" height="6" xmlns="http://www.w3.org/2000/svg" style="transition: transform 200ms ease 0s; transform: rotate(180deg);">
                        <path d="M4 5.667l4-4-.94-.94L4 3.78.94.727l-.94.94z" fill="#54709D" fill-rule="nonzero"></path>
                    </svg>
                </span>&nbsp;<span class="btnText">${Base.trans("comment.hide_answers")}</span>
            </button>`:"";let r=`
            <a href="/messages/nouveau?login=${e.login}" class="mainLink">Envoyer un message</a>
            <span class="mainLink">∙</span>
            <button type="button" class="btn-reset mainLink btnSignal">Signaler</button>
        `,o=(e.user_id===Base.userId&&(r=`
                <button type="button" class="btn-reset mainLink btnEditComment">Éditer</button>
                <span class="mainLink">∙</span>
                <button type="button" class="btn-reset mainLink btnDeleteComment">Supprimer</button>
            `),`<span class="mainLink">&nbsp;∙&nbsp;</span><button type="button" class="btn-reset mainLink mainLink--regular btnResponse" ${Base.userIdentified()?"":'style="display:none;"'}>${Base.trans("timeline.comment.reply")}</button>`);return i&&(o=""),`
            <div class="comment ${n}positionRelative ${CommentBS.classNamesCSS.comment}" data-comment-id="${e.id}" ${0<e.in_reply_to?'data-comment-reply="'+e.in_reply_to+'"':""} data-comment-inner="${e.inner_id}">
                <div class="media">
                    <div class="media-left">
                        <a href="/membre/${e.login}" class="avatar">
                            <img src="https://api.betaseries.com/pictures/members?key=${Base.userKey}&amp;id=${e.user_id}&amp;width=64&amp;height=64&amp;placeholder=png" width="32" height="32" alt="Profil de ${e.login}">
                        </a>
                    </div>
                    <div class="media-body">
                        <a href="/membre/${e.login}">
                            <span class="mainLink">${e.login}</span>
                        </a>
                        ${s}
                        <span class="comment-text">${t}</span>
                        <div class="${CommentBS.classNamesCSS.actions} actionsCmt">
                            <div class="options-main options-comment">
                                <button type="button" class="btn-reset btnUpVote btnThumb" title="+1 pour ce commentaire">
                                    <svg data-disabled="false" class="SvgLike" fill="#fff" width="16" height="14" viewBox="0 0 16 14" xmlns="http://www.w3.org/2000/svg">
                                        <g fill="${0<e.thumbed?"#FFAC3B":"inherit"}" fill-rule="nonzero">
                                            <path fill="#fff" fill-rule="evenodd" d="M.67 6h2.73v8h-2.73v-8zm14.909.67c0-.733-.614-1.333-1.364-1.333h-4.302l.648-3.047.02-.213c0-.273-.116-.527-.3-.707l-.723-.7-4.486 4.393c-.252.24-.402.573-.402.94v6.667c0 .733.614 1.333 1.364 1.333h6.136c.566 0 1.05-.333 1.255-.813l2.059-4.7c.061-.153.095-.313.095-.487v-1.273l-.007-.007.007-.053z"></path>
                                            <path class="SvgLikeStroke" stroke="#54709D" d="M1.17 6.5v7h1.73v-7h-1.73zm13.909.142c-.016-.442-.397-.805-.863-.805h-4.92l.128-.604.639-2.99.018-.166c0-.13-.055-.257-.148-.348l-.373-.361-4.144 4.058c-.158.151-.247.355-.247.578v6.667c0 .455.387.833.864.833h6.136c.355 0 .664-.204.797-.514l2.053-4.685c.04-.1.06-.198.06-.301v-1.063l-.034-.034.034-.265z"></path>
                                        </g>
                                    </svg>
                                </button>
                                <button type="button" class="btn-reset btnDownVote btnThumb" title="-1 pour ce commentaire">
                                    <svg data-disabled="false" class="SvgLike" fill="#fff" width="16" height="14" viewBox="0 0 16 14" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(180deg) scaleX(-1); margin-left: 4px; vertical-align: -4px;">
                                        <g fill="${e.thumbed<0?"#FFAC3B":"inherit"}" fill-rule="nonzero">
                                            <path fill="#fff" fill-rule="evenodd" d="M.67 6h2.73v8h-2.73v-8zm14.909.67c0-.733-.614-1.333-1.364-1.333h-4.302l.648-3.047.02-.213c0-.273-.116-.527-.3-.707l-.723-.7-4.486 4.393c-.252.24-.402.573-.402.94v6.667c0 .733.614 1.333 1.364 1.333h6.136c.566 0 1.05-.333 1.255-.813l2.059-4.7c.061-.153.095-.313.095-.487v-1.273l-.007-.007.007-.053z"></path>
                                            <path class="SvgLikeStroke" stroke="#54709D" d="M1.17 6.5v7h1.73v-7h-1.73zm13.909.142c-.016-.442-.397-.805-.863-.805h-4.92l.128-.604.639-2.99.018-.166c0-.13-.055-.257-.148-.348l-.373-.361-4.144 4.058c-.158.151-.247.355-.247.578v6.667c0 .455.387.833.864.833h6.136c.355 0 .664-.204.797-.514l2.053-4.685c.04-.1.06-.198.06-.301v-1.063l-.034-.034.034-.265z"></path>
                                        </g>
                                    </svg>
                                </button>
                                <strong class="mainLink thumbs${e.thumbs<0?" negative":0<e.thumbs?" positive":""}">${0<e.thumbs?"+"+e.thumbs:e.thumbs}</strong>
                                ${o}
                                <span class="mainLink">∙</span>
                                <span class="mainTime">Le ${e.date.format("dd/mm/yyyy HH:MM")}</span>
                                <span class="stars" title="${e.user_note} / 5">
                                    ${Note.renderStars(e.user_note,e.user_id===Base.userId?"blue":"")}
                                </span>
                                <div class="it_iv">
                                    <button type="button" class="btn-reset btnToggleOptions">
                                        <span class="svgContainer">
                                            <svg width="4" height="16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="transform: rotate(90deg);">
                                                <defs>
                                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" id="svgthreedots"></path>
                                                </defs>
                                                <use fill="${"dark"===Base.theme?"rgba(255, 255, 255, .5)":"#333"}" fill-rule="nonzero" xlink:href="#svgthreedots" transform="translate(-10 -4)"></use>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            <div class="options-options options-comment" style="display:none;">
                                ${r}
                                <button type="button" class="btn-reset btnToggleOptions">
                                    <span class="svgContainer">
                                        <svg fill="${"dark"===Base.theme?"rgba(255, 255, 255, .5)":"#333"}" width="9" height="9" viewBox="0 0 14 14" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M14 1.41l-1.41-1.41-5.59 5.59-5.59-5.59-1.41 1.41 5.59 5.59-5.59 5.59 1.41 1.41 5.59-5.59 5.59 5.59 1.41-1.41-5.59-5.59z"></path>
                                        </svg>
                                    </span>
                                </button>
                            </div>
                        </div>
                        ${a}
                    </div>
                </div>
            </div>
        `}static getTemplateWriting(e){var t=Base.userIdentified()?currentLogin:"";let s="",i=Base.trans("timeline.comment.write");return e&&(s=` data-reply-to="${e.id}"`,i="Ecrivez une réponse à ce commentaire"),`
            <div class="writing">
                <div class="media">
                    <div class="media-left">
                        <div class="avatar">
                            <img src="https://api.betaseries.com/pictures/members?key=${Base.userKey}&amp;id=${Base.userId}&amp;width=32&amp;height=32&amp;placeholder=png" width="32" height="32" alt="Profil de ${t}">
                        </div>
                    </div>
                    <div class="media-body">
                        <form class="gz_g1">
                            <textarea rows="2" placeholder="${i}" class="form-control"${s}></textarea>
                            <button class="btn-reset sendComment" disabled="" aria-label="${Base.trans("comment.send.label")}" title="${Base.trans("comment.send.label")}">
                                <span class="svgContainer" style="width: 16px; height: 16px;">
                                    <svg fill="${"dark"===Base.theme?"#fff":"#333"}" width="15" height="12" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M.34 12l13.993-6L.34 0 .333 4.667l10 1.333-10 1.333z"></path>
                                    </svg>
                                </span>
                            </button>
                        </form>
                        <p class="mainTime">Utilisez la balise <span class="baliseSpoiler" title="Ajouter la balise spoiler à votre commentaire">[spoiler]…[/spoiler]</span> pour masquer le contenu pouvant spoiler les lecteurs.</p>
                    </div>
                </div>
            </div>
        `}static getTemplateReport(e){return`
            <form class="form-middle" method="POST" action="/apps/report.php">
                <fieldset>
                    <div class="title" id="dialog-title" tabindex="0">Signaler un commentaire</div>
                    <p>Vous êtes sur le point de signaler un commentaire, veuillez indiquer ci-dessous la raison de ce signalement.</p>
                    <div>
                        <textarea class="form-control" name="texte"></textarea>
                    </div>
                    <div class="button-set">
                        <button class="js-close-popupalert btn-reset btn-btn btn-blue2" type="submit" id="popupalertyes">Signaler le contenu</button>
                    </div>
                </fieldset>
                <input type="hidden" name="id" value="${e.id}">
                <input type="hidden" name="type" value="comment">
            </form>`}getLogins(){const t=[];t.push(this.login);for(let e=0;e<this.replies.length;e++)t.includes(this.replies[e].login)||t.push(this.replies[e].login);return t}updateRenderThumbs(e=0){const t=jQuery(`.comments .comment[data-comment-id="${this.id}"] .thumbs`);var s=parseInt(t.text(),10);const i=e==this.thumbed?s+e:s-e;s=0<i?"+"+i:i.toString();if(t.text(s),0==this.thumbed)t.siblings(".btnThumb").find("g").attr("fill","inherited");else{const n=0<this.thumbed?t.siblings(".btnThumb.btnUpVote"):t.siblings(".btnThumb.btnDownVote");n.find("g").attr("fill","#FFAC3B")}}async isReply(t){if(this.replies.length<=0&&this.nbReplies<=0)return!1;this.replies.length<=0&&await this.fetchReplies();for(let e=0;e<this.replies.length;e++)if(this.replies[e].id==t)return!0;return!1}async getReply(t){if(this.replies.length<=0&&this.nbReplies<=0)return null;this.replies.length<=0&&await this.fetchReplies();for(let e=0;e<this.replies.length;e++)if(this.replies[e].id==t)return this.replies[e];return null}removeReply(t){for(let e=0;e<this.replies.length;e++)if(this.replies[e].id==t)return this.replies.splice(e,1),!0;return!1}getCollectionComments(){return this._parent instanceof CommentsBS?this._parent:this._parent instanceof CommentBS?this._parent._parent:null}loadEvents(r,o){this._events=[];async function i(e){return(e=parseInt(e.data("commentId"),10))===l.id?l:l.isReply(e)?l.getReply(e):l.getCollectionComments().getComment(e)}const l=this,s=jQuery("#popin-dialog"),a=jQuery("#popin-showClose"),e=r.find(".title"),t=(a.click(()=>{o.hidePopup(),s.removeAttr("data-popin-type")}),this._events.push({elt:a,event:"click"}),r.find(".btnSignal")),n=(t.click(async e=>{e.stopPropagation(),e.preventDefault();e=$(e.currentTarget).parents(".comment"),e=await i(e);const s=r.parents(".popin-content").find(".popin-content-html");s.empty().append(CommentBS.getTemplateReport(e)),s.find("button.js-close-popupalert.btn-blue2").click(e=>{e.stopPropagation(),e.preventDefault();const t=s.find("form");e={method:"POST",cache:"no-cache",body:new URLSearchParams(t.serialize())};fetch("/apps/report.php",e).then(()=>{s.hide(),r.show()}).catch(()=>{s.hide(),r.show()})}),r.hide(),s.show()}),this._events.push({elt:t,event:"click"}),r.find(".btnSubscribe"));function d(e){var t=l.getCollectionComments();t.is_subscribed?t.is_subscribed&&(e.addClass("active"),e.attr("title","Ne plus recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg width="20" height="22" viewBox="0 0 20 22" style="width: 17px;">
                        <g transform="translate(-4)" fill="none">
                            <path d="M0 0h24v24h-24z"></path>
                            <path fill="${"dark"==Base.theme?"rgba(255, 255, 255, .5)":"#333"}" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32v-.68c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68c-2.87.68-4.5 3.24-4.5 6.32v5l-2 2v1h16v-1l-2-2z"></path>
                        </g>
                    </svg>
                `)):(e.removeClass("active"),e.attr("title","Recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg fill="${"dark"==Base.theme?"rgba(255, 255, 255, .5)":"#333"}" width="14" height="16" style="position: relative; top: 1px; left: -1px;">
                        <path fill-rule="nonzero" d="M13.176 13.284L3.162 2.987 1.046.812 0 1.854l2.306 2.298v.008c-.428.812-.659 1.772-.659 2.806v4.103L0 12.709v.821h11.307l1.647 1.641L14 14.13l-.824-.845zM6.588 16c.914 0 1.647-.73 1.647-1.641H4.941c0 .91.733 1.641 1.647 1.641zm4.941-6.006v-3.02c0-2.527-1.35-4.627-3.705-5.185V1.23C7.824.55 7.272 0 6.588 0c-.683 0-1.235.55-1.235 1.23v.559c-.124.024-.239.065-.346.098a2.994 2.994 0 0 0-.247.09h-.008c-.008 0-.008 0-.017.009-.19.073-.379.164-.56.254 0 0-.008 0-.008.008l7.362 7.746z"></path>
                    </svg>
                `))}n.click(e=>{if(e.stopPropagation(),e.preventDefault(),Base.userIdentified()){const t=$(e.currentTarget);e={type:l.getCollectionComments().media.mediaType.singular,id:l.getCollectionComments().media.id};t.hasClass("active")?Base.callApi(HTTP_VERBS.DELETE,"comments","subscription",e).then(()=>{l.getCollectionComments().is_subscribed=!1,d(t)}):Base.callApi(HTTP_VERBS.POST,"comments","subscription",e).then(()=>{l.getCollectionComments().is_subscribed=!0,d(t)})}else faceboxDisplay("inscription",{},()=>{})}),d(n),this._events.push({elt:n,event:"click"});const c=e.find(".prev-comment"),h=(this.isFirst()?c.css("color","grey").css("cursor","initial"):(c.click(e=>{e.stopPropagation(),e.preventDefault(),l.cleanEvents(),l.getCollectionComments().getPrevComment(l.id).render()}),this._events.push({elt:c,event:"click"})),e.find(".next-comment")),p=(this.isLast()?h.css("color","grey").css("cursor","initial"):(h.click(e=>{e.stopPropagation(),e.preventDefault(),l.cleanEvents(),l.getCollectionComments().getNextComment(l.id).render()}),this._events.push({elt:h,event:"click"})),r.find(".view-spoiler")),u=(0<p.length&&(p.click(e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget),s=t.next(".comment-text").find(".spoiler");s.is(":visible")?(s.fadeOut("fast"),t.text("Voir le spoiler")):(s.fadeIn("fast"),t.text("Cacher le spoiler"))}),this._events.push({elt:p,event:"click"})),r.find(".comments .comment .btnThumb")),m=(u.click(s=>{if(s.stopPropagation(),s.preventDefault(),Base.userIdentified()){const i=jQuery(s.currentTarget),n=parseInt(i.parents(".comment").data("commentId"),10);let e=HTTP_VERBS.POST;const a=i.hasClass("btnUpVote")?1:-1;let t={id:n,type:a,switch:!1};if(l.thumbed==a)e=HTTP_VERBS.DELETE,t={id:n};else if(0!=l.thumbed)return void console.warn("Le vote est impossible. Annuler votre vote et recommencer");Base.callApi(e,"comments","thumb",t).then(async e=>{if(n==l.id)l.thumbs=parseInt(e.comment.thumbs,10),l.thumbed=e.comment.thumbed?parseInt(e.comment.thumbed,10):0,l.updateRenderThumbs(a);else if(await l.isReply(n)){const s=await l.getReply(n);s.thumbs=parseInt(e.comment.thumbs,10),s.thumbed=e.comment.thumbed?parseInt(e.comment.thumbed,10):0,s.updateRenderThumbs(a)}else{var t=e.comment.thumbed?parseInt(e.comment.thumbed,10):0;l.getCollectionComments().changeThumbs(n,e.comment.thumbs,t)}i.siblings("strong.thumbs").css("animation","1s ease 0s 1 normal forwards running backgroundFadeOut")}).catch(e=>{e=void 0!==e.text?e.text:e;Base.notification("Vote commentaire","Une erreur est apparue durant le vote: "+e)})}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:u,event:"click"}),r.find(".btnToggleOptions")),g=(m.click(e=>{e.stopPropagation(),e.preventDefault(),jQuery(e.currentTarget).parents("."+CommentBS.classNamesCSS.actions).first().find(".options-comment").each((e,t)=>{const s=jQuery(t);s.is(":visible")?s.hide():s.show()})}),this._events.push({elt:m,event:"click"}),r.find(".sendComment")),f=(g.click(async s=>{if(s.stopPropagation(),s.preventDefault(),Base.userIdentified()){const i=$(s.currentTarget).siblings("textarea");if(0<i.val().length){var e=parseInt(i.data("replyTo"),10),t=i.data("action");const n=i.val();if(e&&e==l.id)l.sendReply(n).then(e=>{e&&(e=CommentBS.getTemplateComment(e),r.find(".comments").append(e),i.removeAttr("data-reply-to"),l.cleanEvents(()=>{l.loadEvents(r,o)}))});else if(e){const a=await l.getReply(e);a&&a.sendReply(n).then(e=>{e&&(e=CommentBS.getTemplateComment(e),r.find(`.comments .comment[data-comment-id="${a.id}"]`).after(e),i.removeAttr("data-reply-to"),l.cleanEvents(()=>{l.loadEvents(r,o)}))})}else"edit"===t?l.edit(n).then(()=>{const e=parseInt(i.data("commentId"),10);let t=$(s.currentTarget).parents(".writing").siblings(".comments").children(`.comment[data-comment-id="${e.toString()}"]`);t.find(".comment-text").text(l.text),(t=jQuery(`#comments .slide_flex .slide__comment[data-comment-id="${e}"]`)).find("p").text(n),i.removeAttr("data-action").removeAttr("data-comment-id")}):CommentsBS.sendComment(l.getCollectionComments().media,n).then(e=>{l.getCollectionComments().addToPage(e.id),l.cleanEvents(()=>{l.loadEvents(r,o)})});i.val(""),i.siblings("button").attr("disabled","true")}}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:g,event:"click"}),r.find("textarea")),v=(f.keypress(e=>{const t=$(e.currentTarget);0<t.val().length?t.siblings("button").removeAttr("disabled"):t.siblings("button").attr("disabled","true")}),this._events.push({elt:f,event:"keypress"}),r.find(".baliseSpoiler")),b=(v.click(()=>{const e=s.find("textarea");var t;/\[spoiler\]/.test(e.val())||(t="[spoiler]"+e.val()+"[/spoiler]",e.val(t))}),this._events.push({elt:v,event:"click"}),r.find(".comments .toggleReplies")),_=(b.click(e=>{e.stopPropagation(),e.preventDefault();const t=$(e.currentTarget);e=t.data("toggle");const s=t.parents(".comment");var i=s.data("commentInner");const n=s.parents(".comments").find(`.comment[data-comment-reply="${i}"]`);"0"==e?(n.nextAll(".sub").fadeIn("fast"),n.fadeIn("fast"),t.find(".btnText").text(Base.trans("comment.hide_answers")),t.find("svg").attr("style","transition: transform 200ms ease 0s; transform: rotate(180deg);"),t.data("toggle","1")):(n.nextAll(".sub").fadeOut("fast"),n.fadeOut("fast"),t.find(".btnText").text(Base.trans("comment.button.reply",{"%count%":n.length.toString()},n.length)),t.find("svg").attr("style","transition: transform 200ms ease 0s;"),t.data("toggle","0"))}),this._events.push({elt:b,event:"click"}),r.find(".btnResponse")),y=(_.click(async e=>{if(e.stopPropagation(),e.preventDefault(),Base.userIdentified()){const t=$(e.currentTarget);e=t.parents(".comment"),e=await i(e);r.find("textarea").val("@"+e.login).attr("data-reply-to",e.id)}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:_,event:"click"}),r.find(".btnEditComment")),w=(y.click(e=>{e.stopPropagation(),e.preventDefault();const t=$(e.currentTarget).parents(".comment");e=parseInt(t.data("commentId"),10);f.val(l.text),f.attr("data-action","edit"),f.attr("data-comment-id",e)}),this._events.push({elt:y,event:"click"}),r.find(".btnDeleteComment"));w.click(e=>{e.stopPropagation(),e.preventDefault();const t=$(e.currentTarget).parents(".comment"),s=$(e.currentTarget).parents(".options-options");s.hide().after(`
                <div class="options-delete">
                    <span class="mainTime">Supprimer mon commentaire :</span>
                    <button type="button" class="btn-reset fontWeight700 btnYes" style="vertical-align: 0px; padding-left: 10px; padding-right: 10px; color: rgb(208, 2, 27);">Oui</button>
                    <button type="button" class="btn-reset mainLink btnNo" style="vertical-align: 0px;">Non</button>
                </div>
            `);const i=t.find(".options-delete .btnYes"),n=t.find(".options-delete .btnNo");i.click(e=>{e.stopPropagation(),e.preventDefault(),l.delete(),a.trigger("click")}),n.click(e=>{e.stopPropagation(),e.preventDefault(),t.find(".options-delete").remove(),s.show(),i.off("click"),n.off("click")})}),this._events.push({elt:w,event:"click"})}cleanEvents(e=Base.noop){if(this._events&&0<this._events.length){let t;for(let e=0;e<this._events.length;e++)(t=this._events[e]).elt.off(t.event)}e()}async render(){const t=this,e=jQuery("#popin-dialog"),s=e.find(".popin-content-html"),i=e.find(".popin-content-reactmodule"),n=e.find("#popin-showClose"),a=()=>{document.body.style.overflow="visible",document.body.style.paddingRight="",e.attr("aria-hidden","true"),e.find("#popupalertyes").show(),e.find("#popupalertno").show(),i.empty(),s.hide(),t.cleanEvents(),t._callListeners(EventTypes.HIDE)},r=()=>{document.body.style.overflow="hidden",document.body.style.paddingRight=getScrollbarWidth()+"px",e.find("#popupalertyes").hide(),e.find("#popupalertno").hide(),s.hide(),i.show(),n.show(),e.attr("aria-hidden","false")};i.empty().append(`<div class="title" id="dialog-title" tabindex="0">${Base.trans("blog.title.comments")}</div>`);let o=i.find(".title"),l=`
            <div class="loaderCmt">
                <svg class="sr-only">
                    <defs>
                        <clipPath id="placeholder">
                            <path d="M50 25h160v8H50v-8zm0-18h420v8H50V7zM20 40C8.954 40 0 31.046 0 20S8.954 0 20 0s20 8.954 20 20-8.954 20-20 20z"></path>
                        </clipPath>
                    </defs>
                </svg>
        `;for(let e=0;e<4;e++)l+=`
                <div class="er_ex null">
                    <div class="ComponentPlaceholder er_et" style="height: 40px;"></div>
                </div>`;i.append(l+"</div>"),r();let d=`
            <div data-media-type="${t.getCollectionComments().media.mediaType.singular}"
                            data-media-id="${t.getCollectionComments().media.id}"
                            class="displayFlex flexDirectionColumn"
                            style="margin-top: 2px; min-height: 0">`;Base.userIdentified()&&(d+=`<button type="button" class="btn-reset btnSubscribe" style="position: absolute; top: 3px; right: 31px; padding: 8px;">
                <span class="svgContainer">
                    <svg></svg>
                </span>
            </button>`),d+='<div class="comments overflowYScroll">'+CommentBS.getTemplateComment(this),0<this.nbReplies&&this.replies.length<=0&&await this.fetchReplies();for(let e=0;e<this.replies.length;e++)d+=CommentBS.getTemplateComment(this.replies[e]);d+="</div>",this.getCollectionComments().isOpen()&&Base.userIdentified()&&(d+=CommentBS.getTemplateWriting(t)),d+="</div>",e.attr("data-popin-type","comments"),i.fadeOut("fast",()=>{i.find(".loaderCmt").remove(),i.empty().append('<div class="title" id="dialog-title" tabindex="0"></div>'),o=i.find(".title");let e="";t._parent.isFirst(t.id)||(e+=' <i class="fa fa-chevron-circle-left prev-comment" aria-hidden="true" title="Commentaire précédent"></i>'),t._parent.isLast(t.id)||(e+='  <i class="fa fa-chevron-circle-right next-comment" aria-hidden="true" title="Commentaire suivant"></i>'),o.append(Base.trans("blog.title.comments")+e),i.append(d),i.fadeIn(),t.loadEvents(i,{hidePopup:a,showPopup:r}),t._callListeners(EventTypes.SHOW)})}sendReply(e){const s=this;e={type:this.getCollectionComments().media.mediaType.singular,id:this.getCollectionComments().media.id,in_reply_to:this.inner_id,text:e};return Base.callApi(HTTP_VERBS.POST,"comments","comment",e).then(e=>{e=new CommentBS(e.comment,s);const t=s.getCollectionComments().order===OrderComments.DESC?Array.prototype.unshift:Array.prototype.push;return t.call(s.replies,e),s.nbReplies++,s.getCollectionComments().nbComments++,s.getCollectionComments().is_subscribed=!0,e}).catch(e=>{Base.notification("Commentaire","Erreur durant l'ajout d'un commentaire"),console.error(e)})}}!function(e){e.EMPTY="empty",e.HALF="half",e.FULL="full",e.DISABLE="disable"}(StarTypes=StarTypes||{});class Note{total;mean;user;_parent;constructor(e,t){this.total=parseInt(e.total,10),this.mean=parseFloat(e.mean),this.user=parseInt(e.user,10),this._parent=t}getPercentage(){return 10*Math.round(this.mean/5*100/10)}toString(){var e="vote"+(1<this.total?"s":"");let t=new Intl.NumberFormat("fr-FR",{style:"decimal",useGrouping:!0}).format(this.total)+` ${e} : ${this.mean.toFixed(2)} / 5`;return Base.userIdentified()&&0<this.user&&(t+=", votre note: "+this.user),t}createPopupForVote(i=Base.noop){Base.debug&&console.log("objNote createPopupForVote");const n=this,e=jQuery("#popin-dialog"),t=e.find(".popin-content-html"),s=e.find(".popin-content-reactmodule"),a=e.find(".js-close-popupalert"),r=()=>{Base.debug&&console.log("objNote createPopupForVote hidePopup"),e.attr("aria-hidden","true"),t.find(".button-set").show(),t.hide(),o.find(".star-svg").off("mouseenter").off("mouseleave").off("click")};let o=e.find("p"),l=t.find(".title"),d=(r(),'<div style="display: flex; justify-content: center; margin-bottom: 15px;"><div role="button" tabindex="0" class="stars btn-reset">'),c;for(let e=1;e<=5;e++)c=this.user<=e-1?StarTypes.EMPTY:StarTypes.FULL,d+=`
                <svg viewBox="0 0 100 100" class="star-svg" data-number="${e}" style="width: 30px; height: 30px;">
                    <use xlink:href="#icon-starblue-${c}"></use>
                </svg>`;o.length<=0&&(t.replaceWith(`
                <div class="popin-content-html">
                    <div class="title" id="dialog-title" tabindex="0"></div>
                    <div class="popin-content-ajax">
                        <p></p>
                    </div>
                </div>`),o=t.find("p"),l=t.find(".title")),o.empty().append(d+"</div></div>");let h="Noter ";switch(this._parent.mediaType.singular){case MediaType.show:h+="la série";break;case MediaType.movie:h+="le film";break;case MediaType.episode:h+="l'épisode"}l.empty().text(h),a.click(()=>{r(),e.removeAttr("data-popin-type")});function p(e,t){const s=jQuery(e.currentTarget).parent().find(".star-svg use");var i;for(let e=0;e<5;e++)i=e<=t-1?StarTypes.FULL:StarTypes.EMPTY,$(s.get(e)).attr("xlink:href","#icon-starblue-"+i)}const u=o.find(".star-svg");u.mouseenter(e=>{var t=parseInt($(e.currentTarget).data("number"),10);p(e,t)}),u.mouseleave(e=>{p(e,n.user)}),u.click(e=>{const t=parseInt(jQuery(e.currentTarget).data("number"),10),s=jQuery(e.currentTarget).parent().find(".star-svg");s.off("mouseenter").off("mouseleave"),n._parent.addVote(t).then(e=>{r(),e?(n._parent.changeTitleNote(!0),n._parent._callListeners(EventTypes.NOTE),i&&i.call(n)):Base.notification("Erreur Vote","Une erreur s'est produite durant le vote")}).catch(()=>r())}),Base.debug&&console.log("objNote createPopupForVote showPopup"),t.find(".button-set").hide(),t.show(),s.hide(),a.show(),e.attr("aria-hidden","false")}static getTypeSvg(e,t){let s=StarTypes.EMPTY;return e<=t?s=StarTypes.EMPTY:e<t+1?t+.25<e?s=StarTypes.HALF:t+.75<e&&(s=StarTypes.FULL):s=StarTypes.FULL,s}updateStars(e=null){let t="";const s=(e=e||jQuery(".blockInformations__metadatas .js-render-stars")).find(".star-svg use");var i,e=$(s.get(0)).attr("xlink:href").match(/(grey|blue)/);e&&(t=e[0]);for(let e=0;e<5;e++)i=Note.getTypeSvg(this.mean,e),$(s.get(e)).attr("xlink:href",`#icon-star${t}-`+i)}static renderStars(t=0,s=""){let i,n="";0==t&&(s="grey");for(let e=0;e<5;e++)i=Note.getTypeSvg(t,e),n+=`
                <svg viewBox="0 0 100 100" class="star-svg">
                    <use xmlns:xlink="http://www.w3.org/1999/xlink"
                        xlink:href="#icon-star${s}-${i}">
                    </use>
                </svg>
            `;return n}}class Next{id;code;date;title;image;constructor(e){this.id=void 0!==e.id?parseInt(e.id,10):NaN,this.code=e.code,this.date=new Date(e.date)||null,this.title=e.title,this.image=e.image}}class User{archived;downloaded;favorited;friends_want_to_watch;friends_watched;hidden;last;mail;next;profile;remaining;seen;status;tags;twitter;constructor(e){this.archived=void 0!==e.archived&&!!e.archived,this.downloaded=void 0!==e.downloaded&&!!e.downloaded,this.favorited=void 0!==e.favorited&&!!e.favorited,this.friends_want_to_watch=e.friends_want_to_watch||[],this.friends_watched=e.friends_watched||[],this.hidden=void 0!==e.hidden&&!!e.hidden,this.last=e.last||"",this.mail=void 0!==e.mail&&!!e.mail,this.next=null,void 0!==e.next&&(this.next=new Next(e.next)),this.profile=e.profile||"",this.remaining=e.remaining||0,this.seen=!!e.seen||!1,this.status=void 0!==e.status?parseInt(e.status,10):0,this.tags=e.tags||"",this.twitter=!!e.twitter||!1}}function ExceptionIdentification(e){this.message=e,this.name="ExceptionIdentification"}!function(e){e.show="show",e.movie="movie",e.episode="episode"}(MediaType=MediaType||{}),function(e){e.UPDATE="update",e.SAVE="save",e.ADD="add",e.ADDED="added",e.REMOVE="remove",e.NOTE="note",e.ARCHIVE="archive",e.UNARCHIVE="unarchive",e.SHOW="show",e.HIDE="hide"}(EventTypes=EventTypes||{}),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS"}(HTTP_VERBS=HTTP_VERBS||{});class Base{static debug=!1;static cache=null;static api={url:"https://api.betaseries.com",versions:{current:"3.0",last:"3.0"},resources:["badges","comments","episodes","friends","members","messages","movies","news","oauth","persons","pictures","planning","platforms","polls","reports","search","seasons","shows","subtitles","timeline"],check:{episodes:["display","list","search","watched"],members:["notifications"],movies:["list","movie","search","similars"],search:["all","movies","shows"],shows:["display","episodes","list","member","search","similars"]},notDisplay:["membersnotifications"],tokenRequired:{comments:{close:["POST"],comment:["POST","DELETE"],comment_event:["POST"],open:["POST"],subscription:["POST","DELETE"],thumb:["POST","DELETE"]},episodes:{downloaded:["POST","DELETE"],hidden:["POST","DELETE"],latest:["GET"],list:["GET"],next:["GET"],note:["POST","DELETE"],scraper:["GET"],search:["GET"],unrated:["GET"],watched:["POST","DELETE"]},members:{avatar:["POST","DELETE"],banner:["POST","DELETE"],delete:["POST"],destroy:["POST"],email:["GET","POST"],facebook:["POST"],is_active:["GET"],lametric:["GET"],locale:["GET"],notification:["DELETE"],notifications:["GET"],option:["POST"],options:["GET"],password:["POST"],sync:["POST"],twitter:["POST","DELETE"]},movies:{favorite:["POST","DELETE"],movie:["POST","DELETE"],note:["POST","DELETE"],scraper:["GET"]},platforms:{service:["POST","DELETE"]},shows:{archive:["POST","DELETE"],favorite:["POST","DELETE"],note:["POST","DELETE"],recommendation:["POST","DELETE","PUT"],recommendations:["GET"],show:["POST","DELETE"],tags:["POST"],unrated:["GET"]},subtitles:{report:["POST"]}}};static token=null;static userKey=null;static userId=null;static themoviedb_api_user_key=null;static counter=0;static serverBaseUrl="";static serverOauthUrl="";static theme="light";static notification=(e,t)=>{};static userIdentified=()=>!1;static noop=()=>{};static trans=(e,t,s=0)=>e;static ratings=null;static gm_funcs={getValue:(e,t)=>t,setValue:(e,t)=>{}};static EventTypes=[EventTypes.UPDATE,EventTypes.SAVE,EventTypes.NOTE];static showLoader(){jQuery("#loader-bg").show()}static hideLoader(){jQuery("#loader-bg").hide()}static authenticate(){return Base.debug&&console.log("authenticate"),jQuery("#containerIframe").length<=0&&jQuery("body").append(`
                <div id="containerIframe">
                <iframe id="userscript"
                        name="userscript"
                        title="Connexion à BetaSeries"
                        width="50%"
                        height="400"
                        src="${Base.serverOauthUrl}/index.html"
                        style="background:white;margin:auto;">
                </iframe>
                </div>'
            `),new Promise((i,n)=>{window.addEventListener("message",function e(t){var s=new URL(Base.serverOauthUrl).origin;if(t.origin!==s)return Base.debug&&console.error("receiveMessage {origin: %s}",t.origin,t),void n("event.origin is not "+s);"access_token"===t.data.message?(Base.token=t.data.value,$("#containerIframe").remove(),i(t.data.message)):(console.error("Erreur de récuperation du token",t),n(t.data),Base.notification("Erreur de récupération du token","Pas de message")),window.removeEventListener("message",e,!1)},!1)})}static callApi(o,l,d,c,h=!1){if(Base.api&&-1===Base.api.resources.indexOf(l))throw new Error(`Ressource (${l}) inconnue dans l'API.`);if(!Base.userKey)throw Base.notification("Call API","La clé API doit être renseignée"),new Error("userKey are required");if(!Base.token&&l in Base.api.tokenRequired&&d in Base.api.tokenRequired[l]&&1!==Base.api.tokenRequired[l][d].indexOf(o))throw Base.notification("Call API",`Identification requise pour cet appel: ${o} ${l}/`+d),new ExceptionIdentification("Identification required");Base.showLoader();let i=!1,p=!0;0<=Base.api.notDisplay.indexOf(l+d)&&(p=!1);const u={Accept:"application/json","X-BetaSeries-Version":Base.api.versions.current,"X-BetaSeries-Token":Base.token,"X-BetaSeries-Key":Base.userKey},e=Object.keys(Base.api.check);return Base.debug&&p&&console.log("Base.callApi",{type:o,resource:l,action:d,args:c,force:h}),Base.cache&&!h&&"GET"===o&&c&&"id"in c&&Base.cache.has(l,c.id)?new Promise(e=>{e(Base.cache.get(l,c.id)),Base.hideLoader()}):(Base.userIdentified()&&-1!==e.indexOf(l)&&-1!==Base.api.check[l].indexOf(d)&&(i=!0),new Promise((t,s)=>{var e;i?(e={method:"GET",headers:u,mode:"cors",cache:"no-cache"},Base.debug&&p&&console.info("%ccall /members/is_active","color:#1d6fb2"),fetch(Base.api.url+"/members/is_active",e).then(e=>{Base.counter++,e.ok?n(t,s):Base.authenticate().then(()=>{u["X-BetaSeries-Token"]=Base.token,n(t,s)}).catch(e=>s(e))}).catch(e=>{Base.debug&&console.log("Il y a eu un problème avec l'opération fetch: "+e.message),console.error(e),s(e.message)})):n(t,s)}));function n(n,a){const e={method:o,headers:u,mode:"cors",cache:"no-cache"};let r=Base.api.url+`/${l}/`+d;var t=Object.keys(c);if("GET"===o&&0<t.length){const s=[];for(const i of t)s.push(i+"="+encodeURIComponent(c[i]));r+="?"+s.join("&")}else 0<t.length&&(e.body=new URLSearchParams(c));fetch(r,e).then(i=>{Base.counter++,Base.debug&&(p||200!==i.status)&&console.log("fetch (%s %s) response status: %d",o,r,i.status),i.json().then(e=>{var t,s;return Base.debug&&(p||200!==i.status)&&console.log("fetch (%s %s) data",o,r,e),void 0!==e.errors&&0<e.errors.length?(t=e.errors[0].code,s=e.errors[0].text,2005===t||400===i.status&&0===t&&"L'utilisateur a déjà marqué cet épisode comme vu."===s?a("changeStatus"):2001==t?Base.authenticate().then(()=>{Base.callApi(o,l,d,c,h).then(e=>n(e),e=>a(e))},e=>{a(e)}):a(e.errors[0])):i.ok?n(e):(console.error("Fetch erreur network",i),a(i)),void Base.hideLoader()})}).catch(e=>{Base.debug&&console.log("Il y a eu un problème avec l'opération fetch: "+e.message),console.error(e),a(e.message),Base.hideLoader()})}}static setPropValue(e,t,s){if(0<=t.indexOf(".")){const a=t.split("."),r=a.shift();t=a.join("."),/\[\d+\]$/.test(r)?(i=r.replace(/\[\d+\]$/,""),n=parseInt(r.replace(/[^\d]*/,""),10),Base.setPropValue(e[i][n],t,s)):/\[.*\]$/.test(r)?(i=r.replace(/\[.+\]$/,""),n=r.replace(/^.*\[/,"").replace(/\]$/,""),Base.setPropValue(e[i][n],t,s)):Base.setPropValue(e[r],t,s)}else{var i,n;/\[.*\]$/.test(t)?(i=t.replace(/\[.+\]$/,""),n=t.replace(/^.*\[/,"").replace(/\]$/,""),e[i][n]=s):e[t]=s}}static replaceParams(s,i,n){var a=Object.keys(i);for(let t=0;t<a.length;t++){var r=a[t],o=i[r];if(void 0===n[r])throw new Error(`Parameter[${r}] missing`);let e=n[r];"number"==o?e=parseInt(e,10):"string"==o&&(e=String(e));o=new RegExp(`#${r}#`,"g");s=s.replace(o,e)}return s}description;characters;comments;nbComments;id;objNote;resource_url;title;user;mediaType;_elt;_listeners;constructor(e){if(e instanceof Object)return this._initListeners(),this;throw new Error("data is not an object")}fill(t){if(this.id=parseInt(t.id,10),this.characters=[],t.characters&&t.characters instanceof Array)for(let e=0;e<t.characters.length;e++)this.characters.push(new Character(t.characters[e]));return this.nbComments=t.comments?parseInt(t.comments,10):0,this.comments instanceof CommentsBS||(this.comments=new CommentsBS(this.nbComments,this)),this.objNote=t.note?new Note(t.note,this):t.notes?new Note(t.notes,this):null,this.resource_url=t.resource_url,this.title=t.title,this.user=void 0!==t.user?new User(t.user):null,this.description=t.description,this}_initListeners(){this._listeners={};var t=this.constructor.EventTypes;for(let e=0;e<t.length;e++)this._listeners[t[e]]=[];return this}addListener(e,t,...s){if(this.constructor.EventTypes.indexOf(e)<0)throw new Error(e+" ne fait pas partit des events gérés par cette classe");void 0===this._listeners[e]&&(this._listeners[e]=[]);for(const i in this._listeners[e])if(i.toString()==t.toString())return;return 0<s.length?this._listeners[e].push({fn:t,args:s}):this._listeners[e].push(t),Base.debug&&console.log("Base[%s] add Listener on event %s",this.constructor.name,e,this._listeners[e]),this}removeListener(t,s){if(void 0!==this._listeners[t])for(let e=0;e<this._listeners[t].length;e++)("function"==typeof this._listeners[t][e]&&this._listeners[t][e].toString()===s.toString()||this._listeners[t][e].fn.toString()==s.toString())&&this._listeners[t].splice(e,1);return this}_callListeners(t){if(0<=this.constructor.EventTypes.indexOf(t)&&0<this._listeners[t].length){Base.debug&&console.log("Base[%s] call %d Listeners on event %s",this.constructor.name,this._listeners[t].length,t,this._listeners);var s=new CustomEvent("betaseries",{detail:{name:t}});for(let e=0;e<this._listeners[t].length;e++)"function"==typeof this._listeners[t][e]?this._listeners[t][e].call(this,s,this):this._listeners[t][e].fn.apply(this,this._listeners[t][e].args)}return this}init(){return new Promise(e=>e(this))}save(){return Base.cache instanceof CacheUS&&(Base.cache.set(this.mediaType.plural,this.id,this),this._callListeners(EventTypes.SAVE)),this}get elt(){return this._elt}set elt(e){this._elt=e}get nbCharacters(){return this.characters.length}decodeTitle(){const e=this.elt.find(".blockInformations__title"),t=e.text();return/&#/.test(t)&&e.text($("<textarea />").html(t).text()),this}changeTitleNote(e=!0){const t=this.elt.find(".js-render-stars");var s;{if(!(this.objNote.mean<=0||this.objNote.total<=0))return s=this.objNote.toString(),e&&t.attr("title",s),s;e&&t.attr("title","Aucun vote")}}addNumberVoters(){const i=this,n=$(".stars.js-render-stars");let a=this.changeTitleNote(!0);return new MutationObserver(e=>{var t;let s;for(s of e)/vote/.test(s.target.nodeValue)||s.target.nodeValue==a||(t=void 0,(t=i.changeTitleNote(!1))!==a&&(n.attr("title",t),a=t))}).observe(n.get(0),{attributes:!0,childList:!1,characterData:!1,subtree:!1,attributeFilter:["title"]}),this}addVote(e){const i=this;return new Promise((t,s)=>{Base.callApi(HTTP_VERBS.POST,this.mediaType.plural,"note",{id:this.id,note:e}).then(e=>{i.fill(e[this.mediaType.singular])._callListeners(EventTypes.NOTE),t(!0)}).catch(e=>{Base.notification("Erreur de vote","Une erreur s'est produite lors de l'envoi de la note: "+e),s(e)})})}fetchCharacters(){throw new Error("Method abstract")}getCharacter(e){for(const t of this.characters)if(t.id===e)return t;return null}}const dateFormat=function(){const m=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,g=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,f=/[^-+\dA-Z]/g,v=(e,t=2)=>String(e).padStart(t,"0"),b={default:"ddd dd mmm yyyy HH:MM:ss",datetime:"dd/mm/yyyy HH:MM",shortDate:"d/m/yy",mediumDate:"d mmm yyyy",longDate:"d mmmm yyyy",fullDate:"dddd, d mmmm yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},_={dayNames:{abr:["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."],full:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"]},monthNames:{abr:["Jan.","Fev.","Mar.","Avr.","Mai","Juin","Juil.","Août","Sept.","Oct.","Nov.","Dec."],full:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"]}};return function(e,t,s){if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(e)||/\d/.test(e)||(t=e,e=void 0),e=e?new Date(e):new Date,isNaN(e))throw TypeError("invalid date");"UTC:"==(t=String(b[t]||t||b.default)).slice(0,4)&&(t=t.slice(4),s=!0);const i=s?"getUTC":"get",n=e[i+"Date"](),a=e[i+"Day"](),r=e[i+"Month"](),o=e[i+"FullYear"](),l=e[i+"Hours"](),d=e[i+"Minutes"](),c=e[i+"Seconds"](),h=e[i+"Milliseconds"](),p=s?0:e.getTimezoneOffset(),u={d:n,dd:v(n),ddd:_.dayNames.abr[a],dddd:_.dayNames.full[a],m:r+1,mm:v(r+1),mmm:_.monthNames.abr[r],mmmm:_.monthNames.full[r],yy:String(o).slice(2),yyyy:o,h:l%12||12,hh:v(l%12||12),H:l,HH:v(l),M:d,MM:v(d),s:c,ss:v(c),l:v(h,3),L:v(99<h?Math.round(h/10):h),t:l<12?"a":"p",tt:l<12?"am":"pm",T:l<12?"A":"P",TT:l<12?"AM":"PM",Z:s?"UTC":(String(e).match(g)||[""]).pop().replace(f,""),o:(0<p?"-":"+")+v(100*Math.floor(Math.abs(p)/60)+Math.abs(p)%60,4)};return t.replace(m,function(e){return e in u?u[e]:e.slice(1,e.length-1)})}}(),calculDuration=function(){const a=e=>{const t=new Date(e.getFullYear(),0,0);return Math.floor((e.getTime()-t.getTime())/864e5)},r={yesterday:"Hier",dayBeforeYesterday:"Avant-hier",longTime:"Il y a longtemps",days:"Il y a %days% jours",hours:"Il y a %hours% heures",minutes:"Il y a %minutes% minutes"};return function(e){const t=new Date,s=Math.round(a(t)-a(e));if(0<s)return 1===s?r.yesterday:2===s?r.dayBeforeYesterday:30<s?r.longTime:r.days.replace("%days%",s.toString());{const i=Math.round((t.getTime()-e.getTime())/6e4),n=Math.round((t.getTime()-e.getTime())/36e5);return 0===n&&0<i?r.minutes.replace("%minutes%",i.toString()):0<n?r.hours.replace("%hours%",n.toString()):void 0}}}(),upperFirst=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},camelCase=function(e){return e.replace(/[.,\/#!$%\^&\*;:][{}=\-_`~()]/g,"_").replace(/[^a-zA-Z_]/g,"").split("_").reduce((e,t,s)=>e+(s?t.upperFirst():t.toLowerCase()),"")};Date.prototype.format=function(e,t=!1){return dateFormat(this,e,t)},Date.prototype.duration=function(){return calculDuration(this)},String.prototype.upperFirst=function(){return upperFirst(this)},String.prototype.camelCase=function(){return camelCase(this)};class Media extends Base{static propsAllowedOverride={};static overrideType;static _fetch(e,t){throw new Error("Abstract Static Method")}static fetchByImdb(e,t=!1){return this._fetch({imdb_id:e},t)}followers;genres;imdb_id;language;length;original_title;similars;nbSimilars;_in_account;slug;constructor(e,t){return super(e),t&&(this.elt=t),this}init(){return new Promise(e=>{this._overrideProps(),e(this)})}fill(e){if(this.followers=parseInt(e.followers,10),this.imdb_id=e.imdb_id,this.language=e.language,this.length=parseInt(e.length,10),this.original_title=e.original_title,(!this.similars||this.similars.length<=0)&&(this.similars=[]),this.nbSimilars=0,e.similars&&e.similars instanceof Array?(this.similars=e.similars,this.nbSimilars=this.similars.length):e.similars&&(this.nbSimilars=parseInt(e.similars)),this.genres=[],e.genres&&e.genres instanceof Array)this.genres=e.genres;else if(e.genres instanceof Object)for(const t in e.genres)this.genres.push(e.genres[t]);return this.in_account=!!e.in_account,this.slug=e.slug,super.fill(e),this}get in_account(){return this._in_account}set in_account(e){this._in_account=!!e,this.save()}fetchSimilars(){return new Promise(e=>e(this))}getSimilar(t){if(!this.similars)return null;for(let e=0;e<this.similars.length;e++)if(this.similars[e].id===t)return this.similars[e];return null}override(t,s,i){var n=this.constructor;if(n.propsAllowedOverride[t]){const a=Base.gm_funcs.getValue("override",{shows:{},movies:{}});void 0===a[n.overrideType][this.id]&&(a[n.overrideType][this.id]={}),a[n.overrideType][this.id][t]=s;let e=n.propsAllowedOverride[t].path;return n.propsAllowedOverride[t].params&&(a[n.overrideType][this.id][t]={value:s,params:i},e=Base.replaceParams(e,n.propsAllowedOverride[t].params,i),console.log("override",{prop:t,value:s,params:i,path:e})),Base.setPropValue(this,e,s),Base.gm_funcs.setValue("override",a),!0}return!1}_overrideProps(){var s,i=this.constructor,n=i.overrideType,a=Base.gm_funcs.getValue("override",{shows:{},movies:{}});if(a[n][this.id]){console.log("_overrideProps override found",a[n][this.id]);for(const r in a[n][this.id]){let e=i.propsAllowedOverride[r].path,t=a[n][this.id][r];i.propsAllowedOverride[r].params&&"object"==typeof a[n][this.id][r]&&(t=a[n][this.id][r].value,s=a[n][this.id][r].params,e=Base.replaceParams(e,i.propsAllowedOverride[r].params,s)),console.log("_overrideProps prop[%s]",r,{path:e,value:t}),Base.setPropValue(this,e,t)}}return this}_getTvdbUrl(e){const i=Base.serverBaseUrl+"/proxy/",n={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":"",Accept:"application/json"},mode:"cors",cache:"no-cache"};return new Promise((t,s)=>{fetch(i+"?tab=series&id="+e,n).then(e=>e.ok?e.json():s()).then(e=>{e?t(e.url):s()})})}}class Images{static formats={poster:"poster",wide:"wide"};constructor(e){this.show=e.show,this.banner=e.banner,this.box=e.box,this.poster=e.poster,this._local={show:this.show,banner:this.banner,box:this.box,poster:this.poster}}show;banner;box;poster;_local}!function(e){e[e.none=0]="none",e[e.banner=1]="banner",e[e.show=2]="show"}(Picked=Picked||{});class Picture{constructor(e){this.id=parseInt(e.id,10),this.show_id=parseInt(e.show_id,10),this.login_id=parseInt(e.login_id,10),this.url=e.url,this.width=parseInt(e.width,10),this.height=parseInt(e.height,10),this.date=new Date(e.date),this.picked=e.picked}id;show_id;login_id;url;width;height;date;picked}class Platform{constructor(e){this.id=parseInt(e.id,10),this.name=e.name,this.tag=e.tag,this.link_url=e.link_url,this.available=e.available,this.logo=e.logo,this.partner=!e.partner||!1}id;name;tag;link_url;available;logo;partner}class PlatformList{svod;vod;country;static types={svod:"svod",vod:"vod"};static fetchPlatforms(i="us"){return new Promise((t,s)=>{Base.callApi(HTTP_VERBS.GET,"platforms","list",{country:i}).then(e=>{t(new PlatformList(e.platforms,i))}).catch(e=>s(e))})}constructor(t,e="fr"){if(t.svod){this.svod=[];for(let e=0;e<t.svod.length;e++)this.svod.push(new Platform(t.svod[e]));this.svod.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0})}if(t.vod){this.vod=[];for(let e=0;e<t.vod.length;e++)this.vod.push(new Platform(t.vod[e]));this.vod.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0})}this.country=e}renderHtmlOptions(e="svod",t=null){let s="";if(e===PlatformList.types.svod){var i=this.svod.filter(e=>-1===t.indexOf(e.id));for(let e=0;e<i.length;e++)s+=`<option value="${i[e].id}" data-src="${i[e].logo}">${i[e].name}</option>`}else if(e===PlatformList.types.vod){var n=this.vod.filter(e=>-1===t.indexOf(e.id));for(let e=0;e<n.length;e++)s+=`<option value="${n[e].id}" data-src="${n[e].logo}">${n[e].name}</option>`}return s}}class Platforms{constructor(t){if(this.svods=[],t?.svods&&t?.svods instanceof Array)for(let e=0;e<t.svods.length;e++)this.svods.push(new Platform(t.svods[e]));if(t?.svod&&(this.svod=new Platform(t.svod)),this.vod=[],t?.vod&&t?.vod instanceof Array)for(let e=0;e<t.vod.length;e++)this.vod.push(new Platform(t.vod[e]))}svods;svod;vod}class Showrunner{constructor(e){this.id=e.id?parseInt(e.id,10):null,this.name=e.name,this.picture=e.picture}id;name;picture}class Show extends Media{static EventTypes=[EventTypes.UPDATE,EventTypes.SAVE,EventTypes.ADD,EventTypes.ADDED,EventTypes.REMOVE,EventTypes.NOTE,EventTypes.ARCHIVE,EventTypes.UNARCHIVE];static propsAllowedOverride={poster:{path:"images.poster"},season:{path:"seasons[#season#].image",params:{season:"number"}}};static overrideType="shows";static _fetch(e,i=!1){return new Promise((t,s)=>{Base.callApi("GET","shows","display",e,i).then(e=>t(new Show(e.show,jQuery(".blockInformations")))).catch(e=>s(e))})}static fetchLastSeen(s=10){return new Promise((e,t)=>{Base.callApi(HTTP_VERBS.GET,"shows","member",{order:"last_seen",limit:s}).then(t=>{const s=[];for(let e=0;e<t.shows.length;e++)s.push(new Show(t.shows[e],jQuery("body")));e(s)}).catch(e=>t(e))})}static fetchMulti(i){return new Promise((e,t)=>{Base.callApi(HTTP_VERBS.GET,"shows","display",{id:i.join(",")}).then(t=>{const s=[];if(1<i.length)for(let e=0;e<t.shows.length;e++)s.push(new Show(t.shows[e],jQuery(".blockInformations")));else s.push(new Show(t.show,jQuery(".blockInformations")));e(s)}).catch(e=>t(e))})}static fetch(e,t=!1){return Show._fetch({id:e},t)}static fetchByTvdb(e,t=!1){return this._fetch({thetvdb_id:e},t)}static fetchByUrl(e,t=!0){return this._fetch({url:e},t)}aliases;creation;country;_currentSeason;images;markToSee;nbEpisodes;network;next_trailer;next_trailer_host;rating;persons;pictures;platforms;seasons;showrunner;social_links;status;thetvdb_id;_posters;constructor(e,t){return super(e,t),this.fill(e)}init(){return this.fetchSeasons().then(()=>(this.in_account?this.deleteShowClick():this.addShowClick(),this._overrideProps(),this))}fetch(e=!0){return Base.callApi("GET","shows","display",{id:this.id},e)}fetchSeasons(){const i=this,e={thetvdb_id:this.thetvdb_id};let t=!1;return this.thetvdb_id<=0&&(delete e.thetvdb_id,e.id=this.id,t=!0),Base.callApi(HTTP_VERBS.GET,"shows","seasons",e,t).then(t=>{if(i.seasons=[],t?.seasons?.length<=0)return i;var s;for(let e=0;e<t.seasons.length;e++)s=parseInt(t.seasons[e].number,10),i.seasons[s-1]=new Season(t.seasons[e],this);return i})}fetchCharacters(){const s=this;return Base.callApi(HTTP_VERBS.GET,"shows","characters",{thetvdb_id:this.thetvdb_id}).then(t=>{if(s.characters=[],t?.characters?.length<=0)return s;for(let e=0;e<t.characters.length;e++)s.characters.push(new Character(t.characters[e]));return s})}getCharacterByName(e){var t=e.toLocaleLowerCase();for(const s of this.characters)if(s.actor.toLocaleLowerCase()===t)return s;return null}fetchPersons(){const s=this;return Base.callApi(HTTP_VERBS.GET,"persons","show",{id:this.id}).then(t=>{if(this.persons=[],t.persons)for(let e=0;e<t.persons.length;e++)s.persons.push(new Person(t.persons[e]));return s})}async fetchPersonsFromCharacters(){const s=this,t=(this.characters.length<=0&&await this.fetchCharacters(),[]);for(let e=0;e<s.characters.length;e++)t.push(Person.fetch(s.characters[e].person_id));return Promise.all(t).then(t=>{for(let e=0;e<t.length;e++)t[e]&&s.persons.push(t[e]);return s})}getPersonByName(e){var t=e.toLocaleLowerCase();for(const s of this.persons)if(s.name.toLocaleLowerCase()===t)return s;return null}getPersonById(e){for(const t of this.persons)if(t.id===e)return t;return null}isEnded(){return"ended"===this.status.toLowerCase()}isArchived(){return this.user.archived}isFavorite(){return this.user.favorited}isMarkedToSee(){return void 0!==Base.gm_funcs.getValue("toSee",{})[this.id]}addToAccount(){const i=this;return this.in_account?new Promise(e=>e(i)):new Promise((t,s)=>{Base.callApi("POST","shows","show",{id:i.id}).then(e=>{i.fill(e.show),i._callListeners(EventTypes.ADD),i.save(),t(i)},e=>{void 0!==e.code&&2003===e.code&&i.update(!0).then(e=>t(e)),s(e)})})}removeFromAccount(){const i=this;return this.in_account?new Promise((t,s)=>{Base.callApi("DELETE","shows","show",{id:i.id}).then(e=>{i.fill(e.show),i._callListeners(EventTypes.REMOVE),i.save(),t(i)},e=>{void 0!==e.code&&2004===e.code&&i.update(!0).then(e=>t(e)),s(e)})}):new Promise(e=>e(i))}archive(){const i=this;return new Promise((t,s)=>{Media.callApi("POST","shows","archive",{id:i.id}).then(e=>{i.fill(e.show),i.save(),i._callListeners(EventTypes.ARCHIVE),t(i)},e=>{s(e)})})}unarchive(){const i=this;return new Promise((t,s)=>{Media.callApi("DELETE","shows","archive",{id:i.id}).then(e=>{i.fill(e.show),i.save(),i._callListeners(EventTypes.UNARCHIVE),t(i)},e=>{s(e)})})}favorite(){const i=this;return new Promise((t,s)=>{Media.callApi("POST","shows","favorite",{id:i.id}).then(e=>{i.fill(e.show),i.save(),t(i)},e=>{s(e)})})}unfavorite(){const i=this;return new Promise((t,s)=>{Media.callApi("DELETE","shows","favorite",{id:i.id}).then(e=>{i.fill(e.show),i.save(),t(i)},e=>{s(e)})})}update(e=!1,i=Base.noop){const n=this;return new Promise((t,s)=>{n.fetch(e).then(e=>{n.fill(e.show),n.updateRender(()=>{t(n),i(),n._callListeners(EventTypes.UPDATE)})}).catch(e=>{Media.notification("Erreur de récupération de la ressource Show","Show update: "+e),s(e),i()})})}updateRender(t=Base.noop){const s=this;this.updateProgressBar(),this.updateNextEpisode();var i=this.objNote;if(Base.debug&&console.log("Next ID et status",{next:this.user.next.id,status:this.status,archived:this.user.archived,note_user:i.user}),0===this.user.remaining&&this.in_account&&0==this.currentSeason.getNbEpisodesUnwatched()){let e=new Promise(e=>e(void 0));this.isEnded()&&!this.isArchived()&&(Base.debug&&console.log("Série terminée, popup confirmation archivage"),e=new Promise(e=>{new PopupAlert({title:"Archivage de la série",text:"Voulez-vous archiver cette série terminée ?",callback_yes:function(){jQuery("#reactjs-show-actions button.btn-archive").trigger("click"),e(void 0)},callback_no:function(){return e(void 0),!0}})})),0===i.user&&(Base.debug&&console.log("Proposition de voter pour la série"),e.then(()=>{let e=!1;new PopupAlert({title:Base.trans("popin.note.title.show"),text:"Voulez-vous noter la série ?",callback_yes:function(){return e=!0},callback_no:function(){return!0},onClose:function(){e&&(s.objNote.updateStars(),s.objNote.createPopupForVote())}})})),e.then(()=>{t()})}else t()}updateProgressBar(){Base.debug&&console.log("updateProgressBar"),jQuery(".progressBarShow").css("width",this.user.status.toFixed(1)+"%")}updateNextEpisode(e=Base.noop){Base.debug&&console.log("updateNextEpisode");const s=this,t=jQuery("a.blockNextEpisode"),i=function(){let t=0;for(let e=0;e<s.seasons.length;e++)t+=s.seasons[e].getNbEpisodesUnwatched();return t.toString()};if(0<t.length&&this.user.next&&!isNaN(this.user.next.id)){var n=parseInt(this.user.next.code.match(/S\d+/)[0].replace("S",""),10);let e=this.user.next;var a=this.currentSeason?.getNextEpisodeUnwatched();n<this.currentSeason?.number&&a&&(e=new Next({id:a.id,code:a.code,date:a.date,title:a.title,image:""})),Base.debug&&console.log("nextEpisode et show.user.next OK",this.user,e);const o=t.find("img"),l=t.find(".remaining div"),d=o.parent("div"),c=o.attr("height"),h=o.attr("width"),p=`${Base.api.url}/pictures/episodes?key=${Base.userKey}&id=${e.id}&width=${h}&height=`+c;o.remove(),d.append(`<img data-src="${p}" class="js-lazy-image" height="${c}" width="${h}" />`),t.find(".titleEpisode").text(e.code.toUpperCase()+" - "+e.title),t.attr("href",t.attr("href").replace(/s\d{2}e\d{2}/,e.code.toLowerCase())),l.text(l.text().trim().replace(/^\d+/,i()))}else t.length<=0&&this.user.next&&!isNaN(this.user.next.id)?(Base.debug&&console.log("No nextEpisode et show.user.next OK",this.user),n=this,a=""+Base.api.url+`/pictures/episodes?key=${Base.userKey}&id=${n.user.next.id}&width=124&height=70`,r=n.resource_url.split("/").pop(),jQuery(".blockInformations__actions").last().after(`<a href="/episode/${r}/${n.user.next.code.toLowerCase()}" class="blockNextEpisode media">
                    <div class="media-left">
                    <div class="u-insideBorderOpacity u-insideBorderOpacity--01">
                        <img src="${a}" width="124" height="70">
                    </div>
                    </div>
                    <div class="media-body">
                    <div class="title">
                        <strong>Prochain épisode à regarder</strong>
                    </div>
                    <div class="titleEpisode">
                        ${n.user.next.code.toUpperCase()} - ${n.user.next.title}
                    </div>
                    <div class="remaining">
                        <div class="u-colorWhiteOpacity05">${i()} épisode${1<n.user.remaining?"s":""} à regarder</div>
                    </div>
                    </div>
                </a>`)):this.user.next&&!isNaN(this.user.next.id)||t.remove();var r;e()}addShowClick(e=!1){const l=this,d=$("#episodes .slide__image");var t;function s(s){var t=jQuery(".blockInformations__action .dropdown-menu a.header-navigation-item");if(t.length<=3){var i=jQuery('script[id^="/reactjs/"]').get(0).id.split(".")[1],n=s.resource_url.substring(location.origin.length),a=s.title.replace(/"/g,'\\"').replace(/'/g,"\\'");let e=`
                        <button type="button" class="btn-reset header-navigation-item" onclick="new PopupAlert({
                        showClose: true,
                        type: "popin-subtitles",
                        reactModuleId: "reactjs-subtitles",
                        params: {
                            mediaId: "${s.id}",
                            type: "show",
                            titlePopin: "${a}";
                        },
                        callback: function() {
                            loadRecommendationModule('subtitles');
                            //addScript("/reactjs/subtitles.${i}.js", "module-reactjs-subtitles");
                        },
                        });">Sous-titres</button>
                        <a class="header-navigation-item" href="javascript:;" onclick="reportItem(${s.id}, 'show');">Signaler un problème</a>
                        <a class="header-navigation-item" href="webcal://www.betaseries.com/cal/i${n}">Planning iCal de la série</a>

                        <form class="autocomplete js-autocomplete-form header-navigation-item">
                            <button type="reset" class="btn-reset fontWeight700 js-autocomplete-show" style="color: inherit">Recommander la série</button>
                            <div class="autocomplete__toShow" hidden="">
                                <input placeholder="Nom d'un ami" type="text" class="autocomplete__input js-search-friends">
                                <div class="autocomplete__response js-display-response"></div>
                            </div>
                        </form>
                        <script>
                            new SearchFriend({url: document.querySelector("[data-show-url]").dataset.showUrl});
                        </script>
                        <a class="header-navigation-item" href="javascript:;">Supprimer de mes séries</a>`;2===t.length&&(e=`<a class="header-navigation-item" href="${n}/actions">Vos actions sur la série</a>`+e),jQuery('.blockInformations__action .dropdown-menu.header-navigation[aria-labelledby="dropdownOptions"]').append(e)}if(1===jQuery("#reactjs-show-actions > div").length){const e=jQuery("#reactjs-show-actions");e.empty().append(`
                        <div class="displayFlex alignItemsFlexStart"
                                id="reactjs-show-actions"
                                data-show-id="${s.id}"
                                data-user-hasarchived="${s.user.archived?"1":""}"
                                data-show-inaccount="1"
                                data-user-id="${Base.userId}"
                                data-show-favorised="${s.user.favorited?"1":""}">
                            <div class="blockInformations__action">
                                <button class="btn-reset btn-transparent btn-archive" type="button">
                                    <span class="svgContainer">
                                    <svg fill="#0d151c" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
                                        <path d="m16 8-1.41-1.41-5.59 5.58v-12.17h-2v12.17l-5.58-5.59-1.42 1.42 8 8z"></path>
                                    </svg>
                                    </span>
                                </button>
                                <div class="label">${Base.trans("show.button.archive.label")}</div>
                            </div>
                            <div class="blockInformations__action">
                                <button class="btn-reset btn-transparent btn-favoris" type="button">
                                    <span class="svgContainer">
                                    <svg fill="#FFF" width="20" height="19" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M14.5 0c-1.74 0-3.41.81-4.5 2.09C8.91.81 7.24 0 5.5 0 2.42 0 0 2.42 0 5.5c0 3.78 3.4 6.86 8.55 11.54L10 18.35l1.45-1.32C16.6 12.36 20 9.28 20 5.5 20 2.42 17.58 0 14.5 0zm-4.4 15.55l-.1.1-.1-.1C5.14 11.24 2 8.39 2 5.5 2 3.5 3.5 2 5.5 2c1.54 0 3.04.99 3.57 2.36h1.87C11.46 2.99 12.96 2 14.5 2c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"></path>
                                    </svg>
                                    </span>
                                </button>
                                <div class="label">${Base.trans("show.button.favorite.label")}</div>
                            </div>
                        </div>`);let t;for(let e=0;e<d.length;e++)(t=$(d.get(e))).find(".seen").length<=0&&t.find("img.js-lazy-image").attr("style","filter: blur(5px);");const r=jQuery(".blockInformations__metadatas .js-render-stars");r.replaceWith(`
                    <button type="button" class="btn-reset fontSize0">
                        <span class="stars js-render-stars">
                            ${r.html()}
                        </span>
                    </button>`),l.elt=$(".blockInformations");a=`<button
                    type="button"
                    class="btn-reset blockTitle-subtitle u-colorWhiteOpacity05"
                >
                    ${Base.trans("popup.suggest_show.title",{"%title%":"une série"})}</button>`;jQuery("#similars h2.blockTitle").after(a),l.addNumberVoters(),l.elt.find(".blockInformations__action .btnMarkToSee").parent().remove(),l.elt.find(".blockInformations__title .fa-clock-o").remove();const o=Base.gm_funcs.getValue("toSee",{});void 0!==o[l.id]&&(delete o[l.id],Base.gm_funcs.setValue("toSee",o))}l.addEventBtnsArchiveAndFavoris(),l.deleteShowClick()}this.in_account||(jQuery("#reactjs-show-actions").html(`
                <div class="blockInformations__action">
                    <button class="btn-reset btn-transparent btn-add" type="button">
                        <span class="svgContainer">
                            <svg fill="#0D151C" width="14" height="14" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 8H8v6H6V8H0V6h6V0h2v6h6z" fill-rule="nonzero"></path>
                            </svg>
                        </span>
                    </button>
                    <div class="label">${Base.trans("show.button.add.label")}</div>
                </div>`),this.addBtnToSee(),t=`<a class="header-navigation-item" href="javascript:;" onclick="showUpdate('${this.title.replace(/"/g,'\\"').replace(/'/g,"\\'")}', ${this.id}, '0')">Demander une mise à jour</a>`,jQuery('.blockInformations__action .dropdown-menu.header-navigation[aria-labelledby="dropdownOptions"]').append(t),jQuery("#reactjs-show-actions > div > button").off("click").one("click",e=>{e.stopPropagation(),e.preventDefault(),Base.debug&&console.groupCollapsed("AddShow");function t(){s(l),l.updateNextEpisode(function(){l._callListeners(EventTypes.ADDED),Base.debug&&console.groupEnd()})}l.addToAccount().then(()=>t(),e=>{e&&void 0!==e.code&&2003===e.code?t():(Base.notification("Erreur d'ajout de la série",e),Base.debug&&console.groupEnd())})})),e&&this.update(!0).then(e=>{s(e)})}deleteShowClick(){const n=this,a=$("#dropdownOptions").siblings(".dropdown-menu").children("a.header-navigation-item");this.in_account&&2<a.length&&(this.addEventBtnsArchiveAndFavoris(),a.last().removeAttr("onclick").off("click").on("click",e=>{e.stopPropagation(),e.preventDefault();function t(){new PopupAlert({title:Base.trans("popup.delete_show_success.title"),text:Base.trans("popup.delete_show_success.text",{"%title%":n.title}),yes:Base.trans("popup.delete_show_success.yes"),callback_yes:function(){n.user.status=0,n.user.archived=!1,n.user.favorited=!1,n.user.remaining=0,n.user.last="S00E00",n.user.next.id=NaN,n.save(),jQuery("#reactjs-show-actions").html(`
                            <div class="blockInformations__action">
                                <button class="btn-reset btn-transparent btn-add" type="button">
                                <span class="svgContainer">
                                    <svg fill="#0D151C" width="14" height="14" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 8H8v6H6V8H0V6h6V0h2v6h6z" fill-rule="nonzero"></path>
                                    </svg>
                                </span>
                                </button>
                                <div class="label">${Base.trans("show.button.add.label")}</div>
                            </div>`),a.first().siblings().each((e,t)=>{$(t).remove()});const s=jQuery("#episodes .slide_flex");let e,i=!1;(e=n.currentSeason.episodes&&0<n.currentSeason.episodes.length?new Promise(e=>e(n.currentSeason)):n.currentSeason.fetchEpisodes()).then(t=>{for(let e=0;e<t.episodes.length;e++)null===t.episodes[e].elt&&(t.episodes[e].elt=$(s.get(e))),e===t.episodes.length-1&&(i=!0),Base.debug&&console.log("clean episode %d",e,i),t.episodes[e].updateRender("notSeen",i)});const t=jQuery(".blockInformations__metadatas .js-render-stars");t.parent().replaceWith(`
                            <span class="stars js-render-stars">
                                ${t.html()}
                            </span>`),n.elt=$(".blockInformations"),n.addNumberVoters(),n.addBtnToSee(),n.addShowClick(),n.updateProgressBar(),n.updateNextEpisode()}})}new PopupAlert({title:Base.trans("popup.delete_show.title",{"%title%":n.title}),text:Base.trans("popup.delete_show.text",{"%title%":n.title}),callback_yes:function(){Base.debug&&console.groupCollapsed("delete show"),n.removeFromAccount().then(t,e=>{if(e&&void 0!==e.code&&2004===e.code)return t(),void(Base.debug&&console.groupEnd());Media.notification("Erreur de suppression de la série",e),Base.debug&&console.groupEnd()})},callback_no:Base.noop})}))}addBtnToSee(){if(!(0<this.elt.find(".btnMarkToSee").length)){const s=this;this.elt.find(".blockInformations__actions").last().append(`
            <div class="blockInformations__action">
                <button class="btn-reset btn-transparent btnMarkToSee" type="button" title="Ajouter la série aux séries à voir">
                    <i class="fa fa-clock-o" aria-hidden="true"></i>
                </button>
                <div class="label">A voir</div>
            </div>`);const e=this.elt.find(".blockInformations__action .btnMarkToSee");e.click(e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget);(e=>{const t=Base.gm_funcs.getValue("toSee",{});let s;return s=void 0===t[e]?t[e]=!0:(delete t[e],!1),Base.gm_funcs.setValue("toSee",t),s})(s.id)?(t.find("i.fa").css("color","var(--body_background)"),t.attr("title","Retirer la série des séries à voir"),s.elt.find(".blockInformations__title").append('<i class="fa fa-clock-o" aria-hidden="true" style="font-size:0.6em;margin-left:5px;vertical-align:middle;" title="Série à voir plus tard"></i>')):(t.find("i.fa").css("color","var(--default-color)"),t.attr("title","Ajouter la série aux séries à voir"),s.elt.find(".blockInformations__title .fa").remove()),t.blur()}),void 0!==Base.gm_funcs.getValue("toSee",{})[this.id]&&(e.find("i.fa").css("color","var(--body_background)"),e.attr("title","Retirer la série des séries à voir"),s.elt.find(".blockInformations__title").append('<i class="fa fa-clock-o" aria-hidden="true" style="font-size:0.6em;" title="Série à voir plus tard"></i>'))}}addEventBtnsArchiveAndFavoris(){const t=this;let e=jQuery("#reactjs-show-actions button.btn-archive"),s=jQuery("#reactjs-show-actions button.btn-favoris");0!==e.length&&0!==s.length||($("#reactjs-show-actions button:first").addClass("btn-archive"),e=jQuery("#reactjs-show-actions button.btn-archive"),$("#reactjs-show-actions button:last").addClass("btn-favoris"),s=jQuery("#reactjs-show-actions button.btn-favoris")),e.off("click").click(n=>{function e(e,t,s,i){e.then(()=>{var e=$(n.currentTarget).parent();$("span",n.currentTarget).css("transform",t),$(".label",e).text(Base.trans(s)),Base.debug&&console.groupEnd()},e=>{Base.notification(i,e),Base.debug&&console.groupEnd()})}n.stopPropagation(),n.preventDefault(),Base.debug&&console.groupCollapsed("show-archive"),t.isArchived()?e(t.unarchive(),"rotate(0deg)","show.button.archive.label","Erreur désarchivage de la série"):e(t.archive(),"rotate(180deg)","show.button.unarchive.label","Erreur d'archivage de la série")}),s.off("click").click(e=>{e.stopPropagation(),e.preventDefault(),Base.debug&&console.groupCollapsed("show-favoris"),t.isFavorite()?t.unfavorite().then(()=>{$(e.currentTarget).children("span").replaceWith(`
                            <span class="svgContainer">
                            <svg fill="#FFF" width="20" height="19" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.5 0c-1.74 0-3.41.81-4.5 2.09C8.91.81 7.24 0 5.5 0 2.42 0 0 2.42 0 5.5c0 3.78 3.4 6.86 8.55 11.54L10 18.35l1.45-1.32C16.6 12.36 20 9.28 20 5.5 20 2.42 17.58 0 14.5 0zm-4.4 15.55l-.1.1-.1-.1C5.14 11.24 2 8.39 2 5.5 2 3.5 3.5 2 5.5 2c1.54 0 3.04.99 3.57 2.36h1.87C11.46 2.99 12.96 2 14.5 2c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"></path>
                            </svg>
                            </span>`),Base.debug&&console.groupEnd()},e=>{Base.notification("Erreur de favoris de la série",e),Base.debug&&console.groupEnd()}):t.favorite().then(()=>{jQuery(e.currentTarget).children("span").replaceWith(`
                            <span class="svgContainer">
                            <svg width="21" height="19" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15.156.91a5.887 5.887 0 0 0-4.406 2.026A5.887 5.887 0 0 0 6.344.909C3.328.91.958 3.256.958 6.242c0 3.666 3.33 6.653 8.372 11.19l1.42 1.271 1.42-1.28c5.042-4.528 8.372-7.515 8.372-11.18 0-2.987-2.37-5.334-5.386-5.334z"></path>
                            </svg>
                            </span>`),Base.debug&&console.groupEnd()},e=>{Base.notification("Erreur de favoris de la série",e),Base.debug&&console.groupEnd()})})}addRating(){var e;Base.debug&&console.log("addRating"),this.rating&&null!==(e=void 0!==Base.ratings[this.rating]?Base.ratings[this.rating]:null)&&jQuery(".blockInformations__details").append(`<li id="rating"><strong>Classification</strong>
                        <img src="${e.img}" title="${e.title}"/>
                    </li>`)}setCurrentSeason(e){if(e<=0||e>this.seasons.length)throw new Error("seasonNumber is out of range of seasons");return this._currentSeason=e-1,this}get currentSeason(){return this.seasons[this._currentSeason]}getSeason(t){Base.debug&&console.log("getSeason: ",t);for(let e=0;e<this.seasons.length;e++)if(this.seasons[e].number==t)return this.seasons[e];return null}getDefaultImage(e=Images.formats.poster){const t=Base.serverBaseUrl+"/posters",s={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":""},mode:"cors",cache:"no-cache"};return new Promise((n,a)=>{e===Images.formats.poster?(Base.debug&&console.log("getDefaultImage poster",this.images.poster),this.images.poster?n(this.images.poster):this._getTvdbUrl(this.thetvdb_id).then(e=>{if(!e)return n("");e=new URL(e);fetch(t+e.pathname,s).then(e=>e.ok?e.text():null).then(e=>{if(null==e)return a("HTML error");const t=new DOMParser,s=t.parseFromString(e,"text/html"),i=s.querySelector('.container .row a[rel="artwork_posters"]');n(i.href.replace("original","w500"))}).catch(e=>a(e))})):e===Images.formats.wide&&(null!==this.images.show?n(this.images.show):null!==this.images.box?n(this.images.box):this._getTvdbUrl(this.thetvdb_id).then(e=>{if(!e)return n("");e=new URL(e);fetch(t+e.pathname,s).then(e=>e.ok?e.text():null).then(e=>{if(null==e)return a("HTML error");const t=new DOMParser,s=t.parseFromString(e,"text/html"),i=s.querySelector('.container .row a[rel="artwork_backgrounds"]');n(i.href.replace("original","w500"))}).catch(e=>a(e))}))})}getAllPosters(){if(this._posters)return new Promise(e=>e(this._posters));const t=Base.serverBaseUrl+"/posters",s={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":""},mode:"cors",cache:"no-cache"};return new Promise((n,a)=>{const r={};this.images?._local.poster&&(r.local=[this.images._local.poster]),this._getTvdbUrl(this.thetvdb_id).then(e=>{if(!e)return n(r);e=new URL(e);fetch(t+e.pathname+"/artwork/posters",s).then(e=>e.ok?e.text():null).then(e=>{if(null==e)return a("HTML error");r.TheTVDB=[];const t=new DOMParser,s=t.parseFromString(e,"text/html");var i=s.querySelectorAll("a.thumbnail img");for(let e=0;e<i.length;e++)r.TheTVDB.push(i[e].dataset.src);this._posters=r,n(r)}).catch(e=>a(e))})})}}!function(e){e[e.TOSEE=0]="TOSEE",e[e.SEEN=1]="SEEN",e[e.DONTWANTTOSEE=2]="DONTWANTTOSEE"}(MovieStatus=MovieStatus||{});class Movie extends Media{static propsAllowedOverride={poster:{path:"poster"}};static overrideType="movies";static _fetch(e,i=!1){return new Promise((t,s)=>{Base.callApi("GET","movies","movie",e,i).then(e=>t(new Movie(e.movie,jQuery(".blockInformations")))).catch(e=>s(e))})}static fetch(e,t=!1){return Movie._fetch({id:e},t)}static fetchByTmdb(e,t=!1){return this._fetch({tmdb_id:e},t)}static search(e,i=!1){return new Promise((t,s)=>{Base.callApi(HTTP_VERBS.GET,"movies","search",{title:e},i).then(e=>{t(new Movie(e.movies[0]))}).catch(e=>s(e))})}backdrop;director;original_release_date;other_title;platform_links;poster;production_year;release_date;sale_date;tagline;tmdb_id;trailer;_posters;_local;constructor(e,t){return super(e,t),this._local={poster:null},this.fill(e)}fill(e){return void 0!==e.user?.in_account&&(e.in_account=e.user.in_account,delete e.user.in_account),e.description=e.synopsis,delete e.synopsis,e.slug=e.url,delete e.url,this.backdrop=e.backdrop,this.director=e.director,this.original_release_date=new Date(e.original_release_date),this.other_title=e.other_title,this.platform_links=e.platform_links,this.poster=e.poster,this._local={poster:this.poster},this.production_year=parseInt(e.production_year),this.release_date=new Date(e.release_date),this.sale_date=new Date(e.sale_date),this.tagline=e.tagline,this.tmdb_id=parseInt(e.tmdb_id),this.trailer=e.trailer,this.mediaType={singular:MediaType.movie,plural:"movies",className:Movie},super.fill(e),this.save()}markAsView(){return this.changeStatus(MovieStatus.SEEN)}markToSee(){return this.changeStatus(MovieStatus.TOSEE)}markDontWantToSee(){return this.changeStatus(MovieStatus.DONTWANTTOSEE)}changeStatus(e){const t=this;return Base.userIdentified()&&this.user.status!==e?Base.callApi(HTTP_VERBS.POST,this.mediaType.plural,"movie",{id:this.id,state:e}).then(e=>(t.fill(e.movie),this)).catch(e=>(console.warn("Erreur ajout film sur compte",e),Base.notification("Ajout du film","Erreur lors de l'ajout du film sur votre compte"),this)):(Base.debug&&console.info("User not identified or state is equal with user status"),Promise.resolve(this))}getDefaultImage(i="poster"){const n={method:"GET",mode:"cors",cache:"no-cache"};return new Promise((t,s)=>{if("poster"===i)if(this.poster)t(this.poster);else{var e=Base.themoviedb_api_user_key,e=`https://api.themoviedb.org/3/movie/${this.tmdb_id}?api_key=${e}&language=fr`;fetch(e,n).then(e=>e.ok?e.json():null).then(e=>{if(null==e)return s("Response JSON error");e.poster?t("https://image.tmdb.org/t/p/w500"+e.poster):s("no data poster")}).catch(e=>s(e))}})}fetchCharacters(){const s=this;return Base.callApi(HTTP_VERBS.GET,"movies","characters",{id:this.id},!0).then(t=>{if(s.characters=[],t?.characters?.length<=0)return s;for(let e=0;e<t.characters.length;e++)s.characters.push(new Character(t.characters[e]));return s})}getAllPosters(){if(this._posters)return new Promise(e=>e(this._posters));const n={method:"GET",mode:"cors",cache:"no-cache"};return new Promise((e,s)=>{const i={};this.poster&&(i.local=[this._local.poster]);var t=Base.themoviedb_api_user_key,t=`https://api.themoviedb.org/3/movie/${this.tmdb_id}/images?api_key=`+t;fetch(t,n).then(e=>e.ok?e.json():null).then(t=>{if(null==t)return s("Response JSON error");if(t.posters&&0<t.posters.length){i.TheMovieDB=[];for(let e=0;e<t.posters.length;e++)i.TheMovieDB.push("https://image.tmdb.org/t/p/w500"+t.posters[e].file_path)}this._posters=i,e(i)}).catch(e=>s(e))})}}class Subtitle{id;language;source;quality;file;url;date;episode;show;season;constructor(e){this.id=parseInt(e.id,10),this.language=e.language,this.source=e.source,this.quality=parseInt(e.quality,10),this.file=e.file,this.url=e.url,this.date=new Date(e.date),this.show=parseInt(e.show_id,10),this.episode=parseInt(e.episode_id,10),this.season=parseInt(e.season,10)}}!function(e){e.LANGUAGE="language",e.SOURCE="source",e.QUALITY="quality",e.DATE="date"}(SortTypeSubtitles=SortTypeSubtitles||{}),function(e){e.EPISODE="episode",e.SEASON="season",e.SHOW="show"}(SubtitleTypes=SubtitleTypes||{}),function(e){e.ALL="all",e.VOVF="vovf",e.VO="vo",e.VF="vf"}(SubtitleLanguages=SubtitleLanguages||{});class Subtitles{subtitles;static fetch(e,t,s=SubtitleLanguages.ALL){const i={id:t.id,language:s};return e===SubtitleTypes.SEASON&&(i.season=t.season),Base.callApi(HTTP_VERBS.GET,"subtitles",e,i).then(e=>new Subtitles(e.subtitles))}constructor(t){if(this.subtitles=[],t&&0<t.length)for(let e=0;e<t.length;e++)this.subtitles.push(new Subtitle(t[e]))}sortBy(s){return this.subtitles.sort((e,t)=>e[s]>t[s]?1:e[s]<t[s]?-1:0)}}class Season{number;episodes;nbEpisodes;has_subtitles;hidden;_image;seen;_show;_elt;constructor(e,t){return this.number=parseInt(e.number,10),this._show=t,this.episodes=[],this.has_subtitles=!!e.has_subtitles||!1,this.hidden=!!e.hidden||!1,this.seen=!!e.seen||!1,this.image=e.image||null,this._elt=jQuery(`#seasons .slides_flex .slide_flex:nth-child(${this.number.toString()})`),e.episodes&&e.episodes instanceof Array&&e.episodes[0]instanceof Episode?this.episodes=e.episodes:e.episodes&&"number"==typeof e.episodes&&(this.nbEpisodes=e.episodes),this}get length(){return this.episodes.length}set image(e){if(this._image=e){const t=jQuery("#seasons .slide_flex .slide__image img");t.length>=this.number&&$(t.get(this.number-1)).attr("src",e)}}get image(){return this._image}fetchEpisodes(){if(!this.number||this.number<=0)throw new Error("season number incorrect");const s=this;return new Promise((e,t)=>{Base.callApi("GET","shows","episodes",{id:s._show.id,season:s.number},!0).then(t=>{s.episodes=[];for(let e=0;e<t.episodes.length;e++)s.episodes.push(new Episode(t.episodes[e],s));e(s)},e=>{t(e)})})}watched(){const s=this;var e={id:this.episodes[this.length-1].id,bulk:!0};return Base.callApi(HTTP_VERBS.POST,"episodes","watched",e).then(()=>{let t=!1;for(let e=0;e<s.episodes.length;e++)e==s.episodes.length-1&&(t=!0),s.episodes[e].user.seen=!0,s.episodes[e].updateRender("seen",t);return s})}hide(){const s=this;var e={id:this._show.id,season:this.number};return Base.callApi(HTTP_VERBS.POST,"seasons","hide",e).then(()=>{s.hidden=!0,jQuery(`#seasons .slide_flex:nth-child(${s.number}) .slide__image`).prepend('<div class="checkSeen"></div><div class="hideIcon"></div>');let t=!1;for(let e=0;e<s.episodes.length;e++)e==s.episodes.length-1&&(t=!0),s.episodes[e].user.hidden=!0,s.episodes[e].updateRender("hidden",t);return s})}getEpisode(t){for(let e=0;e<this.episodes.length;e++)if(this.episodes[e].id===t)return this.episodes[e];return null}getNbEpisodesSeen(){let t=0;for(let e=0;e<this.episodes.length;e++)this.episodes[e].user.seen&&t++;return t}getNbEpisodesUnwatched(){let t=0;if(this.episodes.length<=0&&!this.seen)return this.nbEpisodes;if(this.episodes.length<=0||this.hidden)return 0;for(let e=0;e<this.episodes.length;e++)this.episodes[e].user.seen||t++;return t}getNbEpisodesSpecial(){let t=0;for(let e=0;e<this.episodes.length;e++)this.episodes[e].special&&t++;return t}updateShow(e=Base.noop){return this._show.update(!0).then(e),this}updateRender(){const e=this;var t=this.episodes.length,s=this.getNbEpisodesSpecial(),i=t-s,n=e.getNbEpisodesSeen();Base.debug&&console.log("Season updateRender",{lenEpisodes:t,lenSpecials:s,lenNotSpecials:i,lenSeen:n});function a(){e._elt.find(".slide__image").prepend('<div class="checkSeen"></div>'),Base.debug&&console.log("Tous les épisodes de la saison ont été vus",e._elt,e._elt.next()),0<e._elt.next().length&&(Base.debug&&console.log("Il y a une autre saison"),e._elt.removeClass("slide--current"),e._elt.next(".slide_flex").find(".slide__image").trigger("click")),e._elt.removeClass("slide--notSeen").addClass("slide--seen"),e.seen=!0}if(n===t)a();else if(0<s&&n===i)new PopupAlert({title:"Fin de la saison",text:"Tous les épisodes de la saison, hors spéciaux, ont été vu.<br/>Voulez-vous passer à la saison suivante ?",callback_yes:()=>{a()},callback_no:()=>!0});else{const r=this._elt.find(".checkSeen");0<r.length&&(r.remove(),e._elt.hasClass("slide--notSeen")||e._elt.addClass("slide--notSeen").removeClass("slide--seen"))}return this}changeCurrentSeason(e){return this._show.setCurrentSeason(e),this}showInAccount(){return this._show.in_account}addShowToAccount(){return this._show.in_account=!0,this}getNextEpisodeUnwatched(){for(let e=0;e<this.episodes.length;e++)if(!this.episodes[e].user.seen)return this.episodes[e];return null}}class Episode extends Base{static fetch(e){return Base.callApi(HTTP_VERBS.GET,"episodes","display",{id:e}).then(e=>new Episode(e.episode,null,jQuery(".blockInformations")))}_season;code;date;director;episode;global;numSeason;platform_links;releasesSvod;seen_total;special;subtitles;thetvdb_id;watched_by;writers;youtube_id;constructor(e,t,s){return super(e),this._season=t,s&&(this.elt=s),this.fill(e)}fill(e){return this.code=e.code,this.date=new Date(e.date),this.director=e.director,this.episode=parseInt(e.episode,10),this.global=parseInt(e.global,10),this.numSeason=parseInt(e.season,10),this.platform_links=e.platform_links,this.releasesSvod=e.releasesSvod,this.seen_total=null!==e.seen_total?parseInt(e.seen_total,10):0,this.special=1===e.special,this.subtitles=new Subtitles(e.subtitles||[]),this.thetvdb_id=parseInt(e.thetvdb_id,10),this.watched_by=e.watched_by,this.writers=e.writers,this.youtube_id=e.youtube_id,this.mediaType={singular:MediaType.episode,plural:"episodes",className:Episode},super.fill(e),this.save()}addAttrTitle(){return this.elt&&this.elt.find(".slide__title").attr("title",this.title),this}initCheckSeen(e){const t=this.elt.find(".checkSeen");return 0<t.length&&this.user.seen?(t.attr("id","episode-"+this.id),t.attr("data-id",this.id),t.attr("data-pos",e),t.attr("data-special",this.special?"1":"0"),t.attr("title",Base.trans("member_shows.remove")),t.addClass("seen")):t.length<=0&&!this.user.seen&&!this.user.hidden?(this.elt.find(".slide__image").append(`<div id="episode-${this.id}"
                                class="checkSeen"
                                data-id="${this.id}"
                                data-pos="${e}"
                                data-special="${this.special?"1":"0"}"
                                style="background: rgba(13,21,28,.2);"
                                title="${Base.trans("member_shows.markas")}"></div>`),this.elt.find(".slide__image img.js-lazy-image").attr("style","filter: blur(5px);")):0<t.length&&this.user.hidden&&t.remove(),this}updateCheckSeen(e){const t=this.elt.find(".checkSeen");let s=!1;return 0<t.length&&void 0===t.attr("id")&&(Base.debug&&console.log("ajout de l'attribut ID à l'élément \"checkSeen\""),t.attr("id","episode-"+this.id),t.data("id",this.id),t.data("pos",e),t.data("special",this.special?"1":"0")),this.user.seen&&0<t.length&&!t.hasClass("seen")?(Base.debug&&console.log("Changement du statut (seen) de l'épisode %s",this.code),this.updateRender("seen",!1),s=!0):!this.user.seen&&0<t.length&&t.hasClass("seen")?(Base.debug&&console.log("Changement du statut (notSeen) de l'épisode %s",this.code),this.updateRender("notSeen",!1),s=!0):this.user.hidden&&0<t.length&&(t.remove(),s=!0),this.updateTitle(),s}updateTitle(){const e=this.elt.find(".slide__title");this.code.toUpperCase()+" - "+this.title!==e.text().trim()&&e.text(this.code.toUpperCase()+" - "+this.title)}getTitlePopup(){return`<span style="color: var(--link_color);">Synopsis épisode ${this.code}</span>`}markAsView(){this.updateStatus("seen",HTTP_VERBS.POST)}markAsUnview(){this.updateStatus("unseen",HTTP_VERBS.DELETE)}updateStatus(i,n){const a=this,r=this.elt.find(".checkSeen").data("pos"),e={id:this.id,bulk:!0};let t=new Promise(e=>{e(!1)});if(this.toggleSpinner(!0),n===HTTP_VERBS.POST){const s=jQuery("#episodes .checkSeen");for(let e=0;e<r;e++)if(!$(s.get(e)).hasClass("seen")){t=new Promise(e=>{new PopupAlert({title:"Episodes vus",contentHtml:"<p>Doit-on cocher les épisodes précédents comme vu ?</p>",yes:Base.trans("popup.yes"),no:Base.trans("popup.no"),callback_yes:()=>{e(!0)},callback_no:()=>{e(!1)}});const t=jQuery("#popin-dialog #popupalertno"),s=jQuery("#popin-dialog #popupalertyes");t.attr("tabIndex",0).focus(),s.attr("tabIndex",0).show()});break}}t.then(t=>{n!==HTTP_VERBS.POST||t||(e.bulk=!1),Base.callApi(n,"episodes","watched",e).then(e=>{if(Base.debug&&console.log("updateStatus %s episodes/watched",n,e),!a._season.showInAccount()&&e.episode.show.in_account&&a._season.addShowToAccount(),n===HTTP_VERBS.POST&&t&&r){const s=jQuery("#episodes .slide_flex");let t=null;for(let e=0;e<r;e++)null===(t=a._season.episodes[e]).elt&&(t.elt=jQuery(s.get(e))),t.user.seen||(t.user.seen=!0,t.updateRender("seen",!1).save())}a.fill(e.episode).updateRender(i,!0)._callListeners(EventTypes.UPDATE)._season.updateRender().updateShow(()=>{0<jQuery("#episodes .slide_flex.slide--notSeen").length&&(jQuery("#episodes .slides_flex").get(0).scrollLeft=jQuery("#episodes .slide_flex.slide--notSeen").get(0).offsetLeft-69),a.toggleSpinner(!1)})}).catch(e=>{Base.debug&&console.error("updateStatus error %s",e),e&&"changeStatus"==e?(Base.debug&&console.log("updateStatus error %s changeStatus",n),a.user.seen="seen"===i,a.updateRender(i)._season.updateRender().updateShow(()=>{a.toggleSpinner(!1)})):(a.toggleSpinner(!1),Base.notification("Erreur de modification d'un épisode","updateStatus: "+e))})})}updateRender(e,t=!0){const s=this.elt.find(".checkSeen");if(Base.debug&&console.log("changeStatus",{elt:s,status:e,update:t}),"seen"===e)s.css("background",""),s.addClass("seen"),s.attr("title",Base.trans("member_shows.remove")),s.parents("div.slide__image").first().find("img").removeAttr("style"),s.parents("div.slide_flex").first().removeClass("slide--notSeen");else if("notSeen"===e){s.css("background","rgba(13,21,28,.2)"),s.removeClass("seen"),s.attr("title",Base.trans("member_shows.markas")),s.parents("div.slide__image").first().find("img").attr("style","filter: blur(5px);");const i=s.parents("div.slide_flex").first();i.hasClass("slide--notSeen")||i.addClass("slide--notSeen")}else"hidden"===e&&(s.removeClass("seen"),s.parents(".slide__image").append('<div class="hideIcon"></div>').attr("style","filter: blur(5px);"));return this}toggleSpinner(e){return e?(Base.debug&&console.groupCollapsed("episode checkSeen"),this.elt.find(".slide__image").first().prepend(`
                <div class="spinner">
                    <div class="spinner-item"></div>
                    <div class="spinner-item"></div>
                    <div class="spinner-item"></div>
                </div>`)):(jQuery(".spinner").remove(),Base.debug&&console.groupEnd()),this}getDefaultImage(){return new Promise(e=>e(Base.api.url+"/pictures/episodes?id="+this.id))}fetchCharacters(){const s=this;return Base.callApi(HTTP_VERBS.GET,"episodes","characters",{id:this.id},!0).then(t=>{if(s.characters=[],t?.characters?.length<=0)return s;for(let e=0;e<t.characters.length;e++)s.characters.push(new Character(t.characters[e]));return s})}}class Similar extends Media{backdrop;director;original_release_date;other_title;platform_links;poster;production_year;release_date;sale_date;tagline;tmdb_id;trailer;url;aliases;creation;country;images;nbEpisodes;network;next_trailer;next_trailer_host;rating;pictures;platforms;seasons;nbSeasons;showrunner;social_links;status;thetvdb_id;persons;constructor(e,t){return t.singular===MediaType.movie&&(e.in_account=e.user.in_account,delete e.user.in_account,e.description=e.synopsis,delete e.synopsis),super(e),this.mediaType=t,this.fill(e)}fill(e){return this.mediaType.singular===MediaType.show?(this.aliases=e.aliases,this.creation=e.creation,this.country=e.country,this.images=null,void 0!==e.images&&null!==e.images&&(this.images=new Images(e.images)),this.nbEpisodes=parseInt(e.episodes,10),this.network=e.network,this.next_trailer=e.next_trailer,this.next_trailer_host=e.next_trailer_host,this.rating=e.rating,this.platforms=null,void 0!==e.platforms&&null!==e.platforms&&(this.platforms=new Platforms(e.platforms)),this.seasons=[],this.nbSeasons=parseInt(e.seasons,10),this.showrunner=null,void 0!==e.showrunner&&null!==e.showrunner&&(this.showrunner=new Showrunner(e.showrunner)),this.social_links=e.social_links,this.status=e.status,this.thetvdb_id=parseInt(e.thetvdb_id,10),this.pictures=[],this.persons=[]):this.mediaType.singular===MediaType.movie&&(void 0!==e.user.in_account&&(e.in_account=e.user.in_account,delete e.user.in_account),void 0!==e.synopsis&&(e.description=e.synopsis,delete e.synopsis),void 0!==e.url&&(e.slug=e.url,delete e.url),this.backdrop=e.backdrop,this.director=e.director,this.original_release_date=new Date(e.original_release_date),this.other_title=e.other_title,this.platform_links=e.platform_links,this.poster=e.poster,this.production_year=parseInt(e.production_year),this.release_date=new Date(e.release_date),this.sale_date=new Date(e.sale_date),this.tagline=e.tagline,this.tmdb_id=parseInt(e.tmdb_id),this.trailer=e.trailer),super.fill(e),this}fetch(e=!0){let t="display";return this.mediaType.singular===MediaType.movie&&(t="movie"),Base.callApi("GET",this.mediaType.plural,t,{id:this.id},e)}addViewed(){const e=this.elt.find("a.slide__image");return this.user.status&&(this.mediaType.singular===MediaType.movie&&1===this.user.status||this.mediaType.singular===MediaType.show&&0<this.user.status)&&e.prepend(`<img src="${Base.serverBaseUrl}/img/viewed.png" class="bandViewed"/>`),e.attr("data-id",this.id).attr("data-type",this.mediaType.singular),this}wrench(t){const e=this.elt.find(".slide__title"),s=this;return e.html(e.html()+`<i class="fa fa-wrench popover-wrench"
                aria-hidden="true"
                style="margin-left:5px;cursor:pointer;"
                data-id="${s.id}"
                data-type="${s.mediaType.singular}">
            </i>`),e.find(".popover-wrench").click(e=>{e.stopPropagation(),e.preventDefault(),this.fetch().then(function(e){t.setContent(renderjson.set_show_to_level(2)(e[s.mediaType.singular])),t.setCounter(Base.counter.toString()),t.setTitle("Données du similar"),t.show()})}),this}getContentPopup(){const t=this;let e=this.description,s=(200<e.length&&(e=e.substring(0,200)+"…"),"");function i(){let e="";return(t.creation||t.country||t.production_year)&&(e+="<p>",t.production_year&&(e+=`<u>Production:</u> <strong>${t.production_year}</strong>`),t.country&&(e+=`<u>Pays:</u> <strong>${t.country}</strong>`),t.creation&&(e+=`<span style="margin-left:5px;">${t.creation}</span>`),e+="</p>"),e}function n(){return t.genres&&0<t.genres.length?"<p><u>Genres:</u> "+t.genres.join(", ")+"</p>":""}if(s="<div>",this.mediaType.singular===MediaType.show){var a=`<i class="fa fa-${"ended"==this.status.toLowerCase()?"ban":"spinner"}" title="Statut ${"ended"==this.status.toLowerCase()?"terminé":"en cours"}" aria-hidden="true"></i>`,r=0<this.user.status?"Vu à <strong>"+this.user.status+"%</strong>":"Pas vu";s+=`<p>
                <strong>${this.nbSeasons}</strong> saison${1<this.nbSeasons?"s":""},
                <strong>${this.nbEpisodes}</strong> <i class="fa fa-film" title="épisodes" aria-hidden="true"></i>, `,0<this.objNote.total?(s+=`<strong>${this.objNote.total}</strong> votes`,0<this.objNote.user&&(s+=", votre note: "+this.objNote.user)):s+="Aucun vote",s+=`<span style="margin-left:5px;"><strong>${t.nbComments}</strong> <i class="fa fa-comment" title="commentaires" aria-hidden="true"></i></span>`,this.in_account||(s+=`<span style="margin-left:5px;">
                    <a href="javascript:;" class="addShow"><i class="fa fa-plus" title="Ajouter" aria-hidden="true"></i></a> -
                    <a href="javascript:;" class="toSeeShow" data-show-id="${t.id}"><i class="fa fa-clock-o" title="A voir" aria-hidden="true"></i></a>
                </span>`),s=(s=(s+="</p>")+n())+i();let e="";0<this.user.status&&!0===this.user.archived?e=', Archivée: <i class="fa fa-check-circle-o" aria-hidden="true"></i>':0<this.user.status&&(e=', Archivée: <i class="fa fa-circle-o" aria-hidden="true"></i>'),this.showrunner&&0<this.showrunner.name.length&&(s+=`<p><u>Show Runner:</u> <strong>${this.showrunner.name}</strong></p>`),s+=`<p><u>Statut:</u> ${a}, ${r}${e}</p>`}else s+="<p>",0<this.objNote.total?(s+=`<strong>${this.objNote.total}</strong> votes`,0<this.objNote.user&&(s+=", votre note: "+this.objNote.user)):s+="Aucun vote",s=(s=(s=(s=(s=(s=(s=s+`<span style="margin-left:5px;"><strong>${t.nbComments}</strong> <i class="fa fa-comment" title="commentaires" aria-hidden="true"></i></span>`+"</p>")+`<p><label for="seen">Vu</label>
                <input type="radio" class="movie movieSeen" name="movieState" value="1" data-movie="${this.id}" ${1===this.user.status?"checked":""} style="margin-right:5px;vertical-align:middle;"></input>`)+`<label for="mustSee">A voir</label>
                <input type="radio" class="movie movieMustSee" name="movieState" value="0" data-movie="${this.id}" ${0===this.user.status?"checked":""} style="margin-right:5px;vertical-align:middle;"></input>`)+`<label for="notSee">Ne pas voir</label>
                <input type="radio" class="movie movieNotSee" name="movieState" value="2" data-movie="${this.id}"  ${2===this.user.status?"checked":""} style="vertical-align:middle;"></input>`)+`<button class="btn btn-danger reset" style="margin-left:10px;padding:2px 5px;${this.user.status<0?"display:none;":""}">Reset</button></p>`)+n())+i(),this.director&&(s+=`<p><u>Réalisateur:</u> <strong>${this.director}</strong></p>`);return s+`<p>${e}</p></div>`}getTitlePopup(){let e=this.title;return 0<this.objNote.total&&(e+=' <span style="font-size: 0.8em;color:var(--link_color);">'+this.objNote.mean.toFixed(2)+" / 5</span>"),this.mediaType.singular===MediaType.show&&(e+=` <span style="float:right;">
                <a href="http://www.thetvdb.com/?tab=series&id=${this.thetvdb_id}" target="_blank" title="Lien vers la page de TheTVDB">
                    <img src="https://thetvdb.com/images/logo.svg" width="40px" />
                </a>
                <a href="javascript:;" onclick="showUpdate('${this.title}', ${this.id}, '0')" style="margin-left:5px; color:var(--default_color);" title="Mettre à jour les données venant de TheTVDB">
                    <i class="fa fa-refresh" aria-hidden="true"></i>
                </a>
            </span>`),e}updateTitleNote(e=!0){const t=this.elt.find(".stars-outer");if(this.objNote.mean<=0||this.objNote.total<=0)return e&&t.attr("title","Aucun vote"),"";var s=this.objNote.toString();return e&&t.attr("title",s),s}renderStars(){return this.elt.find(".slide__title").after('<div class="stars-outer"><div class="stars-inner"></div></div>'),this.updateTitleNote(),this.elt.find(".stars-inner").width(this.objNote.getPercentage()+"%"),this}checkImg(){const e=this.elt.find("img.js-lazy-image"),i=this;if(0<e.length)return this;if(this.mediaType.singular===MediaType.show)if(null!==this.images.poster)this.elt.find("div.block404").replaceWith(`
                    <img class="u-opacityBackground fade-in"
                            width="125"
                            height="188"
                            alt="Affiche de la série ${this.title}"
                            src="${this.images.poster}"/>`);else{const s=Base.serverBaseUrl+"/posters/",n={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":"userscript-bs"},mode:"cors",cache:"no-cache"};this._getTvdbUrl(this.thetvdb_id).then(e=>{e&&(e=new URL(e),fetch(s+e.pathname,n).then(e=>e.ok?e.text():null).then(e=>{if(null!=e){const t=new DOMParser,s=t.parseFromString(e,"text/html");e=s.querySelector('.container .row a[rel="artwork_posters"]');e&&this.elt.find("div.block404").replaceWith(`
                                <img class="u-opacityBackground fade-in"
                                        width="125"
                                        height="188"
                                        alt="Affiche de la série ${i.title}"
                                        src="${e.href}"/>`)}}))})}else if(this.mediaType.singular===MediaType.movie&&this.tmdb_id&&0<this.tmdb_id){if(Base.themoviedb_api_user_key.length<=0)return;var t=`https://api.themoviedb.org/3/movie/${this.tmdb_id}?api_key=${Base.themoviedb_api_user_key}&language=fr-FR`;fetch(t).then(e=>e.ok?e.json():null).then(e=>{null!==e&&void 0!==e.poster_path&&null!==e.poster_path&&i.elt.find("div.block404").replaceWith(`
                        <img class="u-opacityBackground fade-in"
                                width="125"
                                height="188"
                                alt="Poster de ${i.title}"
                                src="https://image.tmdb.org/t/p/original${e.poster_path}"/>`)})}return this}addToAccount(e=0){return this.in_account?Promise.resolve(this):this.changeState(e)}changeState(e){if(e<-1||2<e)throw new Error("Parameter state is incorrect: "+e.toString());const t=this,s={id:this.id};let i=HTTP_VERBS.POST;return-1===e&&this.mediaType.singular===MediaType.movie?i=HTTP_VERBS.DELETE:this.mediaType.singular===MediaType.movie&&(s.state=e),Base.callApi(i,this.mediaType.plural,this.mediaType.singular,s).then(e=>(t.fill(e[t.mediaType.singular]),i===HTTP_VERBS.DELETE&&(t.in_account=!1,t.user.status=-1,t.save()),t)).catch(e=>(console.warn("Erreur changeState similar",e),Base.notification("Change State Similar","Erreur lors du changement de statut: "+e.toString()),t))}addVote(e){throw new Error("On ne vote pas pour un similar")}}class UpdateAuto{static instance;static intervals=[{val:0,label:"Jamais"},{val:1,label:"1 min."},{val:5,label:"5 min."},{val:10,label:"10 min."},{val:15,label:"15 min."},{val:30,label:"30 min."},{val:45,label:"45 min."},{val:60,label:"60 min."}];_show;_showId;_exist;_status;_auto;_interval;_timer;_lastUpdate;constructor(e){if(UpdateAuto.instance)return UpdateAuto.instance;this._show=e,this._showId=e.id;e=Base.gm_funcs.getValue("objUpAuto",{});return this._exist=!1,this._lastUpdate=null,void 0!==e[this._showId]?(this._exist=!0,this._status=e[this._showId].status,this._auto=e[this._showId].auto,this._interval=e[this._showId].interval):(this._status=!1,this._auto=!1,this._interval=0),this.changeColorBtn(),this}static getInstance(e){return UpdateAuto.instance||(UpdateAuto.instance=new UpdateAuto(e)),UpdateAuto.instance}_save(){const e=Base.gm_funcs.getValue("objUpAuto",{});var t={status:this._status,auto:this._auto,interval:this._interval};return e[this._showId]=t,Base.gm_funcs.setValue("objUpAuto",e),this._exist=!0,this.changeColorBtn(),this}get show(){return this._show}get status(){return this._status}set status(e){this._status=e,this._save()}get auto(){return this._auto}set auto(e){this._auto=e,this._save()}get interval(){return this._interval}set interval(e){this._interval=e,this._save()}get lastUpdate(){return this._lastUpdate}changeColorBtn(){let e="#fff";return this._exist?this._status&&this._auto?e="green":this._auto&&!this._status?e="orange":this._auto||this._status||(e="red"):e="#6c757d",$(".updateEpisodes").css("color",e),this}stop(){return this._show.user.remaining<=0&&this._show.isEnded()?(this._auto=!1,this._interval=0):this._show.user.remaining<=0&&(this._auto=!1),this.status=!1,clearInterval(this._timer),this._timer=null,this._lastUpdate=null,this}delete(){this.stop();const e=Base.gm_funcs.getValue("objUpAuto",{});return void 0!==e[this._showId]&&(delete e[this._showId],Base.gm_funcs.setValue("objUpAuto",e),this._auto=!1,this._interval=0,this._exist=!1,this.changeColorBtn()),this}launch(){if(this.status&&(!this.auto||this.interval<=0))return Base.debug&&console.log("close interval updateEpisodeListAuto"),this.stop();if(this.auto&&0<this.interval){if(this._show.user.remaining<=0)return 0<this._show.currentSeason.getNbEpisodesUnwatched()&&this._tick(),this.stop(),this;this._timer&&(Base.debug&&console.log("close old interval timer"),clearInterval(this._timer)),this.status=!0,this._tick(),this._timer=setInterval(this._tick.bind(this),60*this.interval*1e3)}return this}_tick(){const e=new Date,t=(this._lastUpdate=Date.now(),Base.debug&&console.log("%s update episode list",`[${e.format("datetime")}]`),jQuery(".updateEpisodes"));0<t.length&&(t.trigger("click"),this.status||(this.status=!0)),(!this.auto||this.show.user.remaining<=0)&&(Base.debug&&console.log("Arrêt de la mise à jour auto des épisodes"),this.stop())}remaining(){if(null==this._lastUpdate)return"not running";var e=Date.now()-this._lastUpdate,e=Math.floor((60*this._interval*1e3-e)/1e3);const t=Math.floor(e/60),s=e-60*t;return t.toString()+":"+(s<10?"0"+s.toString():s.toString())}}!function(e){e.monday="lundi",e.tuesday="mardi",e.wednesday="mercredi",e.thursday="jeudi",e.friday="vendredi",e.saturday="samedi",e.sunday="dimanche"}(DaysOfWeek=DaysOfWeek||{});class Stats{friends;shows;seasons;episodes;comments;progress;episodes_to_watch;time_on_tv;time_to_spend;movies;badges;member_since_days;friends_of_friends;episodes_per_month;favorite_day;five_stars_percent;four_five_stars_total;streak_days;favorite_genre;written_words;without_days;shows_finished;shows_current;shows_to_watch;shows_abandoned;movies_to_watch;time_on_movies;time_to_spend_movies;constructor(e){for(const t in Object.keys(e))this[t]=e[t]}}class Options{downloaded;notation;timelag;global;specials;episodes_tri;friendship;country;language;mail_mois;mail_hebdo;notification_news;twitter_auto;constructor(e){for(const t in Object.keys(e))this[t]=e[t]}}class Member{static fetch(){const e={};return null!==Base.userId&&(e.id=Base.userId),Base.callApi(HTTP_VERBS.GET,"members","infos",e).then(e=>new Member(e.member)).catch(e=>{throw console.warn("Erreur lors de la récupération des infos du membre",e),new Error("Erreur de récupération du membre")})}id;fb_id;login;xp;locale;cached;avatar;profile_banner;in_account;is_admin;subscription;valid_email;screeners;twitterLogin;stats;options;notifications;constructor(e){this.id=parseInt(e.id,10),this.fb_id=parseInt(e.fb_id,10),this.login=e.login,this.xp=parseInt(e.xp,10),this.locale=e.locale,this.cached=parseInt(e.cached,10),this.avatar=e.avatar,this.profile_banner=e.profile_banner,this.in_account=!!e.in_account,this.is_admin=!!e.is_admin,this.subscription=parseInt(e.subscription,10),this.valid_email=!!e.valid_email,this.screeners=e.screeners,this.twitterLogin=e.twitterLogin,this.stats=new Stats(e.stats),this.options=new Options(e.options),this.checkNotifs()}checkNotifs(){var e=()=>{NotificationList.fetch(50).then(e=>{this.notifications=e;const t=jQuery("#menuUnseenNotifications");0<e.new.length?(t.length<=0?jQuery(".menu-wrapper .js-iconNotifications").append(`<i class="unread-count unread-notifications" id="menuUnseenNotifications">${e.new.length}</i>`):t.text(e.new.length),jQuery(".menu-icon--bell").removeClass("has-notifications")):0<t.length&&t.remove()})};setInterval(e,3e5),e()}renderNotifications(){const e=jQuery("#growl"),t=jQuery("#growl .notifications__loader"),s=jQuery("#growl .notification.notification--delete-all"),i=jQuery("#growl .js-notificationsNew-list"),n=jQuery("#growl .js-notificationsOld-list"),a=jQuery("#growl .notificationsList"),r={old:n,new:i};i.empty(),n.empty(),s.hide(),a.hide(),e.addClass("visible"),t.show();for(const o of this.notifications){for(let e=0;e<this.notifications[o].length;e++)r[o].append(this.notifications[o][e].render());0<this.notifications[o].length&&r[o].parents(".notificationsList").show()}t.hide(),0<this.notifications.length&&(s.show(),0<this.notifications.new.length&&(this.notifications.seen=!0),jQuery("#menuUnseenNotifications").remove())}}!function(e){e.episode="episode",e.reportNew="report_new",e.reportTreated="report_treated",e.xpMany="xp_many",e.bugResolved="bug_resolved",e.bugCommented="bug_commented",e.poll="poll",e.season="season",e.comment="comment",e.badge="badge",e.banner="banner",e.character="character",e.movie="movie",e.forum="forum",e.friend="friend",e.message="message",e.quizz="quizz",e.recommend="recommend",e.site="site",e.subtitles="subtitles",e.video="video"}(NotifTypes=NotifTypes||{});class NotifPayload{static props=[{key:"url",type:"string",fn:null,default:""},{key:"title",type:"string",fn:null,default:""},{key:"code",type:"string",fn:null,default:""},{key:"show_title",type:"string",fn:null,default:""},{key:"picture",type:"string",fn:null,default:""},{key:"season",type:"number",fn:parseInt,default:0},{key:"name",type:"string",fn:null,default:""},{key:"xp",type:"number",fn:parseInt,default:0},{key:"user",type:"string",fn:null,default:""},{key:"user_id",type:"number",fn:parseInt,default:0},{key:"user_picture",type:"string",fn:null,default:"https://img.betaseries.com/5gtv-uQY0aSPqDtcyu7rhHLcu6Q=/40x40/smart/https%3A%2F%2Fwww.betaseries.com%2Fimages%2Fsite%2Flogo-64x64.png"},{key:"type",type:"string",fn:null,default:""},{key:"type_id",type:"number",fn:parseInt,default:0}];url;title;code;show_title;picture;season;name;xp;user;user_id;user_picture;type;type_id;constructor(t){let s,i;for(let e=0;e<NotifPayload.props.length;e++)s=NotifPayload.props[e],i=NotifPayload.props[e].default,t&&t.hasOwnProperty(s.key)&&(i=t[s.key],null!==s.fn&&(i=s.fn(i,10))),this[s.key]=i}}class NotificationList{static fetch(e=20){e={all:!0,sort:"DESC",number:e};return Base.callApi(HTTP_VERBS.GET,"members","notifications",e).then(t=>{const s=new NotificationList;for(let e=0;e<t.notifications.length;e++)s.add(new NotificationBS(t.notifications[e]));return s}).catch(e=>{throw console.warn("Erreur de récupération des notifications du membre",e),new Error("Erreur de récupération des notifications")})}old;new;seen;constructor(){this.old=[],this.new=[],this.seen=!1}*[Symbol.iterator](){yield"new",yield"old"}get length(){return this.old.length+this.new.length}add(e){this[null===e.seen?"new":"old"].push(e)}markAllAsSeen(){if(this.seen&&0<this.new.length){for(let e=this.new.length-1;0<=e;e--)this.new[e].seen=new Date,this.old.unshift(this.new[e]);this.new=[],this.seen=!1}}}class NotificationBS{id;type;ref_id;text;html;date;seen;payload;constructor(e){this.id=parseInt(e.id,10),this.type=NotifTypes[String(e.type).camelCase()],this.ref_id=parseInt(e.ref_id,10),this.text=e.text,this.html=e.html,this.date=new Date(e.date),this.seen=null!=e.seen?new Date(e.seen):null,this.payload=new NotifPayload(e.payload)}render(){if(0===this.text.length)return null;let e;e=0<this.payload.user.length?`<a
                    href="https://www.betaseries.com/membre/${this.payload.user}"
                    target="_blank" class="avatar" data-displaylink="1"
                    >
                <img src="${this.payload.user_picture}" width="40" height="40" alt="avatar" />
            </a>`:`<span class="avatar"><img src="${this.payload.user_picture}" width="40" height="40" alt="avatar" /></span>`;var t=0<this.payload.picture?.length?`<div class="notification__image alignSelfFlexStart" data-displayimage="1"}"><img src="${this.payload.picture}" alt="image ${this.type}" height="38" width="38" /></div>`:"";return`
            <div
                class="notification${null==this.seen?" notification--unread":""}"
                id="i${this.id.toString()}"
                data-ref-id="${this.ref_id.toString()}"
                data-type="${this.type}"
            >
                <div class="media">
                    <div class="media-left">${e}</div>
                    <div class="media-body">
                        <div class="displayFlex">
                            <div class="notification__text alignSelfFlexStart">
                                <p>${this.html}</p>
                                <div class="notification__datas">
                                    <span class="mainTime" title="${this.date.format("datetime")}">${this.date.duration()}</span>
                                    <button type="button" class="btn-reset" onclick="deleteNotification('${this.id.toString()}');"><span class="mainTime">∙</span> Masquer</button>
                                </div>
                            </div>
                            ${t}
                        </div>
                    </div>
                </div>
            </div>`.trim()}}Show.prototype.fill=function(t){if(this.aliases=t.aliases,this.creation=t.creation,this.country=t.country,this.images=null,void 0!==t.images&&null!=t.images&&(this.images=new Images(t.images)),this.nbEpisodes=parseInt(t.episodes,10),this.network=t.network,this.next_trailer=t.next_trailer,this.next_trailer_host=t.next_trailer_host,this.rating=t.rating,this.platforms=null,this.platforms=new Platforms(t.platforms),null==this.id&&null==this.seasons&&(this.seasons=[],t.seasons_details))for(let e=0;e<t.seasons_details.length;e++)this.seasons.push(new Season(t.seasons_details[e],this));return this.showrunner=null,void 0!==t.showrunner&&null!=t.showrunner&&(this.showrunner=new Showrunner(t.showrunner)),this.social_links=t.social_links,this.status=t.status,this.thetvdb_id=parseInt(t.thetvdb_id,10),this.pictures=null,this.mediaType={singular:MediaType.show,plural:"shows",className:Show},this.persons=[],Media.prototype.fill.call(this,t),this.save()},Media.prototype.fetchSimilars=function(){const s=this;return this.similars=[],new Promise((e,t)=>{Base.callApi("GET",this.mediaType.plural,"similars",{id:this.id,details:!0},!0).then(t=>{if(t.similars)for(let e=0;e<t.similars.length;e++)s.similars.push(new Similar(t.similars[e][s.mediaType.singular],s.mediaType));s.save(),e(s)},e=>{t(e)})})};
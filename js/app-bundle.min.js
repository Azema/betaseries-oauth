"use strict";var DataTypesCache,NetworkState,EventTypes,HTTP_VERBS,OrderComments,MediaStatusComments,TypeDisplayComment,StarTypes,MediaType,Picked,MovieStatus,SortTypeSubtitles,SubtitleTypes,SubtitleLanguages,DaysOfWeek,NotifTypes;!function(e){e.shows="shows",e.episodes="episodes",e.movies="movies",e.members="members",e.updates="updateAuto",e.db="db"}(DataTypesCache=DataTypesCache||{});class CacheUS{_data;constructor(){return this._init()}_init(){return this._data={},this._data[DataTypesCache.shows]={},this._data[DataTypesCache.episodes]={},this._data[DataTypesCache.movies]={},this._data[DataTypesCache.members]={},this._data[DataTypesCache.db]={},this}keys(e=null){return e?Object.keys(this._data[e]):Object.keys(this._data)}has(e,t){return void 0!==this._data[e]&&void 0!==this._data[e][t]}clear(e=null){if(e&&void 0!==this._data[e])for(const t in this._data[e])delete this._data[e][t];else this._init();return this}get(e,t){return this.has(e,t)?this._data[e][t]:null}getOrDefault(e,t,s){return this.has(e,t)?this.get(e,t):s}set(e,t,s){return void 0!==this._data[e]&&(this._data[e][t]=s),this}remove(e,t){return this.has(e,t)&&delete this._data[e][t],this}}function humanize(e){var t=36e5,s=Math.abs(e);return 864e5<=s?Math.round(e/864e5)+"d":t<=s?Math.round(e/t)+"h":6e4<=s?Math.round(e/6e4)+"m":1e3<=s?Math.round(e/1e3)+"s":e+"ms"}function formatArgs(s){var e=this;if(!e.useColors)return s[0]=e.namespace+" "+s[0],void(e.time&&(s[0]+=" +"+humanize(e.diff)));const t="color: "+e.color,i="color:inherit",r=[];let n=!1;if(/%c/.test(s[0])){n=!0;let t=0;s[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(t++,"%c"===e&&r.push(t+2))}),r.length%2!=0&&(s[0]+="%c",r.push(++t+2),s.splice(t,0,i))}s[0]=`%c${e.namespace}%c `+s[0],Debug.displayTime&&(s[0]+="%c +"+humanize(e.diff)+"%c");let a=0,o=0;s[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(a++,"%c"!==e||n&&(!n||r.includes(a))||(o++,s.splice(a,0,o%2==1?t:i)))})}const useColors=()=>{if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;const e=navigator?.userAgent;return("undefined"==typeof navigator||!e||!/(edge|trident)\/(\d+)/.test(e.toLowerCase()))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&e&&/firefox\/(\d+)/.test(e.toLowerCase())&&31<=parseInt(RegExp.$1,10)||"undefined"!=typeof navigator&&e&&/applewebkit\/(\d+)/.test(e.toLowerCase()))};class Debug{static colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];static names;static skips;static storage=localStorage;static namespaces;static delimiter=":";static displayTime=!1;static _debug=console.debug||console.log;static _log=console.log;static _info=console.info;static save(e){try{e?Debug.storage.setItem("debug",e):Debug.storage.removeItem("debug")}catch(e){}}static load(){let t;try{t=Debug.storage.getItem("debug")}catch(e){t=""}return t}static enable(t){Debug.save(t),Debug.namespaces=t,Debug.names=[],Debug.skips=[];const s=("string"==typeof t?t:"").split(/[\s,]+/);var i=s.length;for(let e=0;e<i;e++)s[e]&&("-"===(t=s[e].replace(/\*/g,".*?"))[0]?Debug.skips.push(new RegExp("^"+t.slice(1)+"$")):Debug.names.push(new RegExp("^"+t+"$")))}static disable(){var e=[...Debug.names.map(Debug.toNamespace),...Debug.skips.map(Debug.toNamespace).map(e=>"-"+e)].join(",");return Debug.enable(""),e}static toNamespace(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}static ns_enabled(e){if("*"===e[e.length-1])return!0;let t,s;for(t=0,s=Debug.skips.length;t<s;t++)if(Debug.skips[t].test(e))return!1;for(t=0,s=Debug.names.length;t<s;t++)if(Debug.names[t].test(e))return!0;return!1}static coerce(e){return e instanceof Error?e.stack||e.message:e}static formatters={j:function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}};static selectColor(t){let s=0;for(let e=0;e<t.length;e++)s=(s<<5)-s+t.charCodeAt(e),s|=0;return Debug.colors[Math.abs(s)%Debug.colors.length]}static addFormatter(e,t){/^%/.test(e)&&(e=e.substring(1));const s=Object.keys(Debug.formatters);if(s.includes(e))throw new Error(`this letter(${e}) of formatter already exists`);Debug.formatters[e]=t}namespace;prevTime;diff;enableOverride=void 0;timeOverride=void 0;namespacesCache;enabledCache;useColors;color;constructor(e){return this.useColors=useColors(),this.color=Debug.selectColor(e),this.namespace=e,this}get enabled(){return void 0!==this.enableOverride?this.enableOverride:(this.namespacesCache!==Debug.namespaces&&(this.namespacesCache=Debug.namespaces,this.enabledCache=Debug.ns_enabled(this.namespace)),this.enabledCache)}set enabled(e){this.enableOverride=!!e}get time(){return void 0!==this.timeOverride?this.timeOverride:Debug.displayTime}set time(e){this.timeOverride=!!e}_prepareLog(i){const r=this;var e,t;Debug.displayTime&&(t=(e=Date.now())-(this.prevTime||e),r.diff=t,this.prevTime=e),i[0]=Debug.coerce(i[0]),"string"!=typeof i[0]&&i.unshift("%O");let n=0;return i[0]=i[0].replace(/%([a-zA-Z%])/g,(e,t)=>{if("%%"===e)return"%";n++;const s=Debug.formatters[t];return"function"==typeof s&&(t=i[n],e=s.call(r,t),i.splice(n,1),n--),e}),formatArgs.call(r,i),i}get fnDebug(){return this.debug.bind(this)}debug(...e){try{if(!this.enabled)return}catch(e){console.error("Error debug check enabled",this,e)}Debug._debug.apply(this,this._prepareLog(e))}get fnLog(){return this.log.bind(this)}log(...e){try{if(!this.enabled)return}catch(e){console.log("Error log check enabled",this,e)}Debug._log.apply(this,this._prepareLog(e))}get fnInfo(){return this.info.bind(this)}info(...e){try{if(!this.enabled)return}catch(e){console.log("Error log check enabled",this,e)}Debug._info.apply(this,this._prepareLog(e))}extend(e,t=Debug.delimiter){if("string"!=typeof e||e.length<=0)throw new Error("namespace must be a string not empty");return new Debug([this.namespace,e].join(t))}}function ExceptionIdentification(e){this.message=e,this.name="ExceptionIdentification"}function objToArr(e,t){if(t instanceof Array)return t;const s=[];for(const i in t)s.push(t[i]);return s}function isNull(e){return null==e}function fetchTimeout(e,s={},i=30){const r=new AbortController;return s.signal=r.signal,{abort:()=>r.abort(),ready:()=>{const t=setTimeout(()=>r.abort(),1e3*i);return fetch(e,s).then(e=>(t&&clearTimeout(t),e))}}}function checkNetwork(t=0){var e=UsBetaSeries.serverOauthUrl+"/index.html",s={method:HTTP_VERBS.HEAD,mode:"cors",cache:"no-cache"};fetchTimeout(e,s,5).ready().then(e=>{e.ok&&(UsBetaSeries.networkTimeout&&(clearTimeout(UsBetaSeries.networkTimeout),UsBetaSeries.networkTimeout=null),UsBetaSeries.changeNetworkState(NetworkState.online),UsBetaSeries.debug("Network is come back"))}).catch(e=>{t+=0===t?1e3:1e4,"failed to fetch"!==e.message.toLowerCase()&&console.error("checkNetwork catch: ",e),UsBetaSeries.logger.log("checkNetwork: Fetch aborted (next check in: %s)",function(e){if(e<60)return e.toString()+" secondes";let t=Math.floor(e/60);const s=Math.floor(t/60);e-=60*t;let i="";return 0<s&&(t-=60*s,i+=`${s.toString()} heure${1<s?"s":""} `),i+=`${t.toString()} min. ${e.toString()} sec.`}(t/1e3)),UsBetaSeries.networkTimeout=setTimeout(checkNetwork,t,t)})}!function(e){e[e.offline=0]="offline",e[e.online=1]="online"}(NetworkState=NetworkState||{}),function(e){e.ADD="add",e.ADDED="added",e.ARCHIVE="archive",e.DELETE="delete",e.HIDE="hide",e.NEW="new",e.NOTE="note",e.REMOVE="remove",e.SAVE="save",e.SEEN="seen",e.SHOW="show",e.UNARCHIVE="unarchive",e.UPDATE="update"}(EventTypes=EventTypes||{}),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS",e.HEAD="HEAD"}(HTTP_VERBS=HTTP_VERBS||{});class FakePromise{static fnAlreadyInclude(e,t){var s=e.toString();for(let e=0;e<t.length;e++)if(t[e].toString()===s)return!0;return!1}thenQueue;catchQueue;finallyQueue;promiseFunc;constructor(e){return this.thenQueue=[],this.catchQueue=[],this.finallyQueue=[],this.promiseFunc=e,this}setFunction(e){return this.promiseFunc=e,this}then(e,t){return e&&this.thenQueue.push(e),t&&this.catchQueue.push(t),this}catch(e){return this.then(null,e)}finally(e){return e&&this.finallyQueue.push(e),this}reject(s){return this.promiseFunc(s).catch(()=>{const t=this.catchQueue;for(let e=t.length;0<=e;e--)"function"==typeof t[e]&&t[e](s)}).finally(()=>{const t=this.finallyQueue;for(let e=t.length;0<=e;e--)"function"==typeof t[e]&&t[e]()})}launch(){return this.promiseFunc().then(t=>{const s=this.thenQueue;for(let e=s.length;0<=e;e--)"function"==typeof s[e]&&s[e](t)}).catch(t=>{const s=this.catchQueue;for(let e=s.length;0<=e;e--)"function"==typeof s[e]&&s[e](t)}).finally(()=>{const t=this.finallyQueue;for(let e=t.length;0<=e;e--)"function"==typeof t[e]&&t[e]()})}}class Base{static EventTypes=[EventTypes.UPDATE,EventTypes.SAVE,EventTypes.NOTE];__listeners;constructor(e){if(e instanceof Object)return this._initListeners(),this;throw new Error("data is not an object")}_initListeners(){this.__listeners={};var t=this.constructor.EventTypes;for(let e=0;e<t.length;e++)this.__listeners[t[e]]=[];return this}addListener(e,t,...s){const i=UsBetaSeries.logger.extend("listeners");if(i.debug("Base[%s] add Listener on event %s",this.constructor.name,e),this.constructor.EventTypes.indexOf(e)<0)throw new Error(e+" ne fait pas partit des events gérés par cette classe");isNull(this.__listeners[e])&&(this.__listeners[e]=[]);for(const r of this.__listeners[e])if("function"==typeof r&&r.toString()==t.toString())return;return this.__listeners[e].push(s.length<=0?t:{fn:t,args:s}),i.debug("Base[%s] add Listener on event %s",this.constructor.name,e,this.__listeners[e]),this}addListeners(e,t,...s){try{for(const i of e)this.addListener(i,t,s)}catch(e){console.warn("Base.addListeners error",e)}return this}removeListener(t,s){if(void 0!==this.__listeners[t])for(let e=0;e<this.__listeners[t].length;e++)("function"==typeof this.__listeners[t][e]&&this.__listeners[t][e].toString()===s.toString()||"object"==typeof this.__listeners[t][e]&&"function"==typeof this.__listeners[t][e].fn&&this.__listeners[t][e].fn.toString()==s.toString())&&this.__listeners[t].splice(e,1);return this}_callListeners(t){if(0<=this.constructor.EventTypes.indexOf(t)&&0<this.__listeners[t].length){const e=UsBetaSeries.logger.extend("listeners"),i=(e.debug("Base[%s] call %d Listeners on event %s",this.constructor.name,this.__listeners[t].length,t,this.__listeners),new CustomEvent("betaseries",{detail:{name:t}}));for(let e=0;e<this.__listeners[t].length;e++){var s;"function"==typeof this.__listeners[t][e]?this.__listeners[t][e].call(this,i,this):(s=this.__listeners[t][e].args,this.__listeners[t][e].fn.apply(this,[i,this].concat(s)))}}return this}hasListeners(e){return!!this.__listeners[e].length}on(e,t,...s){return this.addListener(e,t,s)}off(e){if(this.constructor.EventTypes.indexOf(e)<0)throw new Error(e+" ne fait pas partit des events gérés par cette classe");return isNull(this.__listeners[e])||delete this.__listeners[e],this}once(t,s,...e){function i(...e){this.removeEventListener(t,i),s.apply(this,e)}return i.fn=s,this.on(t,i,e),this}emit(e){return this._callListeners(e)}}class UsBetaSeries{static setDebug=Debug;static logger=new UsBetaSeries.setDebug("BS");static debug=UsBetaSeries.logger.fnDebug;static cache=null;static routes={};static generateRoute(e,t={}){if(isNull(this.routes[e])||isNull(t))return null;let s=this.routes[e],i;for(var r=/\{(\w+)\}/;!isNull(i=s.match(r));){if(isNull(t[i[1]]))throw new Error(`UsBetaSeries.generateRoute data[${i[1]}] not found`);s=s.replace(r,t[i[1]])}return s}static api={url:"https://api.betaseries.com",versions:{current:"3.0",last:"3.0"},resources:["badges","comments","episodes","friends","members","messages","movies","news","oauth","persons","pictures","planning","platforms","polls","reports","search","seasons","shows","subtitles","timeline"],check:{episodes:["display","list","search","watched"],members:["notifications"],movies:["list","movie","search","similars"],search:["all","movies","shows"],shows:["display","episodes","list","member","search","similars"]},notDisplay:["membersnotifications"],tokenRequired:{comments:{close:["POST"],comment:["POST","DELETE"],comment_event:["POST"],open:["POST"],subscription:["POST","DELETE"],thumb:["POST","DELETE"]},episodes:{downloaded:["POST","DELETE"],hidden:["POST","DELETE"],latest:["GET"],list:["GET"],next:["GET"],note:["POST","DELETE"],scraper:["GET"],search:["GET"],unrated:["GET"],watched:["POST","DELETE"]},members:{avatar:["POST","DELETE"],banner:["POST","DELETE"],delete:["POST"],destroy:["POST"],email:["GET","POST"],facebook:["POST"],is_active:["GET"],lametric:["GET"],locale:["GET"],notification:["DELETE"],notifications:["GET"],option:["POST"],options:["GET"],password:["POST"],sync:["POST"],twitter:["POST","DELETE"]},movies:{favorite:["POST","DELETE"],movie:["POST","DELETE"],note:["POST","DELETE"],scraper:["GET"]},platforms:{service:["POST","DELETE"]},shows:{archive:["POST","DELETE"],favorite:["POST","DELETE"],note:["POST","DELETE"],recommendation:["POST","DELETE","PUT"],recommendations:["GET"],show:["POST","DELETE"],tags:["POST"],unrated:["GET"]},subtitles:{report:["POST"]}}};static token=null;static userKey=null;static userId=null;static member=null;static themoviedb_api_user_key=null;static counter=0;static serverBaseUrl="";static serverOauthUrl="";static theme="light";static notification=(e,t)=>{};static userIdentified=()=>!isNull(this.token)&&!isNull(this.userId);static noop=()=>{};static trans=(e,t,s=0)=>e;static ratings=null;static gm_funcs={getValue:(e,t)=>t,setValue:(e,t)=>{}};static bsModule={};static getInstance;static checkClassname;static showLoader(){jQuery("#loader-bg").show()}static hideLoader(){jQuery("#loader-bg").hide()}static authenticate(){return UsBetaSeries.debug("authenticate"),jQuery("#containerIframe").length<=0&&jQuery("body").append(`
                    <div id="containerIframe">
                    <iframe id="userscript"
                            name="userscript"
                            title="Connexion à BetaSeries"
                            width="50%"
                            height="400"
                            src="${UsBetaSeries.serverOauthUrl}/index.html"
                            style="background:white;margin:auto;">
                    </iframe>
                    </div>'
                `),new Promise((i,r)=>{window.addEventListener("message",function e(t){var s=new URL(UsBetaSeries.serverOauthUrl).origin;if(t.origin!==s)return console.error("receiveMessage {origin: %s}",t.origin,t),void r("event.origin is not "+s);"access_token"===t.data.message?(UsBetaSeries.token=t.data.value,$("#containerIframe").remove(),i(t.data.message)):(console.error("Erreur de récuperation du token",t),r(t.data),UsBetaSeries.notification("Erreur de récupération du token","Pas de message")),window.removeEventListener("message",e,!1)},!1)})}static __checkAuthenticate=!1;static __nbNetTimeout=0;static __maxTimeout=2;static timeoutRequests=30;static callApi(o,l,c,d,h=!1){if(UsBetaSeries.api&&-1===UsBetaSeries.api.resources.indexOf(l))throw new Error(`Ressource (${l}) inconnue dans l'API.`);if(!UsBetaSeries.userKey)throw UsBetaSeries.notification("Call API","La clé API doit être renseignée"),new Error("userKey are required");if(!UsBetaSeries.token&&l in UsBetaSeries.api.tokenRequired&&c in UsBetaSeries.api.tokenRequired[l]&&1!==UsBetaSeries.api.tokenRequired[l][c].indexOf(o))throw UsBetaSeries.notification("Call API",`Identification requise pour cet appel: ${o} ${l}/`+c),new ExceptionIdentification("Identification required");const u=new UsBetaSeries.setDebug("BS:API");let i=!1,p=!0;0<=UsBetaSeries.api.notDisplay.indexOf(l+c)?p=!1:UsBetaSeries.showLoader();const m={Accept:"application/json","X-BetaSeries-Version":UsBetaSeries.api.versions.current,"X-BetaSeries-Token":UsBetaSeries.token,"X-BetaSeries-Key":UsBetaSeries.userKey},e=Object.keys(UsBetaSeries.api.check);return p&&u.debug("parameters",{type:o,resource:l,action:c,args:d,force:h}),UsBetaSeries.cache&&!h&&"GET"===o&&d&&"id"in d&&UsBetaSeries.cache.has(l,d.id)?new Promise(e=>{e(UsBetaSeries.cache.get(l,d.id)),UsBetaSeries.hideLoader()}):UsBetaSeries.__networkState===NetworkState.offline?(t=o+l+c,isNull(UsBetaSeries.__networkQueue[t])||UsBetaSeries.__networkQueue[t].reject("another request called"),s=new FakePromise(e=>e&&0<e.length?Promise.reject(e):UsBetaSeries.callApi(o,l,c,d,h).then(e=>e).catch(e=>e)),UsBetaSeries.__networkQueue[t]=s):UsBetaSeries.userIdentified()&&-1!==e.indexOf(l)&&-1!==UsBetaSeries.api.check[l].indexOf(c)&&(i=!0,UsBetaSeries.__checkAuthenticate)?(u.debug("authenticate in progress"),new Promise((t,s)=>{let i=0;(function e(){u.debug("checkAuthenticate(%d) for %s %s/%s",++i,o,l,c),UsBetaSeries.__checkAuthenticate&&UsBetaSeries.__networkState===NetworkState.online?setTimeout(e,1e3):UsBetaSeries.__networkState===NetworkState.offline?(UsBetaSeries.__checkAuthenticate=!1,s("network offline")):UsBetaSeries.__networkState===NetworkState.online?UsBetaSeries.callApi(o,l,c,d,h).then(e=>t(e)).catch(e=>s(e)):u.debug("checkAuthenticate - condition unknown",{checkAuthenticate:UsBetaSeries.__checkAuthenticate})})()})):new Promise((t,s)=>{var e;i?(UsBetaSeries.__checkAuthenticate=!0,e={method:HTTP_VERBS.GET,headers:m,mode:"cors",cache:"no-cache"},p&&u.info("%ccall /members/is_active","color:#ffc107"),fetchTimeout(UsBetaSeries.api.url+"/members/is_active",e,UsBetaSeries.timeoutRequests).ready().then(e=>{if(UsBetaSeries.__nbNetTimeout=0,UsBetaSeries.counter++,!e.ok&&400===e.status)return u.debug("authenticate for %s: %s/%s",o,l,c),void UsBetaSeries.authenticate().then(()=>{m["X-BetaSeries-Token"]=UsBetaSeries.token,UsBetaSeries.__checkAuthenticate=!1,r(t,s)}).catch(e=>s(e));e.ok?(UsBetaSeries.__checkAuthenticate=!1,r(t,s)):s(e.statusText)}).catch(e=>{if(UsBetaSeries.__checkAuthenticate=!1,console.warn("fetch members/is_active catch"),"AbortError"===e.name)return++UsBetaSeries.__nbNetTimeout>UsBetaSeries.__maxTimeout&&(u.debug("%d timeout consecutifs, Network state to offline",UsBetaSeries.__nbNetTimeout),UsBetaSeries.changeNetworkState(NetworkState.offline,!0)),void u.debug("AbortError Timeout(nb retry: %d) members/is_active",UsBetaSeries.__nbNetTimeout);"failed to fetch"===e.message.toLowerCase()?(u.debug("On déclare le réseau hors ligne. Le retour du réseau sera testé régulièrement."),UsBetaSeries.changeNetworkState(NetworkState.offline,!0)):u.debug("Il y a eu un problème avec l'opération fetch: "+e.message),console.error(e),s(e)}).finally(()=>{UsBetaSeries.__checkAuthenticate=!1})):r(t,s)});var t,s;function r(r,n){const e={method:o,headers:m,mode:"cors",cache:"no-cache"};let a=UsBetaSeries.api.url+`/${l}/`+c;var t=Object.keys(d);if("GET"===o&&0<t.length){const s=[];for(const i of t)s.push(i+"="+encodeURIComponent(d[i]));a+="?"+s.join("&")}else 0<t.length&&(e.body=new URLSearchParams(d));fetchTimeout(a,e,UsBetaSeries.timeoutRequests).ready().then(i=>{UsBetaSeries.__nbNetTimeout=0,UsBetaSeries.counter++,!p&&200===i.status||i.json().then(e=>{var t,s;return!p&&200===i.status||u.debug("fetchUri (%s %s) data",o,a,e),void 0!==e.errors&&0<e.errors.length?(t=e.errors[0].code,s=e.errors[0].text,2005===t||400===i.status&&0===t&&"L'utilisateur a déjà marqué cet épisode comme vu."===s?n("changeStatus"):2001==t?UsBetaSeries.authenticate().then(()=>{UsBetaSeries.callApi(o,l,c,d,h).then(e=>r(e),e=>n(e))},e=>{n(e)}):n(e.errors[0])):i.ok?r(e):(console.error("Fetch erreur network",i),n(i)),void UsBetaSeries.hideLoader()})}).catch(e=>{if(console.warn("fetchUri catch (%s: %s/%s)",o,l,c),"AbortError"===e.name)return++UsBetaSeries.__nbNetTimeout>UsBetaSeries.__maxTimeout&&(u.debug("%d timeout consecutifs, Network state to offline",UsBetaSeries.__nbNetTimeout),UsBetaSeries.changeNetworkState(NetworkState.offline,!0)),void u.debug("AbortError Timeout(nb retry: %d) fetchUri",UsBetaSeries.__nbNetTimeout);console.warn("fetchUri error: "+e.message),console.error(e),n(e)}).finally(()=>{UsBetaSeries.hideLoader()})}}static setPropValue(e,t,s){if(0<=t.indexOf(".")){const n=t.split("."),a=n.shift();t=n.join("."),/\[\d+\]$/.test(a)?(i=a.replace(/\[\d+\]$/,""),r=parseInt(a.replace(/[^\d]*/,""),10),UsBetaSeries.setPropValue(e[i][r],t,s)):/\[.*\]$/.test(a)?(i=a.replace(/\[.+\]$/,""),r=a.replace(/^.*\[/,"").replace(/\]$/,""),UsBetaSeries.setPropValue(e[i][r],t,s)):UsBetaSeries.setPropValue(e[a],t,s)}else{var i,r;/\[.*\]$/.test(t)?(i=t.replace(/\[.+\]$/,""),r=t.replace(/^.*\[/,"").replace(/\]$/,""),e[i][r]=s):e[t]=s}}static replaceParams(s,i,r){var n=Object.keys(i);for(let t=0;t<n.length;t++){var a=n[t],o=i[a];if(void 0===r[a])throw new Error(`Parameter[${a}] missing`);let e=r[a];"number"==o?e=parseInt(e,10):"string"==o&&(e=String(e));o=new RegExp(`#${a}#`,"g");s=s.replace(o,e)}return s}static __networkState=NetworkState.online;static networkTimeout;static __networkQueue={};static networkStateEventsFn={offline:()=>{},online:()=>{}};static changeNetworkState(e,t=!1){if(this.__networkState=e,"function"==typeof UsBetaSeries.networkStateEventsFn[NetworkState[e]]&&UsBetaSeries.networkStateEventsFn[NetworkState[e]](),e===NetworkState.online&&0<Object.keys(this.__networkQueue).length)for(const s of Reflect.ownKeys(this.__networkQueue))this.__networkQueue[s].launch();else e===NetworkState.offline&&(this.__networkQueue={},t&&checkNetwork())}}const dateFormat=function(){const m=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,g=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,f=/[^-+\dA-Z]/g,_=(e,t=2)=>String(e).padStart(t,"0"),b={default:"ddd dd mmm yyyy HH:MM:ss",datetime:"dd/mm/yyyy HH:MM",shortDate:"d/m/yy",mediumDate:"d mmm yyyy",longDate:"d mmmm yyyy",fullDate:"dddd, d mmmm yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},y={dayNames:{abr:["Dim.","Lun.","Mar.","Mer.","Jeu.","Ven.","Sam."],full:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"]},monthNames:{abr:["Jan.","Fev.","Mar.","Avr.","Mai","Juin","Juil.","Août","Sept.","Oct.","Nov.","Dec."],full:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"]}};return function(e,t,s){if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(e)||/\d/.test(e)||(t=e,e=void 0),e=e?new Date(e):new Date,isNaN(e))throw TypeError("invalid date");"UTC:"==(t=String(b[t]||t||b.default)).slice(0,4)&&(t=t.slice(4),s=!0);const i=s?"getUTC":"get",r=e[i+"Date"](),n=e[i+"Day"](),a=e[i+"Month"](),o=e[i+"FullYear"](),l=e[i+"Hours"](),c=e[i+"Minutes"](),d=e[i+"Seconds"](),h=e[i+"Milliseconds"](),u=s?0:e.getTimezoneOffset(),p={d:r,dd:_(r),ddd:y.dayNames.abr[n],dddd:y.dayNames.full[n],m:a+1,mm:_(a+1),mmm:y.monthNames.abr[a],mmmm:y.monthNames.full[a],yy:String(o).slice(2),yyyy:o,h:l%12||12,hh:_(l%12||12),H:l,HH:_(l),M:c,MM:_(c),s:d,ss:_(d),l:_(h,3),L:_(99<h?Math.round(h/10):h),t:l<12?"a":"p",tt:l<12?"am":"pm",T:l<12?"A":"P",TT:l<12?"AM":"PM",Z:s?"UTC":(String(e).match(g)||[""]).pop().replace(f,""),o:(0<u?"-":"+")+_(100*Math.floor(Math.abs(u)/60)+Math.abs(u)%60,4)};return t.replace(m,function(e){return e in p?p[e]:e.slice(1,e.length-1)})}}(),calculDuration=function(){const n=e=>{const t=new Date(e.getFullYear(),0,0);return Math.floor((e.getTime()-t.getTime())/864e5)},a={yesterday:"Hier",dayBeforeYesterday:"Avant-hier",longTime:"Il y a longtemps",days:"Il y a %days% jours",hours:"Il y a %hours% heures",minutes:"Il y a %minutes% minutes"};return function(e){const t=new Date,s=Math.round(n(t)-n(e));if(0<s)return 1===s?a.yesterday:2===s?a.dayBeforeYesterday:30<s?a.longTime:a.days.replace("%days%",s.toString());{const i=Math.round((t.getTime()-e.getTime())/6e4),r=Math.round((t.getTime()-e.getTime())/36e5);return 0===r&&0<i?a.minutes.replace("%minutes%",i.toString()):0<r?a.hours.replace("%hours%",r.toString()):void 0}}}(),upperFirst=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},camelCase=function(e){return e.replace(/[.,\/#!$%\^&\*;:][{}=\-_`~()]/g,"_").replace(/[^a-zA-Z_]/g,"").split("_").reduce((e,t,s)=>e+(s?t.upperFirst():t.toLowerCase()),"")};Date.prototype.format=function(e,t=!1){return dateFormat(this,e,t)},Date.prototype.duration=function(){return calculDuration(this)},String.prototype.upperFirst=function(){return upperFirst(this)},String.prototype.camelCase=function(){return camelCase(this)};class RenderHtml extends Base{static logger=new UsBetaSeries.setDebug("RenderHtml");static debug=RenderHtml.logger.debug.bind(RenderHtml.logger);static relatedProps={};static selectorsCSS={};__decorators={fill:new FillDecorator(this)};__elt;__initial=!0;__changes={};__props=[];constructor(e,t){return super(e),t&&(this.__elt=t),this.__initial=!0,this.__changes={},this.__props=[],this}[Symbol.iterator](){return{pos:0,props:this.__props,next(){var e;return this.pos<this.props.length?(e={value:this.props[this.pos],done:!1},this.pos++,e):{value:null,done:!(this.pos=0)}}}}fill(e){try{return this.__decorators.fill.fill.call(this,e)}catch(e){console.error(e)}}updatePropRender(e){try{this.__decorators.fill.updatePropRender.call(this,e)}catch(e){console.error(e)}}toJSON(){const e={};for(const t of this.__props)e[t]=this[t];return e}isModified(){return 0<Object.keys(this.__changes).length}getChanges(){return this.__changes}hasChange(e){if(this.__props.includes(e))return Reflect.has(this.__changes,e);throw new Error(`Property[${e}] not exists in this object(${this.constructor.name})`)}getChange(e){if(this.__props.includes(e))return this.__changes[e];throw new Error(`Property[${e}] not exists in this object(${this.constructor.name})`)}get elt(){return this.__elt}set elt(e){this.__elt=e}}class Character{static logger=new UsBetaSeries.setDebug("Character");static debug=Character.logger.debug.bind(Character.logger);static relatedProps={actor:{key:"actor",type:"string"},name:{key:"name",type:"string"},picture:{key:"picture",type:"string"},show_id:{key:"show_id",type:"number"},movie_id:{key:"movie_id",type:"number"},person_id:{key:"person_id",type:"number"}};actor;name;picture;show_id;movie_id;person_id;__decorators={fill:new FillDecorator(this)};__elt;__initial=!0;__changes={};__props=[];person;constructor(e){return this.fill(e)._initRender()}_initRender(){if(!this.elt){const i=this,e=jQuery("#actors .slides_flex .slide_flex");e.each((e,t)=>{let s=jQuery(".slide__title",t).text().trim();if((s=/&nbsp;/g.test(s)?s.replace(/&nbsp;/g,""):s)==this.actor)return Character.debug("Character._initRender: actor found",{actor:this.actor,title:s}),i.elt=jQuery(t),i.elt.attr("data-person-id",this.person_id),!1})}return this}get elt(){return this.__elt}set elt(e){this.__elt=e}fill(e){try{return this.__decorators.fill.fill.call(this,e)}catch(e){console.error(e)}}updatePropRender(e){try{this.__decorators.fill.updatePropRender.call(this,e)}catch(e){console.error(e)}}toJSON(){const e={};for(const t of this.__props)e[t]=this[t];return e}fetchPerson(){return Person.fetch(this.person_id).then(e=>(e instanceof Person&&(this.person=e),this.person)).catch(e=>(console.error("Character.fetchPerson error: ",e),null))}}class PersonMedia{static relatedProps={id:{key:"id",type:"number"},thetvdb_id:{key:"thetvdb_id",type:"number"},imdb_id:{key:"imdb_id",type:"string"},themoviedb_id:{key:"tmdb_id",type:"number"},tmdb_id:{key:"tmdb_id",type:"number"},title:{key:"title",type:"string"},seasons:{key:"seasons",type:"number"},episodes:{key:"episodes",type:"number"},followers:{key:"followers",type:"number"},creation:{key:"creation",type:"number"},production_year:{key:"creation",type:"number"},slug:{key:"slug",type:"string"},url:{key:"slug",type:"string"},poster:{key:"poster",type:"string"}};id;thetvdb_id;imdb_id;tmdb_id;title;seasons;episodes;followers;creation;slug;poster;__initial;__changes;__props;elt;__decorators={fill:new FillDecorator(this)};constructor(e){this.fill(e)}fill(e){try{return this.__decorators.fill.fill.call(this,e)}catch(e){console.error(e)}}updatePropRender(e){try{this.__decorators.fill.updatePropRender.call(this,e)}catch(e){console.error(e)}}toJSON(){const e={};for(const t of this.__props)e[t]=this[t];return e}}class PersonMedias{media;role;type;constructor(e,t){t===MediaType.show?this.media=new PersonMedia(e.show):t===MediaType.movie&&(this.media=new PersonMedia(e.movie)),this.role=e.name,this.type=t}createLink(){return UsBetaSeries.generateRoute(this.type,this.media)}getTemplate(){return`<div class="card" style="width: 18rem;">
            <img data-src="${this.media.poster}" alt="Affiche" class="js-lazy-image img-thumbnail card-img-top"/>
            <div class="card-body">
                <h5 class="card-title">(${this.media.creation}) ${this.media.title}</h5>
                <p class="card-text"><u>Personnage:</u> ${this.role}</p>
                <a href="${this.createLink()}" target="_blank" class="btn btn-primary">Voir la fiche ${this.type===MediaType.show?"de la série":"du film"}</a>
            </div>
        </div>`}}class Person{static logger=new UsBetaSeries.setDebug("Person");static debug=Character.logger.debug.bind(Character.logger);static relatedProps={id:{key:"id",type:"number"},name:{key:"name",type:"string"},birthday:{key:"birthday",type:"date"},deathday:{key:"deathday",type:"date"},description:{key:"description",type:"string"},shows:{key:"shows",type:"other",default:[],transform(e,s){if(Array.isArray(e.shows)&&e.shows.length===s.length)return e.shows;const i=[];for(let e=0,t=s.length;e<t;e++)i.push(new PersonMedias(s[e],MediaType.show));return i}},movies:{key:"movies",type:"other",default:[],transform(e,s){if(Array.isArray(e.movies)&&e.movies.length===s.length)return e.movies;const i=[];for(let e=0,t=s.length;e<t;e++)i.push(new PersonMedias(s[e],MediaType.movie));return i}},last:{key:"last",type:PersonMedias,transform(e,t){return t instanceof PersonMedias?t:t&&t.show?new PersonMedias(t,MediaType.show):t&&t.movie?new PersonMedias(t,MediaType.movie):null}}};static selectorsCSS={name:".slide__title"};static fetch(e){return UsBetaSeries.callApi(HTTP_VERBS.GET,"persons","person",{id:e}).then(e=>e?new Person(e.person):null)}id;name;birthday;deathday;description;last;shows;movies;__initial=!0;__changes={};__props=[];__decorators={fill:new FillDecorator(this)};__elt;constructor(e){return this.fill(e)._initRender()}_initRender(){if(!this.elt)return this}get elt(){return this.__elt}set elt(e){this.__elt=e}fill(e){try{return this.__decorators.fill.fill.call(this,e)}catch(e){console.error(e)}}updatePropRender(e){try{this.__decorators.fill.updatePropRender.call(this,e)}catch(e){console.error(e)}}toJSON(){const e={};for(const t of this.__props)e[t]=this[t];return e}}!function(e){e.DESC="desc",e.ASC="asc"}(OrderComments=OrderComments||{}),function(e){e.OPEN="open",e.CLOSED="close"}(MediaStatusComments=MediaStatusComments||{});class CommentsBS extends Base{static logger=new UsBetaSeries.setDebug("Comments");static debug=CommentsBS.logger.debug.bind(CommentsBS.logger);static EventTypes=[EventTypes.UPDATE,EventTypes.SAVE,EventTypes.ADD,EventTypes.ADDED,EventTypes.DELETE,EventTypes.SHOW];static sendComment(t,e){e={type:t.mediaType.singular,id:t.id,text:e};return UsBetaSeries.callApi(HTTP_VERBS.POST,"comments","comment",e).then(e=>{e=new CommentBS(e.comment,t.comments);return t.comments.addComment(e),t.comments.is_subscribed=!0,e}).catch(e=>{UsBetaSeries.notification("Commentaire","Erreur durant l'ajout d'un commentaire"),console.error(e)})}comments;nbComments;is_subscribed;status;_parent;_events;_order;_display=!1;constructor(e,t){return super({}),this.comments=[],this._parent=t,this.is_subscribed=!1,this.status=MediaStatusComments.OPEN,this.nbComments=e,this._order=OrderComments.DESC,this}init(){const i=this;function e(){const t=jQuery("#comments .slides_flex .slide_flex .slide__comment");let s;for(let e=0;e<t.length;e++)(s=jQuery(t.get(e))).attr("data-comment-id",i.comments[e].id)}var t;this.comments.length<=0&&0<this.nbComments?(t=jQuery("#comments .slides_flex .slide_flex"),this.fetchComments(t.length).then(e)):e()}toJSON(){const e={};for(const t of Reflect.ownKeys(this).filter(e=>!e.startsWith("_")))e[t]=this[t];return e}get parent(){return this._parent}set parent(e){if(!(e instanceof MediaBase))throw new TypeError('Parameter "media" in setter parent must be an instance of MediaBase');this._parent=e}get length(){return this.comments.length}get media(){return this._parent}get order(){return this._order}set order(e){this._order=e}fetchComments(i=50,r=0,e=OrderComments.DESC){e!==this._order&&(this.order=e);const n=this;return new Promise((e,t)=>{const s={type:n._parent.mediaType.singular,id:n._parent.id,nbpp:i,replies:0,order:n.order};0<r&&(s.since_id=r),UsBetaSeries.callApi(HTTP_VERBS.GET,"comments","comments",s).then(t=>{if(void 0!==t.comments){r<=0&&(n.comments=[]);for(let e=0;e<t.comments.length;e++)n.comments.push(new CommentBS(t.comments[e],n))}n.nbComments=parseInt(t.total,10),n.is_subscribed=!!t.is_subscribed,n.status=t.status,e(n)}).catch(e=>{console.warn("fetchComments",e),UsBetaSeries.notification("Récupération des commentaires","Une erreur est apparue durant la récupération des commentaires"),t(e)})})}addComment(e){const t=this.order==OrderComments.DESC?Array.prototype.unshift:Array.prototype.push;return CommentsBS.debug("addComment order: %s - method: %s",this.order,t.name),e instanceof CommentBS?t.call(this.comments,e):t.call(this.comments,new CommentBS(e,this)),this.nbComments++,this.media.nbComments++,this._callListeners(EventTypes.ADD),this}removeComment(t){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t){this.comments.splice(e,1),this.removeFromPage(t),this.nbComments--,this.media.nbComments--,this._callListeners("delete");break}return this}isFirst(e){return this.comments[0].id===e}isLast(e){return this.comments[this.comments.length-1].id===e}isOpen(){return this.status===MediaStatusComments.OPEN}getComment(t){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t)return this.comments[e];return null}getPrevComment(t){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t&&0<e)return this.comments[e-1];return null}getNextComment(t){var s=this.comments.length;for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t&&e<s-1)return this.comments[e+1];return null}async fetchReplies(e,t=OrderComments.ASC){var s=await UsBetaSeries.callApi(HTTP_VERBS.GET,"comments","replies",{id:e,order:t});const i=[];if(s.comments)for(let e=0;e<s.comments.length;e++)i.push(new CommentBS(s.comments[e],this));return i}changeThumbs(t,s,i){for(let e=0;e<this.comments.length;e++)if(this.comments[e].id===t)return this.comments[e].thumbs=s,this.comments[e].thumbed=i,!0;return!1}async getTemplate(i){const r=this;return new Promise((e,t)=>{let s=Promise.resolve(r);CommentsBS.debug("Base ",{length:r.comments.length,nbComments:r.nbComments}),r.comments.length<=0&&0<r.nbComments&&(CommentsBS.debug("Base fetchComments call"),s=r.fetchComments(i)),s.then(async()=>{let t,s=`
                        <div data-media-type="${r._parent.mediaType.singular}"
                            data-media-id="${r._parent.id}"
                            class="displayFlex flexDirectionColumn"
                            style="margin-top: 2px; min-height: 0">`;UsBetaSeries.userIdentified()&&(s+=`
                    <button type="button" class="btn-reset btnSubscribe" style="position: absolute; top: 3px; right: 31px; padding: 8px;">
                        <span class="svgContainer">
                            <svg></svg>
                        </span>
                    </button>`),s+='<div class="comments overflowYScroll">';for(let e=0;e<r.comments.length;e++){t=r.comments[e],s+=CommentBS.getTemplateComment(t),0<t.nbReplies&&t.replies.length<=0&&(CommentsBS.debug("Comments render getTemplate fetchReplies"),await t.fetchReplies());for(let e=0;e<t.replies.length;e++)s+=CommentBS.getTemplateComment(t.replies[e])}r.comments.length<r.nbComments&&(s+=`
                        <button type="button" class="btn-reset btn-greyBorder moreComments" style="margin-top: 10px; width: 100%;">
                            ${UsBetaSeries.trans("timeline.comments.display_more")}
                            <i class="fa-solid fa-cog fa-spin fa-2x" style="display:none;margin-left:15px;vertical-align:middle;"></i>
                            <span class="sr-only">Loading...</span>
                        </button>`),s+="</div>",r.isOpen()&&UsBetaSeries.userIdentified()&&(s+=CommentBS.getTemplateWriting()),e(s+"</div>")}).catch(e=>{t(e)})})}getLogins(){const t=[];for(let e=0;e<this.comments.length;e++)t.includes(this.comments[e].login)||t.push(this.comments[e].login);return t}updateCounter(){const e=jQuery("#comments .blockTitle");e.text(e.text().replace(/\d+/,this.nbComments.toString()))}loadEvents(h,u,p){this._events=[];async function m(t){var s=parseInt(t.data("commentId"),10);let i;if(t.hasClass("reply")){let e=t.prev();for(;e.hasClass("reply");)e=e.prev();t=parseInt(e.data("commentId"),10);if(s==t)i=g.getComment(s);else{const r=g.getComment(t);i=await r.getReply(s)}}else i=g.getComment(s);return i}const g=this,s=jQuery("#popin-dialog"),e=jQuery("#popin-showClose"),t=(e.on("click",()=>{p.hidePopup(),s.removeAttr("data-popin-type")}),this._events.push({elt:e,event:"click"}),h.find(".toggleAllReplies")),i=(t.on("click",e=>{const t=jQuery(e.currentTarget);e=t.attr("data-toggle");const s=h.find(`.toggleReplies[data-toggle="${e}"]`);"1"==e?(s.trigger("click"),t.attr("data-toggle","0"),t.text("Afficher toutes les réponses")):(s.trigger("click"),t.attr("data-toggle","1"),t.text("Masquer toutes les réponses"))}),this._events.push({elt:t,event:"click"}),h.find(".btnSubscribe"));function r(e){g.is_subscribed?g.is_subscribed&&(e.addClass("active"),e.attr("title","Ne plus recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg width="20" height="22" viewBox="0 0 20 22" style="width: 17px;">
                        <g transform="translate(-4)" fill="none">
                            <path d="M0 0h24v24h-24z"></path>
                            <path fill="${"dark"==UsBetaSeries.theme?"rgba(255, 255, 255, .5)":"#333"}" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32v-.68c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68c-2.87.68-4.5 3.24-4.5 6.32v5l-2 2v1h16v-1l-2-2z"></path>
                        </g>
                    </svg>
                `)):(e.removeClass("active"),e.attr("title","Recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg fill="${"dark"==UsBetaSeries.theme?"rgba(255, 255, 255, .5)":"#333"}" width="14" height="16" style="position: relative; top: 1px; left: -1px;">
                        <path fill-rule="nonzero" d="M13.176 13.284L3.162 2.987 1.046.812 0 1.854l2.306 2.298v.008c-.428.812-.659 1.772-.659 2.806v4.103L0 12.709v.821h11.307l1.647 1.641L14 14.13l-.824-.845zM6.588 16c.914 0 1.647-.73 1.647-1.641H4.941c0 .91.733 1.641 1.647 1.641zm4.941-6.006v-3.02c0-2.527-1.35-4.627-3.705-5.185V1.23C7.824.55 7.272 0 6.588 0c-.683 0-1.235.55-1.235 1.23v.559c-.124.024-.239.065-.346.098a2.994 2.994 0 0 0-.247.09h-.008c-.008 0-.008 0-.017.009-.19.073-.379.164-.56.254 0 0-.008 0-.008.008l7.362 7.746z"></path>
                    </svg>
                `))}i.on("click",e=>{if(e.stopPropagation(),e.preventDefault(),UsBetaSeries.userIdentified()){const t=$(e.currentTarget);e={type:g._parent.mediaType.singular,id:g._parent.id};t.hasClass("active")?UsBetaSeries.callApi(HTTP_VERBS.DELETE,"comments","subscription",e).then(()=>{g.is_subscribed=!1,r(t)}):UsBetaSeries.callApi(HTTP_VERBS.POST,"comments","subscription",e).then(()=>{g.is_subscribed=!0,r(t)})}else faceboxDisplay("inscription",{},()=>{})}),r(i),this._events.push({elt:i,event:"click"});const n=h.find(".view-spoiler"),a=(0<n.length&&n.on("click",e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget),s=t.next(".comment-text").find(".spoiler");s.is(":visible")?(s.fadeOut("fast"),t.text("Voir le spoiler")):(s.fadeIn("fast"),t.text("Cacher le spoiler"))}),this._events.push({elt:n,event:"click"}),h.find(".comments .comment .btnThumb")),o=(a.on("click",async i=>{if(i.stopPropagation(),i.preventDefault(),UsBetaSeries.userIdentified()){const n=jQuery(i.currentTarget),a=n.parents(".comment");i=parseInt(a.data("commentId"),10);let t;if(a.hasClass("reply")){let e=a.prev();for(;e.hasClass("reply");)e=e.prev();var r=parseInt(e.data("commentId"),10);if(i==r)t=this.getComment(i);else{const l=this.getComment(r);t=await l.getReply(i)}}else t=this.getComment(i);let e=HTTP_VERBS.POST;const o=n.hasClass("btnUpVote")?1:-1;let s={id:i,type:o,switch:!1};if(t.thumbed==o)e=HTTP_VERBS.DELETE,s={id:i};else if(0!=t.thumbed)return void console.warn("Le vote est impossible. Annuler votre vote et recommencer");UsBetaSeries.callApi(e,"comments","thumb",s).then(e=>{t.thumbs=parseInt(e.comment.thumbs,10),t.thumbed=e.comment.thumbed?parseInt(e.comment.thumbed,10):0,t.updateRenderThumbs(o)}).catch(e=>{e=void 0!==e.text?e.text:e;UsBetaSeries.notification("Thumb commentaire","Une erreur est apparue durant le vote: "+e)})}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:a,event:"click"}),h.find(".btnToggleOptions")),l=(o.on("click",e=>{e.stopPropagation(),e.preventDefault(),jQuery(e.currentTarget).parents(".actionsCmt").first().find(".options-comment").each((e,t)=>{const s=jQuery(t);s.is(":visible")?s.hide():s.show()})}),this._events.push({elt:o,event:"click"}),h.find(".sendComment")),c=(l.on("click",async t=>{if(t.stopPropagation(),t.preventDefault(),UsBetaSeries.userIdentified()){var i=function(e){return jQuery(t.currentTarget).parents(".writing").prev(".comments").find(`.comment[data-comment-id="${e.toString()}"]`)};const o=$(t.currentTarget).siblings("textarea");if(0<o.val().length){var r=o.data("action"),n=o.val();let e,s;if(o.data("replyTo")){var a=parseInt(o.data("replyTo"),10);e=g.getComment(a);const l=i(a);s=e.sendReply(o.val()).then(s=>{if(s instanceof CommentBS){o.val(""),o.siblings("button").attr("disabled","true"),o.removeAttr("data-reply-to");s=CommentBS.getTemplateComment(s);if(l.next(".comment").hasClass("reply")){let e=l.next(".comment"),t;for(;e.hasClass("reply");)e=(t=e).next(".comment");t.after(s)}else l.after(s)}})}else if(r&&"edit"===r){const c=parseInt(o.data("commentId"),10);let t=i(c);const d=await m(t);s=d.edit(n).then(e=>{t.find(".comment-text").text(e.text),(t=jQuery(`#comments .slide_flex .slide__comment[data-comment-id="${c}"]`)).find("p").text(e.text),o.removeAttr("data-action"),o.removeAttr("data-comment-id"),o.val(""),o.siblings("button").attr("disabled","true")})}else s=CommentsBS.sendComment(g._parent,o.val()).then(e=>{if(e){o.val(""),o.siblings("button").attr("disabled","true");const t=o.parents(".writing").prev(".comments");this.order===OrderComments.DESC?t.prepend(CommentBS.getTemplateComment(e)):t.append(CommentBS.getTemplateComment(e)),t.find(`.comment[data-comment-id="${e.id}"]`).get(0).scrollIntoView(),g.addToPage(e.id)}});s.then(()=>{g.cleanEvents(()=>{g.loadEvents(h,u,p)})})}}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:l,event:"click"}),h.find("textarea")),d=(c.on("keypress",e=>{const t=$(e.currentTarget);0<t.val().length?t.siblings("button").removeAttr("disabled"):t.siblings("button").attr("disabled","true")}),this._events.push({elt:c,event:"keypress"}),h.find(".baliseSpoiler")),f=(d.on("click",()=>{const e=s.find("textarea");var t;/\[spoiler\]/.test(e.val())||(t="[spoiler]"+e.val()+"[/spoiler]",e.val(t))}),this._events.push({elt:d,event:"click"}),h.find(".comments .toggleReplies")),_=(f.on("click",e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget);e=t.attr("data-toggle");const s=t.parents(".comment");var i=s.data("commentInner");const r=s.parents(".comments").find(`.comment[data-comment-reply="${i}"]`);"0"==e?(r.fadeIn("fast"),t.find(".btnText").text(UsBetaSeries.trans("comment.hide_answers")),t.find("svg").attr("style","transition: transform 200ms ease 0s; transform: rotate(180deg);"),t.attr("data-toggle","1")):(r.fadeOut("fast"),t.find(".btnText").text(UsBetaSeries.trans("comment.button.reply",{"%count%":r.length.toString()},r.length)),t.find("svg").attr("style","transition: transform 200ms ease 0s;"),t.attr("data-toggle","0"))}),this._events.push({elt:f,event:"click"}),h.find(".btnResponse")),b=(_.on("click",async e=>{if(e.stopPropagation(),e.preventDefault(),UsBetaSeries.userIdentified()){const t=$(e.currentTarget);e=t.parents(".comment"),e=await m(e);h.find("textarea").val("@"+e.login).attr("data-reply-to",e.id)}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:_,event:"click"}),h.find(".moreComments")),y=(b.on("click",e=>{e.stopPropagation(),e.preventDefault();const i=jQuery(e.currentTarget);if(g.comments.length>=g.nbComments)i.hide();else{const t=i.find(".fa-spin");t.show();e=g.comments[g.comments.length-1].id;const r=g.comments.length-1;g.fetchComments(u,e).then(async()=>{let t="",s;const e=g.comments[1+r].id;for(let e=1+r;e<g.comments.length;e++){s=g.comments[e],t+=CommentBS.getTemplateComment(s),0<s.nbReplies&&s.replies.length<=0&&(s.replies=await g.fetchReplies(s.id));for(let e=0;e<s.replies.length;e++)t+=CommentBS.getTemplateComment(s.replies[e])}i.before(t),jQuery(`.comment[data-comment-id="${e.toString()}"]`).get(0).scrollIntoView(),g.cleanEvents(()=>{g.loadEvents(h,u,p)}),g.comments.length>=g.nbComments&&i.hide()}).finally(()=>{t.hide()})}}),this._events.push({elt:b,event:"click"}),h.find(".btnEditComment")),v=(y.on("click",async e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget).parents(".comment");var e=parseInt(t.data("commentId"),10),s=await m(t);c.val(s.text),c.attr("data-action","edit"),c.attr("data-comment-id",e)}),this._events.push({elt:y,event:"click"}),h.find(".btnDeleteComment"));v.on("click",async e=>{e.stopPropagation(),e.preventDefault();const i=jQuery(e.currentTarget).parents(".comment"),t=jQuery(e.currentTarget).parents(".options-options");t.hide().after(`
                <div class="options-delete">
                    <span class="mainTime">Supprimer mon commentaire :</span>
                    <button type="button" class="btn-reset fontWeight700 btnYes" style="vertical-align: 0px; padding-left: 10px; padding-right: 10px; color: rgb(208, 2, 27);">Oui</button>
                    <button type="button" class="btn-reset mainLink btnNo" style="vertical-align: 0px;">Non</button>
                </div>
            `);const s=i.find(".options-delete .btnYes"),r=i.find(".options-delete .btnNo"),n=await m(i);s.on("click",e=>{e.stopPropagation(),e.preventDefault(),n.delete();let t=i.next(".comment"),s;for(;t.hasClass("reply");)t=(s=t).next(".comment"),s.remove();i.remove(),g.updateCounter()}),r.on("click",e=>{e.stopPropagation(),e.preventDefault(),i.find(".options-delete").remove(),t.show(),s.off("click"),r.off("click")})}),this._events.push({elt:v,event:"click"}),this._callListeners(EventTypes.SHOW)}cleanEvents(e=UsBetaSeries.noop){if(this._events&&0<this._events.length){let t;for(let e=0;e<this._events.length;e++)0<(t=this._events[e]).elt.length&&t.elt.off(t.event)}this._events=[],e()}render(){CommentsBS.debug("CommentsBS render");const t=this,s=jQuery("#popin-dialog"),e=s.find(".popin-content-html"),i=s.find(".popin-content-reactmodule"),r=s.find("#popin-showClose"),n=()=>{document.body.style.overflow="visible",document.body.style.paddingRight="",s.attr("aria-hidden","true"),s.find("#popupalertyes").show(),s.find("#popupalertno").show(),e.hide(),i.empty(),t.cleanEvents()},a=()=>{document.body.style.overflow="hidden",document.body.style.paddingRight=getScrollbarWidth()+"px",s.find("#popupalertyes").hide(),s.find("#popupalertno").hide(),e.hide(),i.show(),r.show(),s.attr("aria-hidden","false")},o=(i.empty().append(`<div class="title" id="dialog-title" tabindex="0">${UsBetaSeries.trans("blog.title.comments")}</div>`),i.find(".title"));o.append('<button type="button" class="btn-primary toggleAllReplies" data-toggle="1" style="border-radius:4px;margin-left:10px;">Cacher toutes les réponses</button>');let l=`
            <div class="loaderCmt">
                <svg class="sr-only">
                    <defs>
                        <clipPath id="placeholder">
                            <path d="M50 25h160v8H50v-8zm0-18h420v8H50V7zM20 40C8.954 40 0 31.046 0 20S8.954 0 20 0s20 8.954 20 20-8.954 20-20 20z"></path>
                        </clipPath>
                    </defs>
                </svg>
        `;for(let e=0;e<4;e++)l+=`
                <div class="er_ex null"><div class="ComponentPlaceholder er_et " style="height: 40px;"></div></div>`;i.append(l+"</div>"),a();t.getTemplate(20).then(e=>{s.attr("data-popin-type","comments"),i.fadeOut("fast",()=>{i.find(".loaderCmt").remove(),i.append(e),i.fadeIn(),t.cleanEvents(),t.loadEvents(i,20,{hidePopup:n,showPopup:a})})})}addToPage(e){const t=this.getComment(e);var e=t.text.substring(0,210),s=t.isSpoiler();let i="",r=`<p>${e} ${i=210<t.text.length?'<span class="u-colorWhiteOpacity05 u-show-fulltext positionRelative zIndex1"></span><span class="sr-only">'+t.text.substring(210)+"</span>":i}</p>`;s&&(r=`<button class="btn-reset spoilerWrapper js-display-spoiler">
                <span class="spoiler__inner">
                    <span class="fake-p">
                        Ce commentaire contient un spoiler.
                    </span>
                    <span class="btn-semiTransparent">
                        ${UsBetaSeries.trans("show.comment.show_spoiler")}
                    </span>
                </span>
            </button>
            <p>${e}</p>`);s=t.avatar||"https://img.betaseries.com/NkUiybcFbxbsT_EnzkGza980XP0=/42x42/smart/https%3A%2F%2Fwww.betaseries.com%2Fimages%2Fsite%2Favatar-default.png",e=`
            <div class="slide_flex">
                <div class="slide__comment positionRelative u-insideBorderOpacity u-insideBorderOpacity--01" data-comment-id="${t.id}">
                    ${r}
                    <button type="button" class="btn-reset js-popup-comments zIndex10" data-comment-id="${t.id}"></button>
                </div>
                <div class="slide__author">
                    <div class="media">
                        <span class="media-left avatar">
                            <a href="https://www.betaseries.com/membre/${t.login}">
                                <img class="u-opacityBackground" src="${s}" width="42" height="42" alt="avatar de ${t.login}" />
                            </a>
                        </span>
                        <div class="media-body">
                            <div class="displayFlex alignItemsCenter">
                                ${t.login}
                                <span class="stars">${Note.renderStars(t.user_note,t.user_id===UsBetaSeries.userId?"blue":"")}</span>
                            </div>
                            <div>
                                <time class="u-colorWhiteOpacity05" style="font-size: 14px;">
                                    ${t.date.format("dd mmmm yyyy")}
                                </time>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;jQuery("#comments .slides_flex").prepend(e),jQuery("#comments .blockTitle").text(jQuery("#comments .blockTitle").text().replace(/\d+/,this._parent.nbComments.toString())),this._callListeners(EventTypes.ADDED)}removeFromPage(e){const t=jQuery(`#comments .slides_flex .slide__comment[data-comment-id="${e}"]`);t.parents(".slide_flex").remove()}showEvaluations(){const a=this;var e={type:this.media.mediaType.singular,id:this.media.id,replies:1,nbpp:this.media.nbComments};return UsBetaSeries.callApi(HTTP_VERBS.GET,"comments","comments",e).then(e=>{let t=e.comments||[];t=t.filter(e=>0<e.user_note);const s={1:0,2:0,3:0,4:0,5:0},i=[];let r=0;for(let e=0;e<t.length;e++)i.includes(t[e].user_id)||(i.push(t[e].user_id),r++,s[t[e].user_note]++);let n=`
                <div class="evaluations">
                    <div class="size-base">${this.media.objNote.total} évaluation${1<this.media.objNote.total?"s":""} dont ${r} parmis les commentaires</div>
                    <div class="size-base average">Note globale: <strong>${a._parent.objNote.mean.toFixed(2)}</strong></div>
                    <div><table><tbody>`;for(let e=5;0<e;e--)n+=function(e,t){const s=0<r?100*t[e]/r:0;return`<tr class="histogram-row">
                    <td class="nowrap">${e} étoile${1<e?"s":""}</td>
                    <td class="span10">
                        <div class="meter" role="progressbar" aria-valuenow="${s.toFixed(1)}%">
                            <div class="meter-filled" style="width: ${s.toFixed(1)}%"></div>
                        </div>
                    </td>
                    <td class="nowrap">${s.toFixed(1)}%</td>
                </tr>`}(e,s);return n+'</tbody></table><p class="alert alert-info"><small>Les pourcentages sont calculés uniquement sur les évaluations dans les commentaires.</small></p></div>'})}}!function(e){e[e.hidden=0]="hidden",e[e.page=1]="page",e[e.collection=2]="collection",e[e.alone=3]="alone"}(TypeDisplayComment=TypeDisplayComment||{});class CommentBS extends Base{static logger=new UsBetaSeries.setDebug("Comments:Comment");static debug=CommentBS.logger.debug.bind(CommentBS.logger);static relatedProps={id:{key:"id",type:"number"},reference:{key:"reference",type:"string"},type:{key:"type",type:"string"},ref_id:{key:"ref_id",type:"number"},user_id:{key:"user_id",type:"number"},login:{key:"login",type:"string"},avatar:{key:"avatar",type:"string"},date:{key:"date",type:"date"},text:{key:"text",type:"string"},inner_id:{key:"inner_id",type:"number"},in_reply_to:{key:"in_reply_to",type:"number"},in_reply_id:{key:"in_reply_id",type:"number"},in_reply_user:{key:"in_reply_user",type:"object"},user_note:{key:"user_note",type:"number",default:0},thumbs:{key:"thumbs",type:"number"},thumbed:{key:"thumbed",type:"number",default:0},replies:{key:"nbReplies",type:"number",default:0},from_admin:{key:"from_admin",type:"boolean",default:!1},user_rank:{key:"user_rank",type:"string"}};static EventTypes=[EventTypes.UPDATE,EventTypes.SAVE,EventTypes.ADD,EventTypes.SHOW,EventTypes.HIDE,EventTypes.DELETE];static classNamesCSS={reply:"it_i3",actions:"it_i1",comment:"it_ix"};id;reference;type;ref_id;user_id;login;avatar;date;text;inner_id;in_reply_to;in_reply_id;in_reply_user;user_note;thumbs;thumbed;nbReplies;replies;from_admin;user_rank;_typeDisplay=TypeDisplayComment.hidden;_parent;_events;__decorators={fill:new FillDecorator(this)};__elt;__initial=!0;__changes={};__props=[];constructor(e,t){return super(e),this._parent=t,this.replies=[],this.fill(e).init()}init(){var e=`#comments .slides_flex .slide_flex .slide__comment[data-comment-id="${this.id}"]`;const t=jQuery(e);return 0<t.length&&(this.elt=t.parents(".slide_flex")),this}get elt(){return this.__elt}set elt(e){this.__elt=e}get parent(){return this._parent}set parent(e){if(!(e instanceof CommentsBS||e instanceof CommentBS))throw new TypeError('Paremeter "parent" must be an instance of CommentsBS or CommentBS');this._parent=e}fill(e){try{return this.__decorators.fill.fill.call(this,e)}catch(e){console.error(e)}}updatePropRender(e){try{this.__decorators.fill.updatePropRender.call(this,e)}catch(e){console.error(e)}}toJSON(){const e={};for(const t of this.__props)e[t]=this[t];return e}async fetchReplies(e=OrderComments.ASC){if(this.nbReplies<=0)return this;var s=await UsBetaSeries.callApi(HTTP_VERBS.GET,"comments","replies",{id:this.id,order:e},!0);if(s.comments)for(let e=0,t=s.comments.length;e<t;e++)this.replies[e]&&this.replies[e].id==s.comments[e].id?this.replies[e].fill(s.comments[e]):this.replies.push(new CommentBS(s.comments[e],this));return this}sortReplies(s=OrderComments.ASC){return this.replies.sort((e,t)=>s===OrderComments.ASC?e.inner_id<t.inner_id?-1:e.inner_id>t.inner_id?1:0:t.inner_id<e.inner_id?-1:t.inner_id>e.inner_id?1:0),this.replies}edit(e){const t=this;this.text=e;e={edit_id:this.id,text:e};return UsBetaSeries.callApi(HTTP_VERBS.POST,"comments","comment",e).then(e=>t.fill(e.comment))}delete(){const e=this,t=[];if(0<this.nbReplies)for(let e=0;e<this.replies.length;e++)t.push(UsBetaSeries.callApi(HTTP_VERBS.DELETE,"comments","comment",{id:this.replies[e].id}));Promise.all(t).then(()=>{UsBetaSeries.callApi(HTTP_VERBS.DELETE,"comments","comment",{id:this.id}).then(()=>{e._parent instanceof CommentsBS?e._parent.removeComment(e.id):e._parent instanceof CommentBS&&e._parent.removeReply(e.id),e.getCollectionComments().nbComments=e.getCollectionComments().nbComments-(t.length+1)})})}isFirst(){return this._parent.isFirst(this.id)}isLast(){return this._parent.isLast(this.id)}isSpoiler(){return/\[spoiler\]/.test(this.text)}static getTemplateComment(e){let t=new Option(e.text).innerHTML;/@\w+/.test(t)&&(t=t.replace(/@(\w+)/g,'<a href="/membre/$1" class="mainLink mainLink--regular">@$1</a>'));var s=e.isSpoiler()?`<button type="button" class="btn-reset mainLink view-spoiler">${UsBetaSeries.trans("comment.button.display_spoiler")}</button>`:"",i=(t=t.replace(/\[spoiler\](.*)\[\/spoiler\]/g,'<span class="spoiler" style="display:none">$1</span>'),0<e.in_reply_to),r=i?CommentBS.classNamesCSS.reply+" reply ":"",n=0<e.nbReplies?`
            <button type="button" class="btn-reset mainLink mainLink--regular toggleReplies" data-toggle="1">
                <span class="svgContainer">
                    <svg width="8" height="6" xmlns="http://www.w3.org/2000/svg" style="transition: transform 200ms ease 0s; transform: rotate(180deg);">
                        <path d="M4 5.667l4-4-.94-.94L4 3.78.94.727l-.94.94z" fill="#54709D" fill-rule="nonzero"></path>
                    </svg>
                </span>&nbsp;<span class="btnText">${UsBetaSeries.trans("comment.hide_answers")}</span>
            </button>`:"";let a=`
            <a href="/messages/nouveau?login=${e.login}" class="mainLink">Envoyer un message</a>
            <span class="mainLink">∙</span>
            <button type="button" class="btn-reset mainLink btnSignal">Signaler</button>
        `,o=(e.user_id===UsBetaSeries.userId&&(a=`
                <button type="button" class="btn-reset mainLink btnEditComment">Éditer</button>
                <span class="mainLink">∙</span>
                <button type="button" class="btn-reset mainLink btnDeleteComment">Supprimer</button>
            `),`<span class="mainLink">&nbsp;∙&nbsp;</span><button type="button" class="btn-reset mainLink mainLink--regular btnResponse" ${UsBetaSeries.userIdentified()?"":'style="display:none;"'}>${UsBetaSeries.trans("timeline.comment.reply")}</button>`);return i&&(o=""),`
            <div class="comment ${r}positionRelative ${CommentBS.classNamesCSS.comment}" data-comment-id="${e.id}" ${0<e.in_reply_to?'data-comment-reply="'+e.in_reply_to+'"':""} data-comment-inner="${e.inner_id}">
                <div class="media">
                    <div class="media-left">
                        <a href="/membre/${e.login}" class="avatar">
                            <img src="https://api.betaseries.com/pictures/members?key=${UsBetaSeries.userKey}&amp;id=${e.user_id}&amp;width=64&amp;height=64&amp;placeholder=png" width="32" height="32" alt="Profil de ${e.login}">
                        </a>
                    </div>
                    <div class="media-body">
                        <a href="/membre/${e.login}">
                            <span class="mainLink">${e.login}</span>
                        </a>
                        ${s}
                        <span class="comment-text">${t}</span>
                        <div class="${CommentBS.classNamesCSS.actions} actionsCmt">
                            <div class="options-main options-comment">
                                <button type="button" class="btn-reset btnUpVote btnThumb" title="+1 pour ce commentaire">
                                    <svg data-disabled="false" class="SvgLike" fill="#fff" width="16" height="14" viewBox="0 0 16 14" xmlns="http://www.w3.org/2000/svg">
                                        <g fill="${0<e.thumbed?"#FFAC3B":"inherit"}" fill-rule="nonzero">
                                            <path fill="#fff" fill-rule="evenodd" d="M.67 6h2.73v8h-2.73v-8zm14.909.67c0-.733-.614-1.333-1.364-1.333h-4.302l.648-3.047.02-.213c0-.273-.116-.527-.3-.707l-.723-.7-4.486 4.393c-.252.24-.402.573-.402.94v6.667c0 .733.614 1.333 1.364 1.333h6.136c.566 0 1.05-.333 1.255-.813l2.059-4.7c.061-.153.095-.313.095-.487v-1.273l-.007-.007.007-.053z"></path>
                                            <path class="SvgLikeStroke" stroke="#54709D" d="M1.17 6.5v7h1.73v-7h-1.73zm13.909.142c-.016-.442-.397-.805-.863-.805h-4.92l.128-.604.639-2.99.018-.166c0-.13-.055-.257-.148-.348l-.373-.361-4.144 4.058c-.158.151-.247.355-.247.578v6.667c0 .455.387.833.864.833h6.136c.355 0 .664-.204.797-.514l2.053-4.685c.04-.1.06-.198.06-.301v-1.063l-.034-.034.034-.265z"></path>
                                        </g>
                                    </svg>
                                </button>
                                <button type="button" class="btn-reset btnDownVote btnThumb" title="-1 pour ce commentaire">
                                    <svg data-disabled="false" class="SvgLike" fill="#fff" width="16" height="14" viewBox="0 0 16 14" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(180deg) scaleX(-1); margin-left: 4px; vertical-align: -4px;">
                                        <g fill="${e.thumbed<0?"#FFAC3B":"inherit"}" fill-rule="nonzero">
                                            <path fill="#fff" fill-rule="evenodd" d="M.67 6h2.73v8h-2.73v-8zm14.909.67c0-.733-.614-1.333-1.364-1.333h-4.302l.648-3.047.02-.213c0-.273-.116-.527-.3-.707l-.723-.7-4.486 4.393c-.252.24-.402.573-.402.94v6.667c0 .733.614 1.333 1.364 1.333h6.136c.566 0 1.05-.333 1.255-.813l2.059-4.7c.061-.153.095-.313.095-.487v-1.273l-.007-.007.007-.053z"></path>
                                            <path class="SvgLikeStroke" stroke="#54709D" d="M1.17 6.5v7h1.73v-7h-1.73zm13.909.142c-.016-.442-.397-.805-.863-.805h-4.92l.128-.604.639-2.99.018-.166c0-.13-.055-.257-.148-.348l-.373-.361-4.144 4.058c-.158.151-.247.355-.247.578v6.667c0 .455.387.833.864.833h6.136c.355 0 .664-.204.797-.514l2.053-4.685c.04-.1.06-.198.06-.301v-1.063l-.034-.034.034-.265z"></path>
                                        </g>
                                    </svg>
                                </button>
                                <strong class="mainLink thumbs${e.thumbs<0?" negative":0<e.thumbs?" positive":""}">${0<e.thumbs?"+"+e.thumbs:e.thumbs}</strong>
                                ${o}
                                <span class="mainLink">∙</span>
                                <span class="mainTime">Le ${e.date.format("dd/mm/yyyy HH:MM")}</span>
                                <span class="stars" title="${e.user_note} / 5">
                                    ${Note.renderStars(e.user_note,e.user_id===UsBetaSeries.userId?"blue":"")}
                                </span>
                                <div class="it_iv">
                                    <button type="button" class="btn-reset btnToggleOptions">
                                        <span class="svgContainer">
                                            <svg width="4" height="16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="transform: rotate(90deg);">
                                                <defs>
                                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" id="svgthreedots"></path>
                                                </defs>
                                                <use fill="${"dark"===UsBetaSeries.theme?"rgba(255, 255, 255, .5)":"#333"}" fill-rule="nonzero" xlink:href="#svgthreedots" transform="translate(-10 -4)"></use>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            <div class="options-options options-comment" style="display:none;">
                                ${a}
                                <button type="button" class="btn-reset btnToggleOptions">
                                    <span class="svgContainer">
                                        <svg fill="${"dark"===UsBetaSeries.theme?"rgba(255, 255, 255, .5)":"#333"}" width="9" height="9" viewBox="0 0 14 14" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M14 1.41l-1.41-1.41-5.59 5.59-5.59-5.59-1.41 1.41 5.59 5.59-5.59 5.59 1.41 1.41 5.59-5.59 5.59 5.59 1.41-1.41-5.59-5.59z"></path>
                                        </svg>
                                    </span>
                                </button>
                            </div>
                        </div>
                        ${n}
                    </div>
                </div>
            </div>
        `}static getTemplateWriting(e){var t=UsBetaSeries.userIdentified()?currentLogin:"";let s="",i=UsBetaSeries.trans("timeline.comment.write");return e&&(s=` data-reply-to="${e.id}"`,i="Ecrivez une réponse à ce commentaire"),`
            <div class="writing">
                <div class="media">
                    <div class="media-left">
                        <div class="avatar">
                            <img src="https://api.betaseries.com/pictures/members?key=${UsBetaSeries.userKey}&amp;id=${UsBetaSeries.userId}&amp;width=32&amp;height=32&amp;placeholder=png" width="32" height="32" alt="Profil de ${t}">
                        </div>
                    </div>
                    <div class="media-body">
                        <form class="gz_g1">
                            <textarea rows="2" placeholder="${i}" class="form-control"${s}></textarea>
                            <button class="btn-reset sendComment" disabled="" aria-label="${UsBetaSeries.trans("comment.send.label")}" title="${UsBetaSeries.trans("comment.send.label")}">
                                <span class="svgContainer" style="width: 16px; height: 16px;">
                                    <svg fill="${"dark"===UsBetaSeries.theme?"#fff":"#333"}" width="15" height="12" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M.34 12l13.993-6L.34 0 .333 4.667l10 1.333-10 1.333z"></path>
                                    </svg>
                                </span>
                            </button>
                        </form>
                        <p class="mainTime">Utilisez la balise <span class="baliseSpoiler" title="Ajouter la balise spoiler à votre commentaire">[spoiler]…[/spoiler]</span> pour masquer le contenu pouvant spoiler les lecteurs.</p>
                    </div>
                </div>
            </div>
        `}static getTemplateReport(e){return`
            <form class="form-middle" method="POST" action="/apps/report.php">
                <fieldset>
                    <div class="title" id="dialog-title" tabindex="0">Signaler un commentaire</div>
                    <p>Vous êtes sur le point de signaler un commentaire, veuillez indiquer ci-dessous la raison de ce signalement.</p>
                    <div>
                        <textarea class="form-control" name="texte"></textarea>
                    </div>
                    <div class="button-set">
                        <button class="js-close-popupalert btn-reset btn-btn btn-blue2" type="submit" id="popupalertyes">Signaler le contenu</button>
                    </div>
                </fieldset>
                <input type="hidden" name="id" value="${e.id}">
                <input type="hidden" name="type" value="comment">
            </form>`}getLogins(){const t=[];t.push(this.login);for(let e=0;e<this.replies.length;e++)t.includes(this.replies[e].login)||t.push(this.replies[e].login);return t}updateRenderThumbs(e=0){const t=jQuery(`.comments .comment[data-comment-id="${this.id}"] .thumbs`);var s=parseInt(t.text(),10);const i=e==this.thumbed?s+e:s-e;s=0<i?"+"+i:i.toString();if(t.text(s),0==this.thumbed)t.siblings(".btnThumb").find("g").attr("fill","inherited");else{const r=0<this.thumbed?t.siblings(".btnThumb.btnUpVote"):t.siblings(".btnThumb.btnDownVote");r.find("g").attr("fill","#FFAC3B")}}async isReply(t){if(this.replies.length<=0&&this.nbReplies<=0)return!1;this.replies.length<=0&&await this.fetchReplies();for(let e=0;e<this.replies.length;e++)if(this.replies[e].id==t)return!0;return!1}async getReply(t){if(this.replies.length<=0&&this.nbReplies<=0)return null;this.replies.length<=0&&await this.fetchReplies();for(let e=0;e<this.replies.length;e++)if(this.replies[e].id==t)return this.replies[e];return null}removeReply(t){for(let e=0;e<this.replies.length;e++)if(this.replies[e].id==t)return this.replies.splice(e,1),!0;return!1}getCollectionComments(){return this._parent instanceof CommentsBS?this._parent:this._parent instanceof CommentBS?this._parent._parent:null}loadEvents(a,o){this._events=[];async function i(e){return(e=parseInt(e.data("commentId"),10))===l.id?l:l.isReply(e)?l.getReply(e):l.getCollectionComments().getComment(e)}const l=this,s=jQuery("#popin-dialog"),n=jQuery("#popin-showClose"),e=a.find(".title"),t=(n.on("click",()=>{o.hidePopup(),s.removeAttr("data-popin-type")}),this._events.push({elt:n,event:"click"}),a.find(".btnSignal")),r=(t.on("click",async e=>{e.stopPropagation(),e.preventDefault();e=$(e.currentTarget).parents(".comment"),e=await i(e);const s=a.parents(".popin-content").find(".popin-content-html");s.empty().append(CommentBS.getTemplateReport(e)),s.find("button.js-close-popupalert.btn-blue2").on("click",e=>{e.stopPropagation(),e.preventDefault();const t=s.find("form");e={method:"POST",cache:"no-cache",body:new URLSearchParams(t.serialize())};fetch("/apps/report.php",e).then(()=>{s.hide(),a.show()}).catch(()=>{s.hide(),a.show()})}),a.hide(),s.show()}),this._events.push({elt:t,event:"click"}),a.find(".btnSubscribe"));function c(e){var t=l.getCollectionComments();t.is_subscribed?t.is_subscribed&&(e.addClass("active"),e.attr("title","Ne plus recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg width="20" height="22" viewBox="0 0 20 22" style="width: 17px;">
                        <g transform="translate(-4)" fill="none">
                            <path d="M0 0h24v24h-24z"></path>
                            <path fill="${"dark"==UsBetaSeries.theme?"rgba(255, 255, 255, .5)":"#333"}" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32v-.68c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68c-2.87.68-4.5 3.24-4.5 6.32v5l-2 2v1h16v-1l-2-2z"></path>
                        </g>
                    </svg>
                `)):(e.removeClass("active"),e.attr("title","Recevoir les commentaires par e-mail"),e.find("svg").replaceWith(`
                    <svg fill="${"dark"==UsBetaSeries.theme?"rgba(255, 255, 255, .5)":"#333"}" width="14" height="16" style="position: relative; top: 1px; left: -1px;">
                        <path fill-rule="nonzero" d="M13.176 13.284L3.162 2.987 1.046.812 0 1.854l2.306 2.298v.008c-.428.812-.659 1.772-.659 2.806v4.103L0 12.709v.821h11.307l1.647 1.641L14 14.13l-.824-.845zM6.588 16c.914 0 1.647-.73 1.647-1.641H4.941c0 .91.733 1.641 1.647 1.641zm4.941-6.006v-3.02c0-2.527-1.35-4.627-3.705-5.185V1.23C7.824.55 7.272 0 6.588 0c-.683 0-1.235.55-1.235 1.23v.559c-.124.024-.239.065-.346.098a2.994 2.994 0 0 0-.247.09h-.008c-.008 0-.008 0-.017.009-.19.073-.379.164-.56.254 0 0-.008 0-.008.008l7.362 7.746z"></path>
                    </svg>
                `))}r.on("click",e=>{if(e.stopPropagation(),e.preventDefault(),UsBetaSeries.userIdentified()){const t=$(e.currentTarget);e={type:l.getCollectionComments().media.mediaType.singular,id:l.getCollectionComments().media.id};t.hasClass("active")?UsBetaSeries.callApi(HTTP_VERBS.DELETE,"comments","subscription",e).then(()=>{l.getCollectionComments().is_subscribed=!1,c(t)}):UsBetaSeries.callApi(HTTP_VERBS.POST,"comments","subscription",e).then(()=>{l.getCollectionComments().is_subscribed=!0,c(t)})}else faceboxDisplay("inscription",{},()=>{})}),c(r),this._events.push({elt:r,event:"click"});const d=e.find(".prev-comment"),h=(this.isFirst()?d.css("color","grey").css("cursor","initial"):(d.on("click",e=>{e.stopPropagation(),e.preventDefault(),l.cleanEvents(),l.getCollectionComments().getPrevComment(l.id).render()}),this._events.push({elt:d,event:"click"})),e.find(".next-comment")),u=(this.isLast()?h.css("color","grey").css("cursor","initial"):(h.on("click",e=>{e.stopPropagation(),e.preventDefault(),l.cleanEvents(),l.getCollectionComments().getNextComment(l.id).render()}),this._events.push({elt:h,event:"click"})),a.find(".view-spoiler")),p=(0<u.length&&(u.on("click",e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget),s=t.next(".comment-text").find(".spoiler");s.is(":visible")?(s.fadeOut("fast"),t.text("Voir le spoiler")):(s.fadeIn("fast"),t.text("Cacher le spoiler"))}),this._events.push({elt:u,event:"click"})),a.find(".comments .comment .btnThumb")),m=(p.on("click",s=>{if(s.stopPropagation(),s.preventDefault(),UsBetaSeries.userIdentified()){const i=jQuery(s.currentTarget),r=parseInt(i.parents(".comment").data("commentId"),10);let e=HTTP_VERBS.POST;const n=i.hasClass("btnUpVote")?1:-1;let t={id:r,type:n,switch:!1};if(l.thumbed==n)e=HTTP_VERBS.DELETE,t={id:r};else if(0!=l.thumbed)return void console.warn("Le vote est impossible. Annuler votre vote et recommencer");UsBetaSeries.callApi(e,"comments","thumb",t).then(async e=>{if(r==l.id)l.thumbs=parseInt(e.comment.thumbs,10),l.thumbed=e.comment.thumbed?parseInt(e.comment.thumbed,10):0,l.updateRenderThumbs(n);else if(await l.isReply(r)){const s=await l.getReply(r);s.thumbs=parseInt(e.comment.thumbs,10),s.thumbed=e.comment.thumbed?parseInt(e.comment.thumbed,10):0,s.updateRenderThumbs(n)}else{var t=e.comment.thumbed?parseInt(e.comment.thumbed,10):0;l.getCollectionComments().changeThumbs(r,e.comment.thumbs,t)}i.siblings("strong.thumbs").css("animation","1s ease 0s 1 normal forwards running backgroundFadeOut")}).catch(e=>{e=void 0!==e.text?e.text:e;UsBetaSeries.notification("Vote commentaire","Une erreur est apparue durant le vote: "+e)})}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:p,event:"click"}),a.find(".btnToggleOptions")),g=(m.on("click",e=>{e.stopPropagation(),e.preventDefault(),jQuery(e.currentTarget).parents("."+CommentBS.classNamesCSS.actions).first().find(".options-comment").each((e,t)=>{const s=jQuery(t);s.is(":visible")?s.hide():s.show()})}),this._events.push({elt:m,event:"click"}),a.find(".sendComment")),f=(g.on("click",async s=>{if(s.stopPropagation(),s.preventDefault(),UsBetaSeries.userIdentified()){const i=$(s.currentTarget).siblings("textarea");if(0<i.val().length){var e=parseInt(i.data("replyTo"),10),t=i.data("action");const r=i.val();if(e&&e==l.id)l.sendReply(r).then(e=>{e&&(e=CommentBS.getTemplateComment(e),a.find(".comments").append(e),i.removeAttr("data-reply-to"),l.cleanEvents(()=>{l.loadEvents(a,o)}))});else if(e){const n=await l.getReply(e);n&&n.sendReply(r).then(e=>{e&&(e=CommentBS.getTemplateComment(e),a.find(`.comments .comment[data-comment-id="${n.id}"]`).after(e),i.removeAttr("data-reply-to"),l.cleanEvents(()=>{l.loadEvents(a,o)}))})}else"edit"===t?l.edit(r).then(()=>{const e=parseInt(i.data("commentId"),10);let t=$(s.currentTarget).parents(".writing").siblings(".comments").children(`.comment[data-comment-id="${e.toString()}"]`);t.find(".comment-text").text(l.text),(t=jQuery(`#comments .slide_flex .slide__comment[data-comment-id="${e}"]`)).find("p").text(r),i.removeAttr("data-action").removeAttr("data-comment-id")}):CommentsBS.sendComment(l.getCollectionComments().media,r).then(e=>{l.getCollectionComments().addToPage(e.id),l.cleanEvents(()=>{l.loadEvents(a,o)})});i.val(""),i.siblings("button").attr("disabled","true")}}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:g,event:"click"}),a.find("textarea")),_=(f.on("keypress",e=>{const t=$(e.currentTarget);0<t.val().length?t.siblings("button").removeAttr("disabled"):t.siblings("button").attr("disabled","true")}),this._events.push({elt:f,event:"keypress"}),a.find(".baliseSpoiler")),b=(_.on("click",()=>{const e=s.find("textarea");var t;/\[spoiler\]/.test(e.val())||(t="[spoiler]"+e.val()+"[/spoiler]",e.val(t))}),this._events.push({elt:_,event:"click"}),a.find(".comments .toggleReplies")),y=(b.on("click",e=>{e.stopPropagation(),e.preventDefault();const t=$(e.currentTarget);e=t.data("toggle");const s=t.parents(".comment");var i=s.data("commentInner");const r=s.parents(".comments").find(`.comment[data-comment-reply="${i}"]`);"0"==e?(r.nextAll(".sub").fadeIn("fast"),r.fadeIn("fast"),t.find(".btnText").text(UsBetaSeries.trans("comment.hide_answers")),t.find("svg").attr("style","transition: transform 200ms ease 0s; transform: rotate(180deg);"),t.data("toggle","1")):(r.nextAll(".sub").fadeOut("fast"),r.fadeOut("fast"),t.find(".btnText").text(UsBetaSeries.trans("comment.button.reply",{"%count%":r.length.toString()},r.length)),t.find("svg").attr("style","transition: transform 200ms ease 0s;"),t.data("toggle","0"))}),this._events.push({elt:b,event:"click"}),a.find(".btnResponse")),v=(y.on("click",async e=>{if(e.stopPropagation(),e.preventDefault(),UsBetaSeries.userIdentified()){const t=$(e.currentTarget);e=t.parents(".comment"),e=await i(e);a.find("textarea").val("@"+e.login).attr("data-reply-to",e.id)}else faceboxDisplay("inscription",{},()=>{})}),this._events.push({elt:y,event:"click"}),a.find(".btnEditComment")),S=(v.on("click",e=>{e.stopPropagation(),e.preventDefault();const t=$(e.currentTarget).parents(".comment");e=parseInt(t.data("commentId"),10);f.val(l.text),f.attr("data-action","edit"),f.attr("data-comment-id",e)}),this._events.push({elt:v,event:"click"}),a.find(".btnDeleteComment"));S.on("click",e=>{e.stopPropagation(),e.preventDefault();const t=$(e.currentTarget).parents(".comment"),s=$(e.currentTarget).parents(".options-options");s.hide().after(`
                <div class="options-delete">
                    <span class="mainTime">Supprimer mon commentaire :</span>
                    <button type="button" class="btn-reset fontWeight700 btnYes" style="vertical-align: 0px; padding-left: 10px; padding-right: 10px; color: rgb(208, 2, 27);">Oui</button>
                    <button type="button" class="btn-reset mainLink btnNo" style="vertical-align: 0px;">Non</button>
                </div>
            `);const i=t.find(".options-delete .btnYes"),r=t.find(".options-delete .btnNo");i.on("click",e=>{e.stopPropagation(),e.preventDefault(),l.delete(),n.trigger("click")}),r.on("click",e=>{e.stopPropagation(),e.preventDefault(),t.find(".options-delete").remove(),s.show(),i.off("click"),r.off("click")})}),this._events.push({elt:S,event:"click"})}cleanEvents(e=UsBetaSeries.noop){if(this._events&&0<this._events.length){let t;for(let e=0;e<this._events.length;e++)(t=this._events[e]).elt.off(t.event)}e()}async render(){const t=this,e=jQuery("#popin-dialog"),s=e.find(".popin-content-html"),i=e.find(".popin-content-reactmodule"),r=e.find("#popin-showClose"),n=()=>{document.body.style.overflow="visible",document.body.style.paddingRight="",e.attr("aria-hidden","true"),e.find("#popupalertyes").show(),e.find("#popupalertno").show(),i.empty(),s.hide(),t.cleanEvents(),t._callListeners(EventTypes.HIDE)},a=()=>{document.body.style.overflow="hidden",document.body.style.paddingRight=getScrollbarWidth()+"px",e.find("#popupalertyes").hide(),e.find("#popupalertno").hide(),s.hide(),i.show(),r.show(),e.attr("aria-hidden","false")};i.empty().append(`<div class="title" id="dialog-title" tabindex="0">${UsBetaSeries.trans("blog.title.comments")}</div>`);let o=i.find(".title"),l=`
            <div class="loaderCmt">
                <svg class="sr-only">
                    <defs>
                        <clipPath id="placeholder">
                            <path d="M50 25h160v8H50v-8zm0-18h420v8H50V7zM20 40C8.954 40 0 31.046 0 20S8.954 0 20 0s20 8.954 20 20-8.954 20-20 20z"></path>
                        </clipPath>
                    </defs>
                </svg>
        `;for(let e=0;e<4;e++)l+=`
                <div class="er_ex null">
                    <div class="ComponentPlaceholder er_et" style="height: 40px;"></div>
                </div>`;i.append(l+"</div>"),a();let c=`
            <div data-media-type="${t.getCollectionComments().media.mediaType.singular}"
                            data-media-id="${t.getCollectionComments().media.id}"
                            class="displayFlex flexDirectionColumn"
                            style="margin-top: 2px; min-height: 0">`;UsBetaSeries.userIdentified()&&(c+=`<button type="button" class="btn-reset btnSubscribe" style="position: absolute; top: 3px; right: 31px; padding: 8px;">
                <span class="svgContainer">
                    <svg></svg>
                </span>
            </button>`),c+='<div class="comments overflowYScroll">'+CommentBS.getTemplateComment(this),0<this.nbReplies&&this.replies.length<=0&&await this.fetchReplies();for(let e=0;e<this.replies.length;e++)c+=CommentBS.getTemplateComment(this.replies[e]);c+="</div>",this.getCollectionComments().isOpen()&&UsBetaSeries.userIdentified()&&(c+=CommentBS.getTemplateWriting(t)),c+="</div>",e.attr("data-popin-type","comments"),i.fadeOut("fast",()=>{i.find(".loaderCmt").remove(),i.empty().append('<div class="title" id="dialog-title" tabindex="0"></div>'),o=i.find(".title");let e="";t._parent.isFirst(t.id)||(e+=' <i class="fa-solid fa-circle-chevron-left prev-comment" aria-hidden="true" title="Commentaire précédent"></i>'),t._parent.isLast(t.id)||(e+='  <i class="fa-solid fa-circle-chevron-right next-comment" aria-hidden="true" title="Commentaire suivant"></i>'),o.append(UsBetaSeries.trans("blog.title.comments")+e),i.append(c),i.fadeIn(),t.loadEvents(i,{hidePopup:n,showPopup:a}),t._callListeners(EventTypes.SHOW)})}sendReply(e){const s=this;e={type:this.getCollectionComments().media.mediaType.singular,id:this.getCollectionComments().media.id,in_reply_to:this.inner_id,text:e};return UsBetaSeries.callApi(HTTP_VERBS.POST,"comments","comment",e).then(e=>{e=new CommentBS(e.comment,s);const t=s.getCollectionComments().order===OrderComments.DESC?Array.prototype.unshift:Array.prototype.push;return t.call(s.replies,e),s.nbReplies++,s.getCollectionComments().nbComments++,s.getCollectionComments().is_subscribed=!0,e}).catch(e=>{UsBetaSeries.notification("Commentaire","Erreur durant l'ajout d'un commentaire"),console.error(e)})}}!function(e){e.EMPTY="empty",e.HALF="half",e.FULL="full",e.DISABLE="disable"}(StarTypes=StarTypes||{});class Note{static logger=new UsBetaSeries.setDebug("Note");static debug=Note.logger.debug.bind(Note.logger);total;mean;user;_parent;__initial;__changes={};constructor(e,t){return this.__initial=!0,this._parent=t||null,this.fill(e)}fill(e){const s=this,t={total:parseInt,user:parseInt,mean:parseFloat};for(const r of Object.keys(t)){s.__initial&&Object.defineProperty(this,r,{configurable:!0,enumerable:!0,get:()=>s["_"+r],set:e=>{var t=s["_"+r];t!==e&&(s["_"+r]=e,s.__initial||(s.__changes[r]={oldValue:t,newValue:e},s._parent&&s._parent.updatePropRenderObjNote()))}});var i=t[r](e[r]);Reflect.set(this,r,i)}return this.__initial=!1,this}get parent(){return this._parent}set parent(e){if(!(e instanceof MediaBase))throw new TypeError('Parameter "parent" must be an instance of MediaBase');this._parent=e}getPercentage(){return 10*Math.round(this.mean/5*100/10)}toString(){let e="fr-FR";UsBetaSeries.member&&(e=UsBetaSeries.member.locale);var t="vote"+(1<this.total?"s":"");let s=new Intl.NumberFormat(e,{style:"decimal",useGrouping:!0}).format(this.total)+` ${t} : ${this.mean.toFixed(2)} / 5`;return UsBetaSeries.userIdentified()&&0<this.user&&(s+=", votre note: "+this.user),s}toJSON(){return{total:this.total,mean:this.mean,user:this.user}}createPopupForVote(i=UsBetaSeries.noop){Note.debug("objNote createPopupForVote");const r=this,e=jQuery("#popin-dialog"),t=e.find(".popin-content-html"),s=e.find(".popin-content-reactmodule"),n=e.find(".js-close-popupalert"),a=()=>{Note.debug("objNote createPopupForVote hidePopup"),e.attr("aria-hidden","true"),t.find(".button-set").show(),t.hide(),o.find(".star-svg").off("mouseenter").off("mouseleave").off("click")};let o=e.find("p"),l=t.find(".title"),c=(a(),'<div style="display: flex; justify-content: center; margin-bottom: 15px;"><div role="button" tabindex="0" class="stars btn-reset">'),d;for(let e=1;e<=5;e++)d=this.user<=e-1?StarTypes.EMPTY:StarTypes.FULL,c+=`
                <svg viewBox="0 0 100 100" class="star-svg" data-number="${e}" style="width: 30px; height: 30px;">
                    <use xlink:href="#icon-starblue-${d}"></use>
                </svg>`;o.length<=0&&(t.replaceWith(`
                <div class="popin-content-html">
                    <div class="title" id="dialog-title" tabindex="0"></div>
                    <div class="popin-content-ajax">
                        <p></p>
                    </div>
                </div>`),o=t.find("p"),l=t.find(".title")),o.empty().append(c+"</div></div>");let h="Noter ";switch(this._parent.mediaType.singular){case MediaType.show:h+="la série";break;case MediaType.movie:h+="le film";break;case MediaType.episode:h+="l'épisode"}l.empty().text(h),n.click(()=>{a(),e.removeAttr("data-popin-type")});function u(e,t){const s=jQuery(e.currentTarget).parent().find(".star-svg use");var i;for(let e=0;e<5;e++)i=e<=t-1?StarTypes.FULL:StarTypes.EMPTY,$(s.get(e)).attr("xlink:href","#icon-starblue-"+i)}const p=o.find(".star-svg");p.mouseenter(e=>{var t=parseInt($(e.currentTarget).data("number"),10);u(e,t)}),p.mouseleave(e=>{u(e,r.user)}),p.click(e=>{const t=parseInt(jQuery(e.currentTarget).data("number"),10),s=jQuery(e.currentTarget).parent().find(".star-svg");s.off("mouseenter").off("mouseleave"),r._parent.addVote(t).then(e=>{a(),e?(r._parent.changeTitleNote(),r._parent._callListeners(EventTypes.NOTE),i&&i.call(r)):UsBetaSeries.notification("Erreur Vote","Une erreur s'est produite durant le vote")}).catch(()=>a())}),Note.debug("objNote createPopupForVote showPopup"),t.find(".button-set").hide(),t.show(),s.hide(),n.show(),e.attr("aria-hidden","false")}static getTypeSvg(e,t){let s=StarTypes.EMPTY;return e<=t?s=StarTypes.EMPTY:e<t+1?t+.25<e?s=StarTypes.HALF:t+.75<e&&(s=StarTypes.FULL):s=StarTypes.FULL,s}updateStars(e){if(!(e=e||jQuery(".blockInformations__metadatas .js-render-stars",this._parent.elt))||e.length<=0)return this;let t="";const s=jQuery(".star-svg use",e);e=$(s.get(0)).attr("xlink:href").match(/(grey|blue)/);e&&(t=e[0]);for(let e=0;e<5;e++){var i=Note.getTypeSvg(this.mean,e);$(s.get(e)).attr("xlink:href",`#icon-star${t}-`+i)}return this}updateAttrTitle(e){return!(e=e||jQuery(".blockInformations__metadatas .js-render-stars",this._parent.elt))||e.length<=0||(this.mean<=0||this.total<=0?e.attr("title","Aucun vote"):e.attr("title",this.toString())),this}static renderStars(t=0,s=""){let i,r="";0==t&&(s="grey");for(let e=0;e<5;e++)i=Note.getTypeSvg(t,e),r+=`
                <svg viewBox="0 0 100 100" class="star-svg">
                    <use xmlns:xlink="http://www.w3.org/1999/xlink"
                        xlink:href="#icon-star${s}-${i}">
                    </use>
                </svg>
            `;return r}}class Next{id;code;date;title;image;constructor(e){this.id=null!=e.id?parseInt(e.id,10):NaN,this.code=e.code,this.date=new Date(e.date)||null,this.title=e.title,this.image=e.image}}class User extends RenderHtml{static logger=new UsBetaSeries.setDebug("User");static debug=User.logger.debug.bind(User.logger);static relatedProps={archived:{key:"archived",type:"boolean",default:!1},downloaded:{key:"downloaded",type:"boolean",default:!1},favorited:{key:"favorited",type:"boolean",default:!1},friends_want_to_watch:{key:"friends_want_to_watch",type:"array",default:[]},friends_watching:{key:"friends_watched",type:"array",default:[]},hidden:{key:"hidden",type:"boolean",default:!1},last:{key:"last",type:"string",default:""},mail:{key:"mail",type:"boolean",default:!1},next:{key:"next",type:Next},profile:{key:"profile",type:"string",default:""},remaining:{key:"remaining",type:"number",default:0},seen:{key:"seen",type:"boolean",default:!1},status:{key:"status",type:"number",default:0},tags:{key:"tags",type:"string",default:""},twitter:{key:"twitter",type:"boolean",default:!1}};static selectorsCSS={};archived;downloaded;favorited;friends_want_to_watch;friends_watched;hidden;last;mail;next;profile;remaining;seen;status;tags;twitter;constructor(e){return super(e,null),this.fill(e)._initRender()}_initRender(){return this}}!function(e){e.show="show",e.movie="movie",e.episode="episode"}(MediaType=MediaType||{});class MediaBase extends RenderHtml{static logger=new UsBetaSeries.setDebug("Media");static debug=MediaBase.logger.debug.bind(MediaBase.logger);description;nbComments;id;objNote;resource_url;title;user;characters;comments;mediaType;constructor(e,t){return super(e,t),this.characters=[],this.__props=["characters","comments","mediaType"],this}_initRender(){return this.elt&&(this.objNote.updateAttrTitle().updateStars(),this.decodeTitle()),this}updatePropRenderObjNote(){this.elt&&(MediaBase.debug("updatePropRenderObjNote"),this.objNote.updateStars().updateAttrTitle(),this._callListeners(EventTypes.NOTE),delete this.__changes.objNote)}updatePropRenderTitle(){if(this.elt){const e=jQuery(this.constructor.selectorsCSS.title);/&#/.test(this.title)?e.text($("<textarea />").html(this.title).text()):e.text(this.title),delete this.__changes.title}}init(){return this.elt&&(this.comments=new CommentsBS(this.nbComments,this)),this.save(),new Promise(e=>e(this))}save(){return UsBetaSeries.cache instanceof CacheUS&&(UsBetaSeries.cache.set(this.mediaType.plural,this.id,this),this._callListeners(EventTypes.SAVE)),this}get nbCharacters(){return this.characters.length}decodeTitle(){if(!this.elt)return this;let e=jQuery(".blockInformations__title",this.elt);var t=(e=this.constructor.selectorsCSS.title?jQuery(this.constructor.selectorsCSS.title):e).text();return/&#/.test(t)&&e.text($("<textarea />").html(t).text()),this}changeTitleNote(){if(this.elt){const e=jQuery(".js-render-stars",this.elt);this.objNote.mean<=0||this.objNote.total<=0?e.attr("title","Aucun vote"):e.attr("title",this.objNote.toString())}}addVote(t){const s=this;return UsBetaSeries.callApi(HTTP_VERBS.POST,this.mediaType.plural,"note",{id:this.id,note:t}).then(e=>(s.fill(e[this.mediaType.singular]),this.objNote.user==t)).catch(e=>(UsBetaSeries.notification("Erreur de vote","Une erreur s'est produite lors de l'envoi de la note: "+e),!1))}fetchCharacters(){throw new Error("Method abstract")}getCharacter(e){for(const t of this.characters)if(t.person_id===e)return t;return null}}class Media extends MediaBase{static propsAllowedOverride={};static overrideType;static selectorsCSS={genres:".blockInformations .blockInformations__details li:nth-child(#n#) span",duration:".blockInformations .blockInformations__details li:nth-child(#n#) span"};static _fetch(e,t){throw new Error("Abstract Static Method")}static fetchByImdb(e,t=!1){return this._fetch({imdb_id:e},t)}followers;genres;imdb_id;language;duration;original_title;similars;nbSimilars;in_account;slug;__fetches;constructor(e,t){return super(e),t&&(this.elt=t),this.__fetches={},this.similars=[],this.genres=[],this}init(){return this.elt?super.init().then(()=>(this._overrideProps(),this)):super.init()}updatePropRenderGenres(){const e=jQuery(Media.selectorsCSS.genres);0<e.length&&e.text(this.genres.join(", ")),delete this.__changes.genres}fetchSimilars(){return new Promise(e=>e(this))}getSimilar(t){if(!this.similars)return null;for(let e=0;e<this.similars.length;e++)if(this.similars[e].id===t)return this.similars[e];return null}async override(t,s,i){var r=this.constructor;if(r.propsAllowedOverride[t]){const n=await UsBetaSeries.gm_funcs.getValue("override",{shows:{},movies:{}});void 0===n[r.overrideType][this.id]&&(n[r.overrideType][this.id]={}),n[r.overrideType][this.id][t]=s;let e=r.propsAllowedOverride[t].path;return r.propsAllowedOverride[t].params&&(n[r.overrideType][this.id][t]={value:s,params:i},e=UsBetaSeries.replaceParams(e,r.propsAllowedOverride[t].params,i),MediaBase.debug("override",{prop:t,value:s,params:i,path:e})),UsBetaSeries.setPropValue(this,e,s),await UsBetaSeries.gm_funcs.setValue("override",n),!0}return!1}async _overrideProps(){var s,i=this.constructor,r=i.overrideType,n=await UsBetaSeries.gm_funcs.getValue("override",{shows:{},movies:{}});if(MediaBase.debug("_overrideProps override",n),Reflect.has(n[r],this.id)){MediaBase.debug("_overrideProps override found",n[r][this.id]);for(const a in n[r][this.id]){let e=i.propsAllowedOverride[a].path,t=n[r][this.id][a];i.propsAllowedOverride[a].params&&"object"==typeof n[r][this.id][a]&&(t=n[r][this.id][a].value,s=n[r][this.id][a].params,e=UsBetaSeries.replaceParams(e,i.propsAllowedOverride[a].params,s)),MediaBase.debug("_overrideProps prop[%s]",a,{path:e,value:t}),UsBetaSeries.setPropValue(this,e,t)}}return this}_getTvdbUrl(e){const i=UsBetaSeries.serverBaseUrl+"/proxy/",r={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":"",Accept:"application/json"},mode:"cors",cache:"no-cache"};return new Promise((t,s)=>{fetch(i+"?tab=series&id="+e,r).then(e=>(MediaBase.debug("_getTvdbUrl response",e),e.ok?e.json():s())).then(e=>{MediaBase.debug("_getTvdbUrl data",e),e?t(e.url):s()})})}}class Images{static formats={poster:"poster",wide:"wide"};constructor(e){this.show=e.show,this.banner=e.banner,this.box=e.box,this.poster=e.poster,this._local={show:this.show,banner:this.banner,box:this.box,poster:this.poster}}show;banner;box;poster;_local}!function(e){e[e.none=0]="none",e[e.banner=1]="banner",e[e.show=2]="show"}(Picked=Picked||{});class Picture{constructor(e){this.id=parseInt(e.id,10),this.show_id=parseInt(e.show_id,10),this.login_id=parseInt(e.login_id,10),this.url=e.url,this.width=parseInt(e.width,10),this.height=parseInt(e.height,10),this.date=new Date(e.date),this.picked=e.picked}id;show_id;login_id;url;width;height;date;picked}class Platform{constructor(e){this.id=parseInt(e.id,10),this.name=e.name,this.tag=e.tag,this.link_url=e.link_url,this.available=e.available,this.logo=e.logo,this.partner=!e.partner||!1}id;name;tag;link_url;available;logo;partner}class PlatformList{svod;vod;country;static types={svod:"svod",vod:"vod"};static fetchPlatforms(i="us"){return new Promise((t,s)=>{UsBetaSeries.callApi(HTTP_VERBS.GET,"platforms","list",{country:i}).then(e=>{t(new PlatformList(e.platforms,i))}).catch(e=>s(e))})}constructor(t,e="fr"){if(t.svod){this.svod=[];for(let e=0;e<t.svod.length;e++)this.svod.push(new Platform(t.svod[e]));this.svod.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0})}if(t.vod){this.vod=[];for(let e=0;e<t.vod.length;e++)this.vod.push(new Platform(t.vod[e]));this.vod.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0})}this.country=e}renderHtmlOptions(e="svod",t=null){let s="";if(e===PlatformList.types.svod){var i=this.svod.filter(e=>-1===t.indexOf(e.id));for(let e=0;e<i.length;e++)s+=`<option value="${i[e].id}" data-src="${i[e].logo}">${i[e].name}</option>`}else if(e===PlatformList.types.vod){var r=this.vod.filter(e=>-1===t.indexOf(e.id));for(let e=0;e<r.length;e++)s+=`<option value="${r[e].id}" data-src="${r[e].logo}">${r[e].name}</option>`}return s}}class Platforms{constructor(t){if(this.svods=[],t?.svods&&t?.svods instanceof Array)for(let e=0;e<t.svods.length;e++)this.svods.push(new Platform(t.svods[e]));if(t?.svod&&(this.svod=new Platform(t.svod)),this.vod=[],t?.vod&&t?.vod instanceof Array)for(let e=0;e<t.vod.length;e++)this.vod.push(new Platform(t.vod[e]))}svods;svod;vod}class Showrunner{constructor(e){this.id=e.id?parseInt(e.id,10):null,this.name=e.name,this.picture=e.picture}id;name;picture}class Show extends Media{static logger=new UsBetaSeries.setDebug("Media:Show");static debug=Show.logger.debug.bind(Show.logger);static EventTypes=[EventTypes.UPDATE,EventTypes.SAVE,EventTypes.ADD,EventTypes.ADDED,EventTypes.REMOVE,EventTypes.NOTE,EventTypes.ARCHIVE,EventTypes.UNARCHIVE];static propsAllowedOverride={poster:{path:"images.poster"},season:{path:"seasons[#season#].image",params:{season:"number"}}};static overrideType="shows";static selectorsCSS={title:".blockInformations h1.blockInformations__title",description:".blockInformations p.blockInformations__synopsis",creation:".blockInformations .blockInformations__metadatas time",followers:".blockInformations .blockInformations__metadatas span.u-colorWhiteOpacity05.textAlignCenter:nth-of-type(2)",nbSeasons:".blockInformations .blockInformations__metadatas span.u-colorWhiteOpacity05.textAlignCenter:nth-of-type(3)",nbEpisodes:".blockInformations .blockInformations__metadatas span.u-colorWhiteOpacity05.textAlignCenter:nth-of-type(4)",country:".blockInformations .blockInformations__details li:nth-child(#n#) a",genres:".blockInformations .blockInformations__details li:nth-child(#n#) span",duration:".blockInformations .blockInformations__details li:nth-child(#n#) span",status:".blockInformations .blockInformations__details li:nth-child(#n#) span",network:".blockInformations .blockInformations__details li:nth-child(#n#) span",showrunner:".blockInformations .blockInformations__details li:nth-child(#n#) span"};static relatedProps={aliases:{key:"aliases",type:"object",default:{}},comments:{key:"nbComments",type:"number",default:0},country:{key:"country",type:"string",default:""},creation:{key:"creation",type:"number",default:0},description:{key:"description",type:"string",default:""},episodes:{key:"nbEpisodes",type:"number",default:0},followers:{key:"followers",type:"number",default:0},genres:{key:"genres",type:"array",transform:objToArr,default:[]},id:{key:"id",type:"number"},images:{key:"images",type:Images},imdb_id:{key:"imdb_id",type:"string",default:""},in_account:{key:"in_account",type:"boolean",default:!1},language:{key:"language",type:"string",default:""},length:{key:"duration",type:"number",default:0},network:{key:"network",type:"string",default:""},next_trailer:{key:"next_trailer",type:"string",default:""},next_trailer_host:{key:"next_trailer_host",type:"string",default:""},notes:{key:"objNote",type:Note},original_title:{key:"original_title",type:"string",default:""},platforms:{key:"platforms",type:Platforms},rating:{key:"rating",type:"string",default:""},resource_url:{key:"resource_url",type:"string",default:""},seasons:{key:"nbSeasons",type:"number",default:0},seasons_details:{key:"seasons",type:"array",transform:Show.seasonsDetailsToSeasons},showrunner:{key:"showrunner",type:Showrunner},similars:{key:"nbSimilars",type:"number",default:0},slug:{key:"slug",type:"string",default:""},social_links:{key:"social_links",type:"array",default:[]},status:{key:"status",type:"string",default:""},thetvdb_id:{key:"thetvdb_id",type:"number",default:0},themoviedb_id:{key:"tmdb_id",type:"number",default:0},title:{key:"title",type:"string",default:""},user:{key:"user",type:User}};static seasonsDetailsToSeasons(t,s){if(!t.elt)return[];if(Array.isArray(t.seasons)&&t.seasons.length===s.length)return t.seasons;const i=new Array(s.length);for(let e=0;e<s.length;e++)i[s[e].number-1]=new Season(s[e],t);return i}static _fetch(e,t=!1){return UsBetaSeries.callApi("GET","shows","display",e,t).then(e=>{try{return new Show(e.show,jQuery(".blockInformations"))}catch(e){throw console.error("Show::_fetch",e),e}})}static fetchLastSeen(e=10){return UsBetaSeries.callApi(HTTP_VERBS.GET,"shows","member",{order:"last_seen",limit:e}).then(t=>{const s=[];for(let e=0;e<t.shows.length;e++)s.push(new Show(t.shows[e]));return s})}static fetchMulti(e){return UsBetaSeries.callApi(HTTP_VERBS.GET,"shows","display",{id:e.join(",")}).then(t=>{const s=[];if(1<e.length)for(let e=0;e<t.shows.length;e++)s.push(new Show(t.shows[e]));else s.push(new Show(t.show));return s})}static fetch(e,t=!1){return Show._fetch({id:e},t)}static fetchByTvdb(e,t=!1){return this._fetch({thetvdb_id:e},t)}static fetchByUrl(e,t=!0){return this._fetch({url:e},t)}aliases;creation;country;_currentSeason;images;markToSee;nbEpisodes;nbSeasons;network;next_trailer;next_trailer_host;rating;persons;pictures;platforms;seasons;showrunner;social_links;status;thetvdb_id;_posters;constructor(e,t){return super(e,t),this.__fetches={},this._posters=null,this.persons=[],this.seasons=[],this.mediaType={singular:MediaType.show,plural:"shows",className:Show},this.fill(e)._initRender()}init(){if(this.elt){const e=[];return e.push(this.fetchSeasons().then(()=>(this.in_account?this.deleteShowClick():this.addShowClick(),this))),e.push(this.fetchCharacters()),e.push(super.init()),Promise.all(e).then(()=>this)}return super.init()}_initRender(){if(!this.elt)return this;super._initRender();const e=jQuery(Show.selectorsCSS.title);var t;0<e.length&&(t=e.text(),e.empty().append(`<span class="title">${t}</span>`),Show.selectorsCSS.title+=" span.title");const s=jQuery(".blockInformations__details li",this.elt);for(let e=0,t=s.length;e<t;e++){const n=jQuery(s.get(e));if(n.get(0).classList.length<=0)switch(n.find("strong").text().trim().toLowerCase()){case"pays":Show.selectorsCSS.country=Show.selectorsCSS.country.replace("#n#",(e+1).toString());break;case"genres":Media.selectorsCSS.genres=Media.selectorsCSS.genres.replace("#n#",(e+1).toString()),Show.selectorsCSS.genres=Show.selectorsCSS.genres.replace("#n#",(e+1).toString());break;case"durée d’un épisode":{Show.selectorsCSS.duration=Show.selectorsCSS.duration.replace("#n#",(e+1).toString());const a=jQuery(Show.selectorsCSS.duration),o=a.text().trim();var i=o.substring(0,o.indexOf(" ")),r=o.substring(o.indexOf(" "));a.empty().append(`<span class="time">${i}</span>`+r),Show.selectorsCSS.duration+=" span.time",Media.selectorsCSS.duration=Show.selectorsCSS.duration;break}case"statut":Show.selectorsCSS.status=Show.selectorsCSS.status.replace("#n#",(e+1).toString());break;case"chaîne":Show.selectorsCSS.network=Show.selectorsCSS.network.replace("#n#",(e+1).toString());break;case"showrunner":Show.selectorsCSS.showrunner=Show.selectorsCSS.showrunner.replace("#n#",(e+1).toString())}}return this}updatePropRenderFollowers(){const t=jQuery(Show.selectorsCSS.followers);if(0<t.length){let e=this.followers.toString()+" membre"+(1<this.followers?"s":"");if(t.attr("title",e),1e3<=this.followers){const s=Math.round(this.followers/1e3);e=s.toString()+"K membres"}t.text(e)}delete this.__changes.followers}updatePropRenderNbSeasons(){const e=jQuery(Show.selectorsCSS.nbSeasons);0<e.length&&e.text(this.nbSeasons.toString()+" saison"+(1<this.nbSeasons?"s":"")),delete this.__changes.nbSeasons}updatePropRenderNbEpisodes(){const e=jQuery(Show.selectorsCSS.nbEpisodes);0<e.length&&e.text(this.nbEpisodes.toString()+" épisode"+(1<this.nbEpisodes?"s":"")),delete this.__changes.nbEpisodes}updatePropRenderStatus(){const t=jQuery(Show.selectorsCSS.status);if(0<t.length){let e="Terminée";"continuing"===this.status.toLowerCase()&&(e="En cours"),t.text(e)}delete this.__changes.status}updatePropRenderDuration(){const e=jQuery(Show.selectorsCSS.duration);0<e.length&&e.text(this.duration.toString())}fetch(e=!0){const t=this;return this.__fetches.show||(this.__fetches.show=UsBetaSeries.callApi("GET","shows","display",{id:this.id},e).then(e=>e).finally(()=>delete t.__fetches.show),this.__fetches.show)}fetchSeasons(){const n=this;if(this.__fetches.seasons)return this.__fetches.seasons;const e={thetvdb_id:this.thetvdb_id};let t=!1;return this.thetvdb_id<=0&&(delete e.thetvdb_id,e.id=this.id,t=!0),this.__fetches.seasons=UsBetaSeries.callApi(HTTP_VERBS.GET,"shows","seasons",e,t).then(t=>{if(t?.seasons?.length<=0)return delete n.__fetches.seasons,n;if(Array.isArray(n.seasons))for(let e=0;e<t.seasons.length;e++){var s=parseInt(t.seasons[e].number,10);const r=n.seasons[s-1];r.fill(t.seasons[e])}else{n.seasons=new Array(t.seasons.length);for(let e=0;e<t.seasons.length;e++){var i=parseInt(t.seasons[e].number,10);n.seasons[i-1]=new Season(t.seasons[e],this)}}return delete n.__fetches.seasons,n}).catch(e=>{delete n.__fetches.seasons,console.warn("Show.fetchSeasons catch",e)}).finally(()=>delete n.__fetches.seasons),this.__fetches.seasons}fetchCharacters(){const s=this;return this.__fetches.characters||(this.__fetches.characters=UsBetaSeries.callApi(HTTP_VERBS.GET,"shows","characters",{thetvdb_id:this.thetvdb_id}).then(t=>{if(s.characters=[],t?.characters?.length<=0)return s;for(let e=0;e<t.characters.length;e++)s.characters.push(new Character(t.characters[e]));return s}).catch(e=>{console.warn("Show.fetchCharacters catch",e)}).finally(()=>delete s.__fetches.characters),this.__fetches.characters)}getCharacterByName(e){var t=e.toLocaleLowerCase();for(const s of this.characters)if(s.actor.toLocaleLowerCase()===t)return s;return null}fetchPersons(){const s=this;return this.__fetches.persons||(this.__fetches.persons=UsBetaSeries.callApi(HTTP_VERBS.GET,"persons","show",{id:this.id}).then(t=>{if(this.persons=[],t.persons)for(let e=0;e<t.persons.length;e++)s.persons.push(new Person(t.persons[e]));return delete s.__fetches.persons,s}).catch(e=>{delete s.__fetches.persons,console.warn("Show.fetchPersons catch",e)}).finally(()=>delete s.__fetches.persons),this.__fetches.persons)}async fetchPersonsFromCharacters(){const s=this,t=(this.characters.length<=0&&await this.fetchCharacters(),[]);for(let e=0;e<s.characters.length;e++)t.push(Person.fetch(s.characters[e].person_id));return Promise.all(t).then(t=>{for(let e=0;e<t.length;e++)t[e]&&s.persons.push(t[e]);return s})}getPersonByName(e){var t=e.toLowerCase();for(const s of this.persons)if(s.name.toLowerCase()===t)return s;return null}getPersonById(e){for(const t of this.persons)if(t.id===e)return t;return null}isEnded(){return"ended"===this.status.toLowerCase()}isArchived(){return this.user.archived}isFavorite(){return this.user.favorited}async isMarkedToSee(){return!isNull((await UsBetaSeries.gm_funcs.getValue("toSee",[]))[this.id])}async removeFromToSee(){const e=await UsBetaSeries.gm_funcs.getValue("toSee",[]);var t=e.indexOf(this.id);0<=t&&(e.splice(t,1),UsBetaSeries.gm_funcs.setValue("toSee",e))}addToAccount(){const i=this;return this.in_account?new Promise(e=>e(i)):new Promise((t,s)=>{UsBetaSeries.callApi("POST","shows","show",{id:i.id}).then(e=>{i.fill(e.show),i.removeFromToSee(),i._callListeners(EventTypes.ADD),i.save(),t(i)},e=>{void 0!==e.code&&2003===e.code&&i.update().then(e=>t(e)),s(e)})})}removeFromAccount(){const i=this;return this.in_account?new Promise((t,s)=>{UsBetaSeries.callApi("DELETE","shows","show",{id:i.id}).then(e=>{i.fill(e.show),i._callListeners(EventTypes.REMOVE),i.save(),t(i)},e=>{void 0!==e.code&&2004===e.code&&i.update().then(e=>t(e)),s(e)})}):new Promise(e=>e(i))}archive(){const i=this;return new Promise((t,s)=>{UsBetaSeries.callApi("POST","shows","archive",{id:i.id}).then(e=>{i.fill(e.show),i.save(),i._callListeners(EventTypes.ARCHIVE),t(i)},e=>{s(e)})})}unarchive(){const i=this;return new Promise((t,s)=>{UsBetaSeries.callApi("DELETE","shows","archive",{id:i.id}).then(e=>{i.fill(e.show),i.save(),i._callListeners(EventTypes.UNARCHIVE),t(i)},e=>{s(e)})})}favorite(){const i=this;return new Promise((t,s)=>{UsBetaSeries.callApi("POST","shows","favorite",{id:i.id}).then(e=>{i.fill(e.show),i.save(),t(i)},e=>{s(e)})})}unfavorite(){const i=this;return new Promise((t,s)=>{UsBetaSeries.callApi("DELETE","shows","favorite",{id:i.id}).then(e=>{i.fill(e.show),i.save(),t(i)},e=>{s(e)})})}update(t=UsBetaSeries.noop){const s=this;return UsBetaSeries.callApi("GET","shows","display",{id:s.id},!0).then(e=>(e.show&&(s.fill(e.show).save(),s.updateRender(()=>{"function"==typeof t&&t(),s._callListeners(EventTypes.UPDATE)})),s)).catch(e=>{UsBetaSeries.notification("Erreur de récupération de la ressource Show","Show update: "+e),"function"==typeof t&&t()})}updateRender(t=UsBetaSeries.noop){if(this.elt){const i=this;this.updateProgressBar(),this.updateNextEpisode(),this.updateArchived();var s=this.objNote;if(Show.logger.enabled&&Show.debug("Next ID et status",{next:this.user.next.id,status:this.status,archived:this.user.archived,note_user:s.user}),0===this.user.remaining&&this.in_account&&this.currentSeason.seen){let e=new Promise(e=>e(void 0));this.isEnded()&&!this.isArchived()&&(Show.debug("Série terminée, popup proposition archivage"),e=new Promise(e=>{new PopupAlert({title:"Archivage de la série",text:"Voulez-vous archiver cette série terminée ?",callback_yes:function(){jQuery("#reactjs-show-actions button.btn-archive",this.elt).trigger("click"),e(void 0)},callback_no:function(){return e(void 0),!0}})})),0===s.user&&(Show.debug("Proposition de voter pour la série"),e.then(()=>{let e=!1;new PopupAlert({title:UsBetaSeries.trans("popin.note.title.show"),text:"Voulez-vous noter la série ?",callback_yes:function(){return e=!0},callback_no:function(){return!0},onClose:function(){e&&(i.objNote.updateStars(),i.objNote.createPopupForVote())}})})),e.then(()=>{t()})}else t()}}updateProgressBar(){Show.debug("updateProgressBar"),jQuery(".progressBarShow").css("width",this.user.status.toFixed(1)+"%")}updateArchived(){if(this.elt){Show.debug("Show updateArchived");const e=jQuery("#reactjs-show-actions button.btn-archive",this.elt);this.isArchived()&&0<e.length&&e.trigger("click")}}updateNextEpisode(e=UsBetaSeries.noop){if(this.elt){Show.debug("updateNextEpisode");const r=this,n=jQuery("a.blockNextEpisode",this.elt),a=function(){let t=0;for(let e=0;e<r.seasons.length;e++)t+=r.seasons[e].getNbEpisodesUnwatched();return t.toString()};if(0<n.length&&this.user.next&&!isNaN(this.user.next.id)){var t=parseInt(this.user.next.code.match(/S\d+/)[0].replace("S",""),10);let e=this.user.next;var s=this.currentSeason?.getNextEpisodeUnwatched();t<this.currentSeason?.number&&s&&(e=new Next({id:s.id,code:s.code,date:s.date,title:s.title,image:""})),Show.debug("nextEpisode et show.user.next OK",this.user,e);const o=n.find("img"),l=n.find(".remaining div"),c=o.parent("div"),d=o.attr("height"),h=o.attr("width"),u=`${UsBetaSeries.api.url}/pictures/episodes?key=${UsBetaSeries.userKey}&id=${e.id}&width=${h}&height=`+d;o.remove(),c.append(`<img data-src="${u}" class="js-lazy-image" height="${d}" width="${h}" />`),n.find(".titleEpisode").text(e.code.toUpperCase()+" - "+e.title),n.attr("href",n.attr("href").replace(/s\d{2}e\d{2}/,e.code.toLowerCase())),l.text(l.text().trim().replace(/^\d+/,a()))}else n.length<=0&&this.user.next&&!isNaN(this.user.next.id)?(Show.debug("No nextEpisode et show.user.next OK",this.user),t=this,s=""+UsBetaSeries.api.url+`/pictures/episodes?key=${UsBetaSeries.userKey}&id=${t.user.next.id}&width=124&height=70`,i=t.resource_url.split("/").pop(),jQuery(".blockInformations__actions").last().after(`<a href="/episode/${i}/${t.user.next.code.toLowerCase()}" class="blockNextEpisode media">
                    <div class="media-left">
                    <div class="u-insideBorderOpacity u-insideBorderOpacity--01">
                        <img src="${s}" width="124" height="70">
                    </div>
                    </div>
                    <div class="media-body">
                    <div class="title">
                        <strong>Prochain épisode à regarder</strong>
                    </div>
                    <div class="titleEpisode">
                        ${t.user.next.code.toUpperCase()} - ${t.user.next.title}
                    </div>
                    <div class="remaining">
                        <div class="u-colorWhiteOpacity05">${a()} épisode${1<t.user.remaining?"s":""} à regarder</div>
                    </div>
                    </div>
                </a>`)):this.user.next&&!isNaN(this.user.next.id)||n.remove();var i;e()}}addShowClick(e=!1){const l=this,c=$("#episodes .slide__image");var t;async function s(s){var t=jQuery(".blockInformations__action .dropdown-menu a.header-navigation-item");if(t.length<=3){var i=jQuery('script[id^="/reactjs/"]').get(0).id.split(".")[1],r=s.resource_url.substring(location.origin.length),n=s.title.replace(/"/g,'\\"').replace(/'/g,"\\'");let e=`
                        <button type="button" class="btn-reset header-navigation-item" onclick="new PopupAlert({
                        showClose: true,
                        type: "popin-subtitles",
                        reactModuleId: "reactjs-subtitles",
                        params: {
                            mediaId: "${s.id}",
                            type: "show",
                            titlePopin: "${n}";
                        },
                        callback: function() {
                            loadRecommendationModule('subtitles');
                            //addScript("/reactjs/subtitles.${i}.js", "module-reactjs-subtitles");
                        },
                        });">Sous-titres</button>
                        <a class="header-navigation-item" href="javascript:;" onclick="reportItem(${s.id}, 'show');">Signaler un problème</a>
                        <a class="header-navigation-item" href="webcal://www.betaseries.com/cal/i${r}">Planning iCal de la série</a>

                        <form class="autocomplete js-autocomplete-form header-navigation-item">
                            <button type="reset" class="btn-reset fontWeight700 js-autocomplete-show" style="color: inherit">Recommander la série</button>
                            <div class="autocomplete__toShow" hidden="">
                                <input placeholder="Nom d'un ami" type="text" class="autocomplete__input js-search-friends">
                                <div class="autocomplete__response js-display-response"></div>
                            </div>
                        </form>
                        <script>
                            new SearchFriend({url: document.querySelector("[data-show-url]").dataset.showUrl});
                        </script>
                        <a class="header-navigation-item" href="javascript:;">Supprimer de mes séries</a>`;2===t.length&&(e=`<a class="header-navigation-item" href="${r}/actions">Vos actions sur la série</a>`+e),jQuery('.blockInformations__action .dropdown-menu.header-navigation[aria-labelledby="dropdownOptions"]').append(e)}if(1===jQuery("#reactjs-show-actions > div").length){const e=jQuery("#reactjs-show-actions");e.empty().append(`
                        <div class="displayFlex alignItemsFlexStart"
                                id="reactjs-show-actions"
                                data-show-id="${s.id}"
                                data-user-hasarchived="${s.user.archived?"1":""}"
                                data-show-inaccount="1"
                                data-user-id="${UsBetaSeries.userId}"
                                data-show-favorised="${s.user.favorited?"1":""}">
                            <div class="blockInformations__action">
                                <button class="btn-reset btn-transparent btn-archive" type="button">
                                    <span class="svgContainer">
                                    <svg fill="#0d151c" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
                                        <path d="m16 8-1.41-1.41-5.59 5.58v-12.17h-2v12.17l-5.58-5.59-1.42 1.42 8 8z"></path>
                                    </svg>
                                    </span>
                                </button>
                                <div class="label">${UsBetaSeries.trans("show.button.archive.label")}</div>
                            </div>
                            <div class="blockInformations__action">
                                <button class="btn-reset btn-transparent btn-favoris" type="button">
                                    <span class="svgContainer">
                                    <svg fill="#FFF" width="20" height="19" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M14.5 0c-1.74 0-3.41.81-4.5 2.09C8.91.81 7.24 0 5.5 0 2.42 0 0 2.42 0 5.5c0 3.78 3.4 6.86 8.55 11.54L10 18.35l1.45-1.32C16.6 12.36 20 9.28 20 5.5 20 2.42 17.58 0 14.5 0zm-4.4 15.55l-.1.1-.1-.1C5.14 11.24 2 8.39 2 5.5 2 3.5 3.5 2 5.5 2c1.54 0 3.04.99 3.57 2.36h1.87C11.46 2.99 12.96 2 14.5 2c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"></path>
                                    </svg>
                                    </span>
                                </button>
                                <div class="label">${UsBetaSeries.trans("show.button.favorite.label")}</div>
                            </div>
                        </div>`);let t;for(let e=0;e<c.length;e++)(t=$(c.get(e))).find(".seen").length<=0&&t.find("img.js-lazy-image").attr("style","filter: blur(5px);");const a=jQuery(".blockInformations__metadatas .js-render-stars");a.replaceWith(`
                    <button type="button" class="btn-reset fontSize0">
                        <span class="stars js-render-stars">
                            ${a.html()}
                        </span>
                    </button>`),l.elt=$(".blockInformations");n=`<button
                    type="button"
                    class="btn-reset blockTitle-subtitle u-colorWhiteOpacity05"
                >
                    ${UsBetaSeries.trans("popup.suggest_show.title",{"%title%":"une série"})}</button>`;jQuery("#similars h2.blockTitle").after(n),l.elt.find(".blockInformations__action .btnMarkToSee").parent().remove(),l.elt.find(".blockInformations__title .fa-clock").remove();const o=await UsBetaSeries.gm_funcs.getValue("toSee",{});void 0!==o[l.id]&&(delete o[l.id],UsBetaSeries.gm_funcs.setValue("toSee",o))}l.addEventBtnsArchiveAndFavoris(),l.deleteShowClick()}this.in_account||(jQuery("#reactjs-show-actions").html(`
                <div class="blockInformations__action">
                    <button class="btn-reset btn-transparent btn-add" type="button">
                        <span class="svgContainer">
                            <svg fill="#0D151C" width="14" height="14" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 8H8v6H6V8H0V6h6V0h2v6h6z" fill-rule="nonzero"></path>
                            </svg>
                        </span>
                    </button>
                    <div class="label">${UsBetaSeries.trans("show.button.add.label")}</div>
                </div>`),this.addBtnToSee(),t=`<a class="header-navigation-item" href="javascript:;" onclick="showUpdate('${this.title.replace(/"/g,'\\"').replace(/'/g,"\\'")}', ${this.id}, '0')">Demander une mise à jour</a>`,jQuery('.blockInformations__action .dropdown-menu.header-navigation[aria-labelledby="dropdownOptions"]').append(t),jQuery("#reactjs-show-actions > div > button").off("click").one("click",e=>{e.stopPropagation(),e.preventDefault(),Show.logger.enabled&&console.groupCollapsed("AddShow");function t(){s(l),l.updateNextEpisode(function(){l._callListeners(EventTypes.ADDED),Show.logger.enabled&&console.groupEnd()})}l.addToAccount().then(()=>t(),e=>{e&&void 0!==e.code&&2003===e.code?t():(UsBetaSeries.notification("Erreur d'ajout de la série",e),Show.logger.enabled&&console.groupEnd())})})),e&&this.update().then(e=>{s(e)})}deleteShowClick(){const r=this,n=$("#dropdownOptions").siblings(".dropdown-menu").children("a.header-navigation-item");this.in_account&&2<n.length&&(this.addEventBtnsArchiveAndFavoris(),n.last().removeAttr("onclick").off("click").on("click",e=>{e.stopPropagation(),e.preventDefault();function t(){new PopupAlert({title:UsBetaSeries.trans("popup.delete_show_success.title"),text:UsBetaSeries.trans("popup.delete_show_success.text",{"%title%":r.title}),yes:UsBetaSeries.trans("popup.delete_show_success.yes"),callback_yes:function(){r.user.status=0,r.user.archived=!1,r.user.favorited=!1,r.user.remaining=0,r.user.last="S00E00",r.user.next.id=NaN,r.save(),jQuery("#reactjs-show-actions").html(`
                            <div class="blockInformations__action">
                                <button class="btn-reset btn-transparent btn-add" type="button">
                                <span class="svgContainer">
                                    <svg fill="#0D151C" width="14" height="14" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 8H8v6H6V8H0V6h6V0h2v6h6z" fill-rule="nonzero"></path>
                                    </svg>
                                </span>
                                </button>
                                <div class="label">${UsBetaSeries.trans("show.button.add.label")}</div>
                            </div>`),n.first().siblings().each((e,t)=>{$(t).remove()});const s=jQuery("#episodes .slide_flex");let e,i=!1;(e=r.currentSeason.episodes&&0<r.currentSeason.episodes.length?new Promise(e=>e(r.currentSeason)):r.currentSeason.fetchEpisodes()).then(t=>{for(let e=0;e<t.episodes.length;e++)null===t.episodes[e].elt&&(t.episodes[e].elt=$(s.get(e))),e===t.episodes.length-1&&(i=!0),Show.debug("clean episode %d",e,i),t.episodes[e].updateRender("notSeen",i)});const t=jQuery(".blockInformations__metadatas .js-render-stars");t.parent().replaceWith(`
                            <span class="stars js-render-stars">
                                ${t.html()}
                            </span>`),r.elt=$(".blockInformations"),r.addBtnToSee(),r.addShowClick(),r.updateProgressBar(),r.updateNextEpisode()}})}new PopupAlert({title:UsBetaSeries.trans("popup.delete_show.title",{"%title%":r.title}),text:UsBetaSeries.trans("popup.delete_show.text",{"%title%":r.title}),callback_yes:function(){Show.logger.enabled&&console.groupCollapsed("delete show"),r.removeFromAccount().then(t,e=>{if(e&&void 0!==e.code&&2004===e.code)return t(),void(Show.logger.enabled&&console.groupEnd());UsBetaSeries.notification("Erreur de suppression de la série",e),Show.logger.enabled&&console.groupEnd()})},callback_no:UsBetaSeries.noop})}))}async addBtnToSee(){Show.debug("Show.addBtnToSee");const s=this;let e=this.elt.find(".blockInformations__action .btnMarkToSee");e.length<=0&&(this.elt.find(".blockInformations__actions").last().append(`
                <div class="blockInformations__action">
                    <button class="btn-reset btn-transparent btnMarkToSee" type="button" title="Ajouter la série aux séries à voir">
                        <i class="fa-solid fa-clock" aria-hidden="true"></i>
                    </button>
                    <div class="label">A voir</div>
                </div>`),(e=this.elt.find(".blockInformations__action .btnMarkToSee")).on("click",async e=>{e.stopPropagation(),e.preventDefault();const t=jQuery(e.currentTarget);await i(s.id)?(t.find("i.fa-solid").css("color","var(--body_background)"),t.attr("title","Retirer la série des séries à voir"),s.elt.find(".blockInformations__title").append('<i class="fa-solid fa-clock" aria-hidden="true" style="font-size:0.6em;margin-left:5px;vertical-align:middle;" title="Série à voir plus tard"></i>')):(t.find("i.fa-solid").css("color","var(--default-color)"),t.attr("title","Ajouter la série aux séries à voir"),s.elt.find(".blockInformations__title .fa-solid").remove()),t.blur()}));const i=async e=>{const t=await UsBetaSeries.gm_funcs.getValue("toSee",[]);var s=t.includes(e);return s?t.splice(t.indexOf(e),1):t.push(e),UsBetaSeries.gm_funcs.setValue("toSee",t),s},t=await UsBetaSeries.gm_funcs.getValue("toSee",[]);t.includes(this.id)&&(e.find("i.fa-solid").css("color","var(--body_background)"),e.attr("title","Retirer la série des séries à voir"),s.elt.find(".blockInformations__title").append('<i class="fa-solid fa-clock" aria-hidden="true" style="font-size:0.6em;" title="Série à voir plus tard"></i>'))}addEventBtnsArchiveAndFavoris(){const t=this;let e=jQuery("#reactjs-show-actions button.btn-archive"),s=jQuery("#reactjs-show-actions button.btn-favoris");0!==e.length&&0!==s.length||($("#reactjs-show-actions button:first").addClass("btn-archive"),e=jQuery("#reactjs-show-actions button.btn-archive"),$("#reactjs-show-actions button:last").addClass("btn-favoris"),s=jQuery("#reactjs-show-actions button.btn-favoris")),e.off("click").click(r=>{function e(e,t,s,i){e.then(()=>{var e=$(r.currentTarget).parent();$("span",r.currentTarget).css("transform",t),$(".label",e).text(UsBetaSeries.trans(s)),Show.logger.enabled&&console.groupEnd()},e=>{UsBetaSeries.notification(i,e),Show.logger.enabled&&console.groupEnd()})}r.stopPropagation(),r.preventDefault(),Show.logger.enabled&&console.groupCollapsed("show-archive"),t.isArchived()?e(t.unarchive(),"rotate(0deg)","show.button.archive.label","Erreur désarchivage de la série"):e(t.archive(),"rotate(180deg)","show.button.unarchive.label","Erreur d'archivage de la série")}),s.off("click").click(e=>{e.stopPropagation(),e.preventDefault(),Show.logger.enabled&&console.groupCollapsed("show-favoris"),t.isFavorite()?t.unfavorite().then(()=>{$(e.currentTarget).children("span").replaceWith(`
                            <span class="svgContainer">
                            <svg fill="#FFF" width="20" height="19" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.5 0c-1.74 0-3.41.81-4.5 2.09C8.91.81 7.24 0 5.5 0 2.42 0 0 2.42 0 5.5c0 3.78 3.4 6.86 8.55 11.54L10 18.35l1.45-1.32C16.6 12.36 20 9.28 20 5.5 20 2.42 17.58 0 14.5 0zm-4.4 15.55l-.1.1-.1-.1C5.14 11.24 2 8.39 2 5.5 2 3.5 3.5 2 5.5 2c1.54 0 3.04.99 3.57 2.36h1.87C11.46 2.99 12.96 2 14.5 2c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"></path>
                            </svg>
                            </span>`),Show.logger.enabled&&console.groupEnd()},e=>{UsBetaSeries.notification("Erreur de favoris de la série",e),Show.logger.enabled&&console.groupEnd()}):t.favorite().then(()=>{jQuery(e.currentTarget).children("span").replaceWith(`
                            <span class="svgContainer">
                            <svg width="21" height="19" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15.156.91a5.887 5.887 0 0 0-4.406 2.026A5.887 5.887 0 0 0 6.344.909C3.328.91.958 3.256.958 6.242c0 3.666 3.33 6.653 8.372 11.19l1.42 1.271 1.42-1.28c5.042-4.528 8.372-7.515 8.372-11.18 0-2.987-2.37-5.334-5.386-5.334z"></path>
                            </svg>
                            </span>`),Show.logger.enabled&&console.groupEnd()},e=>{UsBetaSeries.notification("Erreur de favoris de la série",e),Show.logger.enabled&&console.groupEnd()})})}addRating(){var e;Show.debug("addRating"),this.rating&&null!==(e=void 0!==UsBetaSeries.ratings[this.rating]?UsBetaSeries.ratings[this.rating]:null)&&jQuery(".blockInformations__details").append(`<li id="rating"><strong>Classification</strong>
                        <img src="${e.img}" title="${e.title}"/>
                    </li>`)}setCurrentSeason(e){if(e<=0||e>this.seasons.length)throw new RangeError(`seasonNumber[${e}] is out of range of seasons(length: ${this.seasons.length})`);return this._currentSeason=e-1,this}get currentSeason(){return this._currentSeason||(this._currentSeason=0),this.seasons[this._currentSeason]}getSeason(e){if(Show.debug("Show.getSeason: seasonNumber(%d)",e),e<=0||e>this.seasons.length)throw new RangeError(`seasonNumber[${e}] is out of range of seasons(length: ${this.seasons.length})`);return this.seasons[e-1]}getDefaultImage(e=Images.formats.poster){const t=UsBetaSeries.serverBaseUrl+"/posters",s={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":""},mode:"cors",cache:"no-cache"};return new Promise((r,n)=>{e===Images.formats.poster?(Show.debug("Show.getDefaultImage poster",this.images.poster),this.images.poster?r(this.images.poster):this._getTvdbUrl(this.thetvdb_id).then(e=>{if(!e)return r("");e=new URL(e);fetch(t+e.pathname,s).then(e=>e.ok?e.text():null).then(e=>{if(null==e)return n("HTML error");const t=new DOMParser,s=t.parseFromString(e,"text/html"),i=s.querySelector('.container .row a[rel="artwork_posters"]');i&&r(i.href.replace("original","w500")),n("poster not found")}).catch(e=>n(e))})):e===Images.formats.wide&&(null!==this.images.show?r(this.images.show):null!==this.images.box?r(this.images.box):this._getTvdbUrl(this.thetvdb_id).then(e=>{if(!e)return r("");e=new URL(e);fetch(t+e.pathname,s).then(e=>e.ok?e.text():null).then(e=>{if(null==e)return n("HTML error");const t=new DOMParser,s=t.parseFromString(e,"text/html"),i=s.querySelector('.container .row a[rel="artwork_backgrounds"]');i&&r(i.href.replace("original","w500")),n("image not found")}).catch(e=>n(e))}))})}getAllPosters(){if(this._posters)return new Promise(e=>e(this._posters));const t=UsBetaSeries.serverBaseUrl+"/posters",s={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":""},mode:"cors",cache:"no-cache"};return new Promise((r,n)=>{const a={};this.images?._local.poster&&(a.local=[this.images._local.poster]),this._getTvdbUrl(this.thetvdb_id).then(e=>{if(!e)return r(a);e=new URL(e);fetch(t+e.pathname+"/artwork/posters",s).then(e=>e.ok?e.text():null).then(e=>{if(null==e)return n("HTML error");a.TheTVDB=[];const t=new DOMParser,s=t.parseFromString(e,"text/html");var i=s.querySelectorAll("a.thumbnail img");for(let e=0;e<i.length;e++)a.TheTVDB.push(i[e].dataset.src);this._posters=a,r(a)}).catch(e=>n(e))})})}}!function(e){e[e.TOSEE=0]="TOSEE",e[e.SEEN=1]="SEEN",e[e.DONTWANTTOSEE=2]="DONTWANTTOSEE"}(MovieStatus=MovieStatus||{});class Movie extends Media{static logger=new UsBetaSeries.setDebug("Media:Movie");static debug=Movie.logger.debug.bind(Movie.logger);static propsAllowedOverride={poster:{path:"poster"}};static overrideType="movies";static selectorsCSS={title:".blockInformations h1.blockInformations__title",description:".blockInformations p.blockInformations__description",tagline:".blockInformations p.blockInformations__tagline",release_date:".blockInformations .blockInformations__metadatas time",followers:".blockInformations .blockInformations__metadatas span.u-colorWhiteOpacity05",director:".blockInformations .blockInformations__details li:nth-child(#n#) sapn",duration:".blockInformations .blockInformations__details li:nth-child(#n#) span",genres:".blockInformations .blockInformations__details li:nth-child(#n#) span",language:".blockInformations .blockInformations__details li:nth-child(#n#) span"};static relatedProps={backdrop:{key:"backdrop",type:"string",default:""},comments:{key:"nbComments",type:"number",default:0},director:{key:"director",type:"string",default:""},followers:{key:"followers",type:"number",default:0},genres:{key:"genres",type:"array",default:[]},id:{key:"id",type:"number"},imdb_id:{key:"imdb_id",type:"string",default:""},in_account:{key:"in_account",type:"boolean",default:!1},language:{key:"language",type:"string",default:""},length:{key:"duration",type:"number",default:0},notes:{key:"objNote",type:Note},original_release_date:{key:"original_release_date",type:"date"},original_title:{key:"original_title",type:"string",default:""},other_title:{key:"other_title",type:"object",default:{}},platform_links:{key:"platforms",type:"array",default:[]},poster:{key:"poster",type:"string",default:""},production_year:{key:"production_year",type:"number",default:0},release_date:{key:"release_date",type:"date"},resource_url:{key:"resource_url",type:"string",default:""},sale_date:{key:"sale_date",type:"date",default:null},similars:{key:"nbSimilars",type:"number",default:0},synopsis:{key:"description",type:"string",default:""},tagline:{key:"tagline",type:"string",default:""},title:{key:"title",type:"string",default:""},tmdb_id:{key:"tmdb_id",type:"number",default:0},trailer:{key:"trailer",type:"string",default:""},url:{key:"slug",type:"string",default:""},user:{key:"user",type:User}};static _fetch(e,i=!1){return new Promise((t,s)=>{UsBetaSeries.callApi("GET","movies","movie",e,i).then(e=>t(new Movie(e.movie,jQuery(".blockInformations")))).catch(e=>s(e))})}static fetch(e,t=!1){return Movie._fetch({id:e},t)}static fetchByTmdb(e,t=!1){return this._fetch({tmdb_id:e},t)}static search(e,i=!1){return new Promise((t,s)=>{UsBetaSeries.callApi(HTTP_VERBS.GET,"movies","search",{title:e},i).then(e=>{t(new Movie(e.movies[0]))}).catch(e=>s(e))})}backdrop;director;original_release_date;other_title;platform_links;poster;production_year;release_date;sale_date;tagline;tmdb_id;trailer;_posters;_local;constructor(e,t){return e.in_account=e.user?.in_account,super(e,t),this._local={poster:null},this.platform_links=[],this.mediaType={singular:MediaType.movie,plural:"movies",className:Movie},this.fill(e)._initRender()}_initRender(){if(this.elt){super._initRender();const t=jQuery(Movie.selectorsCSS.title);var e;0<t.length&&(e=t.text(),t.empty().append(`<span class="title">${e}</span>`),Movie.selectorsCSS.title+=" span.title");const s=jQuery(".blockInformations .blockInformations__synopsis"),i=(2===s.length?(s.first().addClass("blockInformations__tagline"),s.last().addClass("blockInformations__description")):s.first().addClass("blockInformations__description"),jQuery(".blockInformations__details li",this.elt));for(let e=0,t=i.length;e<t;e++){const r=jQuery(i.get(e));if(r.get(0).classList.length<=0)switch(r.find("strong").text().trim().toLowerCase()){case"réalisateur":Movie.selectorsCSS.director=Movie.selectorsCSS.director.replace("#n#",(e+1).toString());break;case"genres":Media.selectorsCSS.genres=Media.selectorsCSS.genres.replace("#n#",(e+1).toString()),Movie.selectorsCSS.genres=Movie.selectorsCSS.genres.replace("#n#",(e+1).toString());break;case"durée":Media.selectorsCSS.duration=Media.selectorsCSS.duration.replace("#n#",(e+1).toString()),Movie.selectorsCSS.duration=Movie.selectorsCSS.duration.replace("#n#",(e+1).toString());break;case"langue":Movie.selectorsCSS.language=Movie.selectorsCSS.language.replace("#n#",(e+1).toString())}}return this}}updatePropRenderFollowers(){const t=jQuery(Movie.selectorsCSS.followers);if(0<t.length){let e=this.followers.toString()+" membre"+(1<this.followers?"s":"");if(t.attr("title",e),1e3<=this.followers){const s=Math.round(this.followers/1e3);e=s.toString()+"K membres"}t.text(e)}delete this.__changes.followers}updatePropRenderReleaseDate(){const e=jQuery(Movie.selectorsCSS.release_date);0<e.length&&e.text(this.release_date.format("dd mmmm yyyy")),delete this.__changes.release_date}updatePropRenderDuration(){const i=jQuery(Movie.selectorsCSS.duration);if(0<i.length){let e=this.duration/60,t=e/60,s="";1<=t&&(t=Math.floor(t),e=60*(e/60-t),s+=`${t.toString()} heure${1<t?"s":""} `),s+=e.toFixed().padStart(2,"0")+" minutes",i.text(s)}}markAsView(){return this.changeStatus(MovieStatus.SEEN)}markToSee(){return this.changeStatus(MovieStatus.TOSEE)}markDontWantToSee(){return this.changeStatus(MovieStatus.DONTWANTTOSEE)}changeStatus(e){const t=this;return UsBetaSeries.userIdentified()&&this.user.status!==e?UsBetaSeries.callApi(HTTP_VERBS.POST,this.mediaType.plural,"movie",{id:this.id,state:e}).then(e=>(t.fill(e.movie),this)).catch(e=>(console.warn("Erreur ajout film sur compte",e),UsBetaSeries.notification("Ajout du film","Erreur lors de l'ajout du film sur votre compte"),this)):(console.info("User not identified or state is equal with user status"),Promise.resolve(this))}getDefaultImage(i="poster"){const r={method:"GET",mode:"cors",cache:"no-cache"};return new Promise((t,s)=>{if("poster"===i)if(this.poster)t(this.poster);else{var e=UsBetaSeries.themoviedb_api_user_key,e=`https://api.themoviedb.org/3/movie/${this.tmdb_id}?api_key=${e}&language=fr`;fetch(e,r).then(e=>e.ok?e.json():null).then(e=>{if(null==e)return s("Response JSON error");e.poster?t("https://image.tmdb.org/t/p/w500"+e.poster):s("no data poster")}).catch(e=>s(e))}})}fetchCharacters(){const s=this;return this.__fetches.characters||(this.__fetches.characters=UsBetaSeries.callApi(HTTP_VERBS.GET,"movies","characters",{id:this.id},!0).then(t=>{if(s.characters=[],t?.characters?.length<=0)return s;for(let e=0;e<t.characters.length;e++)s.characters.push(new Character(t.characters[e]));return s}).finally(()=>delete this.__fetches.characters),this.__fetches.characters)}getAllPosters(){if(this._posters)return new Promise(e=>e(this._posters));const r={method:"GET",mode:"cors",cache:"no-cache"};return new Promise((e,s)=>{const i={};this.poster&&(i.local=[this._local.poster]);var t=UsBetaSeries.themoviedb_api_user_key,t=`https://api.themoviedb.org/3/movie/${this.tmdb_id}/images?api_key=`+t;fetch(t,r).then(e=>e.ok?e.json():null).then(t=>{if(null==t)return s("Response JSON error");if(t.posters&&0<t.posters.length){i.TheMovieDB=[];for(let e=0;e<t.posters.length;e++)i.TheMovieDB.push("https://image.tmdb.org/t/p/w500"+t.posters[e].file_path)}this._posters=i,e(i)}).catch(e=>s(e))})}}class Subtitle{id;language;source;quality;file;url;date;episode;show;season;constructor(e){this.id=parseInt(e.id,10),this.language=e.language,this.source=e.source,this.quality=parseInt(e.quality,10),this.file=e.file,this.url=e.url,this.date=new Date(e.date),this.show=parseInt(e.show_id,10),this.episode=parseInt(e.episode_id,10),this.season=parseInt(e.season,10)}}!function(e){e.LANGUAGE="language",e.SOURCE="source",e.QUALITY="quality",e.DATE="date"}(SortTypeSubtitles=SortTypeSubtitles||{}),function(e){e.EPISODE="episode",e.SEASON="season",e.SHOW="show"}(SubtitleTypes=SubtitleTypes||{}),function(e){e.ALL="all",e.VOVF="vovf",e.VO="vo",e.VF="vf"}(SubtitleLanguages=SubtitleLanguages||{});class Subtitles{static logger=new UsBetaSeries.setDebug("Subtitles");static debug=Subtitles.logger.debug.bind(Subtitles.logger);subtitles;static fetch(e,t,s=SubtitleLanguages.ALL){const i={id:t.id,language:s};return e===SubtitleTypes.SEASON&&(i.season=t.season),UsBetaSeries.callApi(HTTP_VERBS.GET,"subtitles",e,i).then(e=>new Subtitles(e.subtitles))}constructor(t){if(this.subtitles=[],t&&0<t.length)for(let e=0;e<t.length;e++)this.subtitles.push(new Subtitle(t[e]))}sortBy(s){return this.subtitles.sort((e,t)=>e[s]>t[s]?1:e[s]<t[s]?-1:0)}}class Season extends RenderHtml{static logger=new UsBetaSeries.setDebug("Show:Season");static debug=Season.logger.debug.bind(Season.logger);static selectorsCSS={title:"div.slide__title",nbEpisodes:"div.slide__infos",image:"div.slide__image img",seen:".checkSeen",hidden:".hideIcon"};static relatedProps={number:{key:"number",type:"number",default:0},episodes:{key:"nbEpisodes",type:"number",default:0},seen:{key:"seen",type:"boolean",default:!1},hidden:{key:"hidden",type:"boolean",default:!1},image:{key:"image",type:"string"},has_subtitles:{key:"has_subtitles",type:"boolean",default:!1}};number;episodes;nbEpisodes;has_subtitles;hidden;image;seen;_show;__fetches={};constructor(e,t){const s=e.number?parseInt(e.number,10):null;return super(e,s&&t.elt?jQuery(`#seasons .slides_flex .slide_flex:nth-child(${s.toString()})`):null),this._show=t,this.episodes=[],this.fill(e)._initRender()}_initRender(){if(!this.elt)return this;this.elt.attr("data-number",this.number).attr("data-seen",this.seen?"1":"0").attr("data-hidden",this.hidden?"1":"0").attr("data-episodes",this.nbEpisodes);const e=jQuery(Season.selectorsCSS.nbEpisodes,this.elt);var t=jQuery(Season.selectorsCSS.nbEpisodes+" span.nbEpisodes",this.elt);Season.debug("Season._initRender",e,t),0<e.length&&t.length<=0&&e.empty().append(`<span class="nbEpisodes">${this.nbEpisodes}</span> épisodes`);const s=jQuery(Season.selectorsCSS.image,this.elt);var t=jQuery(Season.selectorsCSS.seen,this.elt),i=jQuery(Season.selectorsCSS.hidden,this.elt);return this.seen&&t.length<=0?s.before('<div class="checkSeen"></div>'):this.hidden&&i.length<=0&&s.before('<div class="hideIcon"></div>'),this}updatePropRenderNbepisodes(){if(this.elt){const e=jQuery(Season.selectorsCSS.nbEpisodes+" span.nbEpisodes",this.elt);0<e.length&&e.text(this.nbEpisodes)}}updatePropRenderImage(){if(this.elt)if(isNull(this.image)&&!isNull(this._show.images.poster))this.image=this._show.images.poster;else if(!isNull(this.image)){const e=jQuery(Season.selectorsCSS.image,this.elt);0<e.length&&e.attr("src")!=this.image&&e.attr("src",this.image)}}get length(){return this.episodes.length}fetchEpisodes(){if(!this.number||this.number<=0)throw new Error("season number incorrect");if(this.__fetches.fepisodes)return this.__fetches.fepisodes;const n=this;var e={id:n._show.id,season:n.number};return this.__fetches.fepisodes=UsBetaSeries.callApi("GET","shows","episodes",e,!0).then(t=>{if(isNull(n.episodes)||n.episodes.length<=0){n.episodes=new Array(t.episodes.length);for(let e=0;e<t.episodes.length;e++){var s=`#episodes .slides_flex .slide_flex:nth-child(${e+1})`;n.episodes[e]=new Episode(t.episodes[e],n,jQuery(s))}}else for(let e=0;e<t.episodes.length;e++){const r=n.getEpisode(t.episodes[e].id);var i;r?r.fill(t.episodes[e]):(Season.debug("Season.checkEpisodes: episode(pos: %d) unknown",e,t.episodes[e]),i=`#episodes .slides_flex .slide_flex:nth-child(${e+1})`,n.episodes.push(new Episode(t.episodes[e],n,jQuery(i))))}return delete n.__fetches.fepisodes,n}).catch(e=>(delete n.__fetches.fepisodes,console.warn("Season.fetchEpisodes error",e),n)),this.__fetches.fepisodes}watched(){const s=this;var e={id:this.episodes[this.length-1].id,bulk:!0};return UsBetaSeries.callApi(HTTP_VERBS.POST,"episodes","watched",e).then(()=>{let t=!1;for(let e=0;e<s.episodes.length;e++)e==s.episodes.length-1&&(t=!0),s.episodes[e].user.seen=!0,s.episodes[e].updateRender("seen",t);return s})}hide(){const s=this;var e={id:this._show.id,season:this.number};return UsBetaSeries.callApi(HTTP_VERBS.POST,"seasons","hide",e).then(()=>{s.hidden=!0,jQuery(`#seasons .slide_flex:nth-child(${s.number}) .slide__image`).prepend('<div class="checkSeen"></div><div class="hideIcon"></div>');let t=!1;for(let e=0;e<s.episodes.length;e++)e==s.episodes.length-1&&(t=!0),s.episodes[e].user.hidden=!0,s.episodes[e].updateRender("hidden",t);return s})}getEpisode(t){for(let e=0;e<this.episodes.length;e++)if(this.episodes[e].id===t)return this.episodes[e];return null}getNbEpisodesSeen(){let t=0;for(let e=0;e<this.episodes.length;e++)this.episodes[e].user.seen&&t++;return t}getNbEpisodesUnwatched(){let t=0;if(this.episodes.length<=0&&!this.seen)return this.nbEpisodes;if(this.episodes.length<=0||this.hidden)return 0;for(let e=0;e<this.episodes.length;e++)this.episodes[e].user.seen||t++;return t}getNbEpisodesSpecial(){let t=0;for(let e=0;e<this.episodes.length;e++)this.episodes[e].special&&t++;return t}updateShow(){return this._show.update()}update(){const t=this;return this.fetchEpisodes().then(()=>{Season.debug("Season.update: episodes",t.episodes);for(const e of t.episodes)if(Season.debug("Season.update: check episode changes",e),e.isModified())return Season.debug("Season.update changed true",t),t.updateRender().updateShow().then(()=>t);return Season.debug("Season.update no changes"),t}).catch(e=>{console.error(e),UsBetaSeries.notification("Erreur de mise à jour des épisodes","Season update: "+e)})}updateRender(){const e=this;var t=this.episodes.length,s=this.getNbEpisodesSpecial(),i=t-s,r=e.getNbEpisodesSeen();Season.debug("Season.updateRender",{lenEpisodes:t,lenSpecials:s,lenNotSpecials:i,lenSeen:r});function n(){e.elt.find(".slide__image").prepend('<div class="checkSeen"></div>'),Season.debug("Season.updateRender: Tous les épisodes de la saison ont été vus",e.elt,e.elt.next()),0<e.elt.next(".slide_flex").length&&(Season.debug("Season.updateRender: Il y a une autre saison"),e.elt.removeClass("slide--current"),e.elt.next(".slide_flex").find(".slide__image").trigger("click")),e.elt.removeClass("slide--notSeen").addClass("slide--seen"),e.seen=!0}if(r===t)n();else if(0<s&&r===i)new PopupAlert({title:"Fin de la saison",text:"Tous les épisodes de la saison, hors spéciaux, ont été vu.<br/>Voulez-vous passer à la saison suivante ?",callback_yes:()=>{n()},callback_no:()=>!0});else{const a=this.elt.find(".checkSeen"),o=(0<a.length&&(a.remove(),e.elt.hasClass("slide--notSeen")||e.elt.addClass("slide--notSeen").removeClass("slide--seen")),jQuery("#episodes .slide_flex.slide--notSeen"));0<o.length&&(jQuery("#episodes .slides_flex").get(0).scrollLeft=o.get(0).offsetLeft-69)}return this}changeCurrentSeason(e){return this._show.setCurrentSeason(e),this}showInAccount(){return this._show.in_account}addShowToAccount(){return this._show.in_account=!0,this}getNextEpisodeUnwatched(){for(let e=0;e<this.episodes.length;e++)if(!this.episodes[e].user.seen)return this.episodes[e];return null}}class Episode extends MediaBase{static logger=new UsBetaSeries.setDebug("Episode");static debug=Episode.logger.debug.bind(Episode.logger);static selectorsCSS={};static relatedProps={characters:{key:"characters",type:"array",default:[]},code:{key:"code",type:"string",default:""},comments:{key:"nbComments",type:"number",default:0},date:{key:"date",type:"date",default:null},description:{key:"description",type:"string",default:""},episode:{key:"number",type:"number",default:0},global:{key:"global",type:"number",default:0},id:{key:"id",type:"number"},note:{key:"objNote",type:Note},platform_links:{key:"platform_links",type:"array",default:[]},resource_url:{key:"resource_url",type:"string",default:""},season:{key:"numSeason",type:"number",default:0},seen_total:{key:"seen_total",type:"number",default:0},special:{key:"special",type:"boolean",default:!1},subtitles:{key:"subtitles",type:"array",default:[]},thetvdb_id:{key:"thetvdb_id",type:"number",default:0},title:{key:"title",type:"string",default:""},user:{key:"user",type:User},youtube_id:{key:"youtube_id",type:"string",default:""}};static fetch(e){return UsBetaSeries.callApi(HTTP_VERBS.GET,"episodes","display",{id:e}).then(e=>new Episode(e.episode,null,jQuery(".blockInformations")))}_season;code;date;director;number;global;numSeason;platform_links;releasesSvod;seen_total;special;subtitles;thetvdb_id;watched_by;writers;youtube_id;__fetches;constructor(e,t,s){return super(e,s),this.__fetches={},this._season=t,this.mediaType={singular:MediaType.episode,plural:"episodes",className:Episode},this.fill(e)._initRender()}_initRender(){if(!this.elt)return this;this._season?(this.initCheckSeen(this.number-1),this.addAttrTitle().addPopup(),this.elt.attr("data-id",this.id).attr("data-code",this.code).attr("data-note-user",this.objNote.user).attr("data-number",this.number).attr("data-season",this.numSeason).attr("data-special",this.special?"1":"0")):super._initRender()}updatePropRenderUser(){if(this.elt){if(this.season){const t=this.elt.find(".checkSeen");this.user.seen&&!t.hasClass("seen")?this.updateRender("seen"):!this.user.seen&&t.hasClass("seen")?this.updateRender("notSeen"):this.user.hidden&&jQuery(".hideIcon",this.elt).length<=0&&this.updateRender("hidden")}else{const s=jQuery("#reactjs-episode-actions",this.elt);var e=s.data("episodeUserHasSeen");(this.user.seen&&e.length<=0||!this.user.seen&&"1"===e)&&this.updateBtnSeen()}delete this.__changes.user}}updateBtnSeen(){if(this.elt&&!this.season){var e={seen:'<svg fill="#54709D" width="17.6" height="13.4" viewBox="2 3 12 10" xmlns="http://www.w3.org/2000/svg"><path fill="inherit" d="M6 10.78l-2.78-2.78-.947.94 3.727 3.727 8-8-.94-.94z"></path></svg>',notSeen:'<svg fill="#FFF" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M16 2v14H2V2h14zm0-2H2C.9 0 0 .9 0 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V2c0-1.1-.9-2-2-2z" fill-rule="nonzero"></path></svg>'};const s=jQuery("#reactjs-episode-actions"),i=jQuery("button svg",s);var t=s.data("episodeUserHasSeen");this.user.seen&&t.length<=0?i.replaceWith(e.seen):this.user.seen||"1"!==t||i.replaceWith(e.notSeen)}}get season(){return this._season}set season(e){this._season=this.season}addAttrTitle(){return this.elt&&this.elt.find(".slide__title").attr("title",this.title),this}addPopup(){if(!this.elt||!this._season)return this;var e;const t=jQuery(".slide__image",this.elt);return 0<t.length&&(e=350<this.description.length?this.description.substring(0,350)+"…":this.description.length<=0?"Aucune description":this.description,t.popover({container:t.get(0),delay:{show:500,hide:100},html:!0,content:`<p>${e}</p>`,placement:(e,t)=>{var t=t.getBoundingClientRect(),s=jQuery(window).width();return t.left+t.width+320>s?"left":"right"},title:`<div><span style="color: var(--link_color);">Episode ${this.code}</span><div class="stars-outer note"><div class="stars-inner" style="width:${this.objNote.getPercentage()}%;" title="${this.objNote.toString()}"></div></div></div>`,trigger:"hover",boundary:"window"})),this}initCheckSeen(e){const t=jQuery(".checkSeen",this.elt);return 0<t.length&&this.user.seen?(t.attr("id","episode-"+this.id),t.attr("data-id",this.id),t.attr("data-pos",e),t.attr("data-special",this.special?"1":"0"),t.attr("title",UsBetaSeries.trans("member_shows.remove")),t.addClass("seen")):t.length<=0&&!this.user.seen&&!this.user.hidden?(this.elt.find(".slide__image").append(`<div id="episode-${this.id}"
                                class="checkSeen"
                                data-id="${this.id}"
                                data-pos="${e}"
                                data-special="${this.special?"1":"0"}"
                                style="background: rgba(13,21,28,.2);"
                                title="${UsBetaSeries.trans("member_shows.markas")}"></div>`),this.elt.find(".slide__image img.js-lazy-image").attr("style","filter: blur(5px);")):0<t.length&&this.user.hidden&&t.remove(),this}updateCheckSeen(e){const t=this.elt.find(".checkSeen");let s=!1;return 0<t.length&&void 0===t.attr("id")&&(Episode.debug("ajout de l'attribut ID à l'élément \"checkSeen\""),t.attr("id","episode-"+this.id),t.data("id",this.id),t.data("pos",e),t.data("special",this.special?"1":"0")),this.user.seen&&0<t.length&&!t.hasClass("seen")?(Episode.debug("Changement du statut (seen) de l'épisode %s",this.code),this.updateRender("seen",!1),s=!0):!this.user.seen&&0<t.length&&t.hasClass("seen")?(Episode.debug("Changement du statut (notSeen) de l'épisode %s",this.code),this.updateRender("notSeen",!1),s=!0):this.user.hidden&&0<t.length&&(t.remove(),this.updateRender("hidden",!1),s=!0),this.updateTitle(),s}updateTitle(){const e=this.elt.find(".slide__title");this.code.toUpperCase()+" - "+this.title!==e.text().trim()&&e.text(this.code.toUpperCase()+" - "+this.title)}markAsView(){this.updateStatus("seen",HTTP_VERBS.POST)}markAsUnview(){this.updateStatus("unseen",HTTP_VERBS.DELETE)}updateStatus(s,i){const r=this,n=this.elt.find(".checkSeen").data("pos"),e={id:this.id,bulk:!0};let t=new Promise(e=>{e(!1)});if(this.toggleSpinner(!0),i===HTTP_VERBS.POST){const a=jQuery("#episodes .checkSeen");for(let e=0;e<n;e++)if(!$(a.get(e)).hasClass("seen")){t=new Promise(e=>{new PopupAlert({title:"Episodes vus",contentHtml:"<p>Doit-on cocher les épisodes précédents comme vu ?</p>",yes:UsBetaSeries.trans("popup.yes"),no:UsBetaSeries.trans("popup.no"),callback_yes:()=>{e(!0)},callback_no:()=>{e(!1)}});const t=jQuery("#popin-dialog #popupalertno"),s=jQuery("#popin-dialog #popupalertyes");t.attr("tabIndex",0).focus(),s.attr("tabIndex",0).show()});break}}t.then(t=>{i!==HTTP_VERBS.POST||t||(e.bulk=!1),UsBetaSeries.callApi(i,"episodes","watched",e).then(e=>{if(Episode.debug("updateStatus %s episodes/watched",i,e),r._season&&!r._season.showInAccount()&&e.episode.show.in_account&&r._season.addShowToAccount(),r._season&&i===HTTP_VERBS.POST&&t&&n){const s=jQuery("#episodes .slide_flex");let t=null;for(let e=0;e<n;e++)null===(t=r._season.episodes[e]).elt&&(t.elt=jQuery(s.get(e))),t.user.seen||(t.user.seen=!0,t.updateRender("seen",!1).save())}r.fill(e.episode)._callListeners(EventTypes.UPDATE),r.season&&r.season.updateRender().updateShow().then(()=>{const e=jQuery("#episodes .slide_flex.slide--notSeen");0<e.length&&(jQuery("#episodes .slides_flex").get(0).scrollLeft=e.get(0).offsetLeft-69),r.toggleSpinner(!1)})}).catch(e=>{console.error("updateStatus error %s",e),e&&"changeStatus"==e?(Episode.debug("updateStatus error %s changeStatus",i),r.user.seen="seen"===s,r.updateRender(s),r.season&&r._season.updateRender().updateShow().then(()=>{r.toggleSpinner(!1)})):(r.toggleSpinner(!1),UsBetaSeries.notification("Erreur de modification d'un épisode","updateStatus: "+e))})})}updateRender(e,t=!0){const s=this.elt.find(".checkSeen");if(Episode.debug("Episode.changeStatus (season: %d, episode: %d, statut: %s)",this.season.number,this.number,e,{elt:s,update:t}),"seen"===e)s.css("background",""),s.addClass("seen"),s.attr("title",UsBetaSeries.trans("member_shows.remove")),s.parents("div.slide__image").first().find("img").removeAttr("style"),s.parents("div.slide_flex").first().removeClass("slide--notSeen");else if("notSeen"===e){s.css("background","rgba(13,21,28,.2)"),s.removeClass("seen"),s.attr("title",UsBetaSeries.trans("member_shows.markas")),s.parents("div.slide__image").first().find("img").attr("style","filter: blur(5px);");const i=s.parents("div.slide_flex").first();i.hasClass("slide--notSeen")||i.addClass("slide--notSeen")}else"hidden"===e&&(s.removeClass("seen"),s.parents(".slide__image").append('<div class="hideIcon"></div>').attr("style","filter: blur(5px);"));return this}toggleSpinner(e){return e?(Episode.logger.enabled&&console.groupCollapsed("episode checkSeen"),this.elt.find(".slide__image").first().prepend(`
                <div class="spinner">
                    <div class="spinner-item"></div>
                    <div class="spinner-item"></div>
                    <div class="spinner-item"></div>
                </div>`)):(jQuery(".spinner").remove(),Episode.logger.enabled&&console.groupEnd()),this}getDefaultImage(){return new Promise(e=>e(UsBetaSeries.api.url+"/pictures/episodes?id="+this.id))}fetchCharacters(){const s=this;return this.__fetches.characters||(this.__fetches.characters=UsBetaSeries.callApi(HTTP_VERBS.GET,"episodes","characters",{id:this.id},!0).then(t=>{if(s.characters=[],t?.characters?.length<=0)return s;for(let e=0;e<t.characters.length;e++)s.characters.push(new Character(t.characters[e]));return s}).finally(()=>delete s.__fetches.characters),this.__fetches.characters)}}class Similar extends Media{static logger=new UsBetaSeries.setDebug("Similar");static debug=Similar.logger.debug.bind(Similar.logger);static relatedProps={};backdrop;director;original_release_date;other_title;platform_links;poster;production_year;release_date;sale_date;tagline;tmdb_id;trailer;url;aliases;creation;country;images;nbEpisodes;network;next_trailer;next_trailer_host;rating;pictures;platforms;seasons;nbSeasons;showrunner;social_links;status;thetvdb_id;persons;constructor(e,t){return t.singular===MediaType.movie&&(e.in_account=e.user.in_account,delete e.user.in_account,e.description=e.synopsis,delete e.synopsis),super(e),this.mediaType=t,this.fill(e)}fill(e){return this.mediaType.singular===MediaType.show?(Similar.relatedProps=Show.relatedProps,this.seasons=[],this.persons=[]):this.mediaType.singular===MediaType.movie&&(Similar.relatedProps=Movie.relatedProps,this.platform_links=[]),super.fill(e),this}fetch(e=!0){let t="display";return this.mediaType.singular===MediaType.movie&&(t="movie"),UsBetaSeries.callApi("GET",this.mediaType.plural,t,{id:this.id},e)}addViewed(){const e=this.elt.find("a.slide__image");return this.user.status&&(this.mediaType.singular===MediaType.movie&&1===this.user.status||this.mediaType.singular===MediaType.show&&0<this.user.status)&&e.prepend(`<img src="${UsBetaSeries.serverBaseUrl}/img/viewed.png" class="bandViewed"/>`),e.attr("data-id",this.id).attr("data-type",this.mediaType.singular),this}wrench(t){const e=this.elt.find(".slide__title"),s=this;return e.html(e.html()+`<i class="fa-solid fa-wrench popover-wrench"
                aria-hidden="true"
                style="margin-left:5px;cursor:pointer;"
                data-id="${s.id}"
                data-type="${s.mediaType.singular}">
            </i>`),e.find(".popover-wrench").click(e=>{e.stopPropagation(),e.preventDefault(),this.fetch().then(function(e){t.setContent(renderjson.set_show_to_level(2)(e[s.mediaType.singular])),t.setCounter(UsBetaSeries.counter.toString()),t.setTitle("Données du similar"),t.show()})}),this}async getContentPopup(){const t=this;let e=this.description,s=(200<e.length&&(e=e.substring(0,200)+"…"),"");function i(){let e="";return(t.creation||t.country||t.production_year)&&(e+="<p>",t.production_year&&(e+=`<u>Production:</u> <strong>${t.production_year}</strong>`),t.country&&(e+=`<u>Pays:</u> <strong>${t.country}</strong>`),t.creation&&(e+=`<span style="margin-left:5px;">${t.creation}</span>`),e+="</p>"),e}function r(){return t.genres&&0<t.genres.length?"<p><u>Genres:</u> "+t.genres.join(", ")+"</p>":""}if(s="<div>",this.mediaType.singular===MediaType.show){var n=`<i class="fa-solid fa-${"ended"==this.status.toLowerCase()?"octagon-exclamation":"spinner"}" title="Statut ${"ended"==this.status.toLowerCase()?"terminé":"en cours"}" aria-hidden="true"></i>`,a=0<this.user.status?"Vu à <strong>"+this.user.status+"%</strong>":"Pas vu";if(s+=`<p>
                <strong>${this.nbSeasons}</strong> saison${1<this.nbSeasons?"s":""},
                <strong>${this.nbEpisodes}</strong> <i class="fa-solid fa-films" title="épisodes" aria-hidden="true"></i>, `,0<this.objNote.total?(s+=`<strong>${this.objNote.total}</strong> votes`,0<this.objNote.user&&(s+=", votre note: "+this.objNote.user)):s+="Aucun vote",s+=`<span style="margin-left:5px;"><strong>${t.nbComments}</strong> <i class="fa-solid fa-comments" title="commentaires" aria-hidden="true"></i></span>`,!this.in_account){s+=`<span style="margin-left:5px;">
                    <a href="javascript:;" class="addShow"><i class="fa-solid fa-plus" title="Ajouter" aria-hidden="true"></i></a> -`;const l=await UsBetaSeries.gm_funcs.getValue("toSee",[]);var o=l.includes(this.id);s+=o?`<a href="javascript:;" class="toSeeShow" data-show-id="${t.id}">
                        <i class="fa-solid fa-clock-rotate-left" title="Ne plus voir" aria-hidden="true"></i>
                    </a></span>`:`<a href="javascript:;" class="toSeeShow" data-show-id="${t.id}">
                        <i class="fa-solid fa-user-clock" title="A voir" aria-hidden="true"></i>
                    </a></span>`}s=(s=(s+="</p>")+r())+i();let e="";0<this.user.status&&!0===this.user.archived?e=', Archivée: <i class="fa-solid fa-circle-check" aria-hidden="true"></i>':0<this.user.status&&(e=', Archivée: <i class="fa-solid fa-circle" aria-hidden="true"></i>'),this.showrunner&&0<this.showrunner.name.length&&(s+=`<p><u>Show Runner:</u> <strong>${this.showrunner.name}</strong></p>`),s+=`<p><u>Statut:</u> ${n}, ${a}${e}</p>`}else s+="<p>",0<this.objNote.total?(s+=`<strong>${this.objNote.total}</strong> votes`,0<this.objNote.user&&(s+=", votre note: "+this.objNote.user)):s+="Aucun vote",s=(s=(s=(s=(s=(s=(s=s+`<span style="margin-left:5px;"><strong>${t.nbComments}</strong> <i class="fa-solid fa-comments" title="commentaires" aria-hidden="true"></i></span>`+"</p>")+`<p><label for="seen">Vu</label>
                <input type="radio" class="movie movieSeen" name="movieState" value="1" data-movie="${this.id}" ${1===this.user.status?"checked":""} style="margin-right:5px;vertical-align:middle;"></input>`)+`<label for="mustSee">A voir</label>
                <input type="radio" class="movie movieMustSee" name="movieState" value="0" data-movie="${this.id}" ${0===this.user.status?"checked":""} style="margin-right:5px;vertical-align:middle;"></input>`)+`<label for="notSee">Ne pas voir</label>
                <input type="radio" class="movie movieNotSee" name="movieState" value="2" data-movie="${this.id}"  ${2===this.user.status?"checked":""} style="vertical-align:middle;"></input>`)+`<button class="btn btn-danger reset" style="margin-left:10px;padding:2px 5px;${this.user.status<0?"display:none;":""}">Reset</button></p>`)+r())+i(),this.director&&(s+=`<p><u>Réalisateur:</u> <strong>${this.director}</strong></p>`);return s+`<p>${e}</p></div>`}getTitlePopup(){let e=this.title;return 0<this.objNote.total&&(e+=' <span style="font-size: 0.8em;color:var(--link_color);">'+this.objNote.mean.toFixed(2)+" / 5</span>"),this.mediaType.singular===MediaType.show&&(e+=` <span style="float:right;">
                <a href="http://www.thetvdb.com/?tab=series&id=${this.thetvdb_id}" target="_blank" title="Lien vers la page de TheTVDB">
                    <img src="https://thetvdb.com/images/logo.svg" width="40px" />
                </a>
                <a href="javascript:;" onclick="showUpdate('${this.title}', ${this.id}, '0')" style="margin-left:5px; color:var(--default_color);" title="Mettre à jour les données venant de TheTVDB">
                    <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i>
                </a>
            </span>`),e}updateTitleNote(e=!0){const t=this.elt.find(".stars-outer");if(this.objNote.mean<=0||this.objNote.total<=0)return e&&t.attr("title","Aucun vote"),"";var s=this.objNote.toString();return e&&t.attr("title",s),s}renderStars(){return this.elt.find(".slide__title").after('<div class="stars-outer"><div class="stars-inner"></div></div>'),this.updateTitleNote(),this.elt.find(".stars-inner").width(this.objNote.getPercentage()+"%"),this}checkImg(){const e=this.elt.find("img.js-lazy-image"),i=this;if(0<e.length)return this;if(this.mediaType.singular===MediaType.show)if(null!==this.images.poster)this.elt.find("div.block404").replaceWith(`
                    <img class="u-opacityBackground fade-in"
                            width="125"
                            height="188"
                            alt="Affiche de la série ${this.title}"
                            src="${this.images.poster}"/>`);else{const s=UsBetaSeries.serverBaseUrl+"/posters/",r={method:"GET",headers:{origin:"https://www.betaseries.com","x-requested-with":"userscript-bs"},mode:"cors",cache:"no-cache"};this._getTvdbUrl(this.thetvdb_id).then(e=>{e&&(e=new URL(e),fetch(s+e.pathname,r).then(e=>e.ok?e.text():null).then(e=>{if(null!=e){const t=new DOMParser,s=t.parseFromString(e,"text/html");e=s.querySelector('.container .row a[rel="artwork_posters"]');e&&this.elt.find("div.block404").replaceWith(`
                                <img class="u-opacityBackground fade-in"
                                        width="125"
                                        height="188"
                                        alt="Affiche de la série ${i.title}"
                                        src="${e.href}"/>`)}}))})}else if(this.mediaType.singular===MediaType.movie&&this.tmdb_id&&0<this.tmdb_id){if(UsBetaSeries.themoviedb_api_user_key.length<=0)return;var t=`https://api.themoviedb.org/3/movie/${this.tmdb_id}?api_key=${UsBetaSeries.themoviedb_api_user_key}&language=fr-FR`;fetch(t).then(e=>e.ok?e.json():null).then(e=>{null!==e&&void 0!==e.poster_path&&null!==e.poster_path&&i.elt.find("div.block404").replaceWith(`
                        <img class="u-opacityBackground fade-in"
                                width="125"
                                height="188"
                                alt="Poster de ${i.title}"
                                src="https://image.tmdb.org/t/p/original${e.poster_path}"/>`)})}return this}addToAccount(e=0){return this.in_account?Promise.resolve(this):this.changeState(e)}changeState(e){if(e<-1||2<e)throw new Error("Parameter state is incorrect: "+e.toString());const t=this,s={id:this.id};let i=HTTP_VERBS.POST;return-1===e&&this.mediaType.singular===MediaType.movie?i=HTTP_VERBS.DELETE:this.mediaType.singular===MediaType.movie&&(s.state=e),UsBetaSeries.callApi(i,this.mediaType.plural,this.mediaType.singular,s).then(e=>(t.fill(e[t.mediaType.singular]),i===HTTP_VERBS.DELETE&&(t.in_account=!1,t.user.status=-1,t.save()),t)).catch(e=>(console.warn("Erreur changeState similar",e),UsBetaSeries.notification("Change State Similar","Erreur lors du changement de statut: "+e.toString()),t))}addVote(e){throw new Error("On ne vote pas pour un similar")}}class UpdateAuto{static logger=new UsBetaSeries.setDebug("UpdateAuto");static debug=UpdateAuto.logger.debug.bind(UpdateAuto.logger);static instance;static intervals=[{val:0,label:"Jamais"},{val:1,label:"1 min."},{val:5,label:"5 min."},{val:10,label:"10 min."},{val:15,label:"15 min."},{val:30,label:"30 min."},{val:45,label:"45 min."},{val:60,label:"60 min."}];_show;_showId;_exist;_status;_auto;_interval;_timer;_lastUpdate;constructor(e){return UpdateAuto.instance||(this._show=e,this._showId=e.id,this)}async _init(){var e=await UsBetaSeries.gm_funcs.getValue("objUpAuto",{});return this._exist=!1,this._lastUpdate=null,void 0!==e[this._showId]?(this._exist=!0,this._status=e[this._showId].status,this._auto=e[this._showId].auto,this._interval=e[this._showId].interval):(this._status=!1,this._auto=!1,this._interval=0),this.changeColorBtn(),this}static getInstance(e){return!UpdateAuto.instance&&e?(UpdateAuto.instance=new UpdateAuto(e),this.instance._init()):UpdateAuto.instance||e?Promise.resolve(UpdateAuto.instance):Promise.reject("Parameter Show required")}async _save(){const e=await UsBetaSeries.gm_funcs.getValue("objUpAuto",{});var t={status:this._status,auto:this._auto,interval:this._interval};return e[this._showId]=t,UsBetaSeries.gm_funcs.setValue("objUpAuto",e),this._exist=!0,this.changeColorBtn(),this}toJSON(){return{status:this.status,auto:this.auto,interval:this.interval}}get show(){return this._show}get status(){return this._status}set status(e){if("boolean"!=typeof e)throw new TypeError("UpdateAuto.set status: Parameter type error. Required type: boolean");this._status=e,this._save()}get auto(){return this._auto}set auto(e){if("boolean"!=typeof e)throw new TypeError("UpdateAuto.set auto: Parameter type error. Required type: boolean");this._auto=e}get interval(){return this._interval}set interval(e){if("number"!=typeof e)throw new TypeError("UpdateAuto.set interval: Parameter type error. Required type: number");this._interval=e}get lastUpdate(){return this._lastUpdate}changeColorBtn(){let e="#fff";return this._exist?this._status&&this._auto?e="#28a745":this._auto&&!this._status?e="#fd7e14":this._auto||this._status||(e="#dc3545"):e="#6c757d",$(".updateEpisodes").css("color",e),this}stop(){return this.status?(UpdateAuto.debug("%cUpdateAuto%c: task stop","color:#fd7e14","color:inherit"),this._show.user.remaining<=0&&this._show.isEnded()?(this._auto=!1,this._interval=0):this._show.user.remaining<=0&&(this._auto=!1),this.status=!1,clearInterval(this._timer),this._timer=null,this._lastUpdate=null,this.changeColorBtn()):UpdateAuto.debug("%cUpdateAuto%c: task stop (%cnot started%c)","color:#fd7e14","color:inherit","color:#dc3545","color:inherit"),this}async delete(){if(!this._exist)return UpdateAuto.debug("%cUpdateAuto%c: task delete (%cnot exists%c)","color:#dc3545","color:inherit","color:#fd7e14","color:inherit"),Promise.resolve(this);UpdateAuto.debug("%cUpdateAuto%c: task delete","color:#dc3545","color:inherit"),this.stop();const e=await UsBetaSeries.gm_funcs.getValue("objUpAuto",{});return void 0!==e[this._showId]&&(delete e[this._showId],UsBetaSeries.gm_funcs.setValue("objUpAuto",e),this._auto=!1,this._interval=0,this._exist=!1,this.changeColorBtn()),this}launch(){if(this.status&&(!this.auto||this.interval<=0))return UpdateAuto.debug("close interval updateEpisodeListAuto"),this.stop();if(this.auto&&0<this.interval){if(this._show.user.remaining<=0)return 0<this._show.currentSeason.getNbEpisodesUnwatched()&&this._tick(),this.stop(),this;this._timer&&(UpdateAuto.debug("close old interval timer"),clearInterval(this._timer)),UpdateAuto.debug("%cUpdateAuto%c: task launch","color:#28a745","color:inherit"),this.status||(this.status=!0),this._tick(),this._timer=setInterval(this._tick.bind(this),60*this.interval*1e3),this.changeColorBtn()}return this}_tick(){this._lastUpdate=Date.now(),UpdateAuto.debug("[%s] UpdateAuto tick",(new Date).format("datetime")),jQuery("#episodes .updateEpisodes").trigger("click"),this.status||(this.status=!0),(!this.auto||this.show.user.remaining<=0)&&(UpdateAuto.debug("Arrêt de la mise à jour auto des épisodes"),this.stop())}remaining(){if(null==this._lastUpdate)return"not running";var e=Date.now()-this._lastUpdate,e=Math.floor((60*this._interval*1e3-e)/1e3);const t=Math.floor(e/60),s=e-60*t;return t.toString()+":"+(s<10?"0"+s.toString():s.toString())}}!function(e){e.monday="lundi",e.tuesday="mardi",e.wednesday="mercredi",e.thursday="jeudi",e.friday="vendredi",e.saturday="samedi",e.sunday="dimanche"}(DaysOfWeek=DaysOfWeek||{});class Stats{friends;shows;seasons;episodes;comments;progress;episodes_to_watch;time_on_tv;time_to_spend;movies;badges;member_since_days;friends_of_friends;episodes_per_month;favorite_day;five_stars_percent;four_five_stars_total;streak_days;favorite_genre;written_words;without_days;shows_finished;shows_current;shows_to_watch;shows_abandoned;movies_to_watch;time_on_movies;time_to_spend_movies;constructor(e){for(const t in Object.keys(e))this[t]=e[t]}}class OptionsMember{downloaded;notation;timelag;global;specials;episodes_tri;friendship;country;language;mail_mois;mail_hebdo;notification_news;twitter_auto;constructor(e){for(const t in Object.keys(e))this[t]=e[t]}}class Member{static logger=new UsBetaSeries.setDebug("Member");static debug=Member.logger.debug.bind(Member.logger);static relatedProps={id:{key:"id",type:"number"},fb_id:{key:"fb_id",type:"number"},login:{key:"login",type:"string"},xp:{key:"xp",type:"number"},locale:{key:"locale",type:"string"},cached:{key:"cached",type:"number"},avatar:{key:"avatar",type:"string"},profile_banner:{key:"profile_banner",type:"string"},in_account:{key:"in_account",type:"boolean"},is_admin:{key:"is_admin",type:"boolean",default:!1},subscription:{key:"subscription",type:"number"},valid_email:{key:"valid_email",type:"boolean",default:!1},screeners:{key:"screeners",type:"array<string>",default:[]},twitterLogin:{key:"twitterLogin",type:"string"},stats:{key:"stats",type:Stats},options:{key:"options",type:OptionsMember}};static fetch(){const e={};return null!==UsBetaSeries.userId&&(e.id=UsBetaSeries.userId),UsBetaSeries.callApi(HTTP_VERBS.GET,"members","infos",e).then(e=>new Member(e.member)).catch(e=>{throw console.warn("Erreur lors de la récupération des infos du membre",e),new Error("Erreur de récupération du membre")})}id;fb_id;login;xp;locale;cached;avatar;profile_banner;in_account;is_admin;subscription;valid_email;screeners;twitterLogin;stats;options;_notifications;__decorators={fill:new FillDecorator(this)};__initial=!0;__changes={};__props=[];elt;constructor(e){return this.notifications=new NotificationList,this.fill(e)}get notifications(){return this._notifications}set notifications(e){if(!(e instanceof NotificationList))throw new TypeError("Property notifications must be an instance of NotificationList");this._notifications=e;this._notifications.on(EventTypes.NEW,function(e){Member.debug("NotificationList.setter notifications - function addBadgeNotifs",e,this),0<jQuery(".menu-icon--bell").length&&jQuery(".menu-icon--bell").replaceWith('<span class="menu-icon menu-icon-bell fa-solid fa-bell"></span>');const t=jQuery(".menu-item.js-growl-container .menu-icon-bell"),s=jQuery("#menuUnseenNotifications");this.hasNew()?s.length<=0?jQuery(".menu-wrapper .js-iconNotifications").append(`<i class="unread-count unread-notifications" id="menuUnseenNotifications">${this.new.length}</i>`):s.text(this.new.length):0<s.length&&s.remove(),t.toggleClass("fa-shake",this.hasNew())}).on(EventTypes.SEEN,function(e){Member.debug("NotificationList.setter notifications - function removeBadgeNotifs",e,this),jQuery("#menuUnseenNotifications").remove(),jQuery(".menu-item.js-growl-container .menu-icon-bell").removeClass("fa-shake"),localStorage.setItem("notifications",JSON.stringify(this))})}fill(e){try{return this.__decorators.fill.fill.call(this,e)}catch(e){console.error(e)}}updatePropRender(e){try{this.__decorators.fill.updatePropRender.call(this,e)}catch(e){console.error(e)}}toJSON(){const e={};for(const t of this.__props)e[t]=this[t];return e}checkNotifs(){var e=()=>{NotificationList.fetch(50).then(e=>{this.notifications=e})};setInterval(e,3e5),e()}addNotifications(s){isNull(this.notifications)&&(this.notifications=new NotificationList);for(let e=0,t=s.length;e<t;e++)this.notifications.add(new NotificationBS(s[e]));this.notifications.sort()}renderNotifications(){const e=jQuery("#growl"),t=jQuery("#growl .notifications__loader"),s=jQuery("#growl .notification.notification--delete-all"),i=jQuery("#growl .js-notificationsNew-list"),r=jQuery("#growl .js-notificationsOld-list"),n=jQuery("#growl .notificationsList"),a={old:r,new:i};i.empty(),r.empty(),s.hide(),n.hide(),e.addClass("visible"),t.show();for(const o of this.notifications){for(let e=0;e<this.notifications[o].length;e++)a[o].append(this.notifications[o][e].render());0<this.notifications[o].length&&a[o].parents(".notificationsList").show()}t.hide(),0<this.notifications.length&&(s.show(),0<this.notifications.new.length&&(this.notifications.seen=!0),jQuery("#menuUnseenNotifications").remove())}}!function(e){e.episode="episode",e.reportNew="report_new",e.reportTreated="report_treated",e.xpMany="xp_many",e.bugResolved="bug_resolved",e.bugCommented="bug_commented",e.poll="poll",e.season="season",e.comment="comment",e.badge="badge",e.banner="banner",e.character="character",e.movie="movie",e.forum="forum",e.friend="friend",e.message="message",e.quizz="quizz",e.recommend="recommend",e.site="site",e.subtitles="subtitles",e.video="video"}(NotifTypes=NotifTypes||{});class NotifPayload{static props=[{key:"url",type:"string",default:""},{key:"title",type:"string",default:""},{key:"code",type:"string",default:""},{key:"show_title",type:"string",default:""},{key:"picture",type:"string",default:""},{key:"season",type:"number",default:0},{key:"name",type:"string",default:""},{key:"xp",type:"number",default:0},{key:"user",type:"string",default:""},{key:"user_id",type:"number",default:0},{key:"user_picture",type:"string",default:"https://img.betaseries.com/5gtv-uQY0aSPqDtcyu7rhHLcu6Q=/40x40/smart/https%3A%2F%2Fwww.betaseries.com%2Fimages%2Fsite%2Flogo-64x64.png"},{key:"type",type:"string",default:""},{key:"type_id",type:"number",default:0}];url;title;code;show_title;picture;season;name;xp;user;user_id;user_picture;type;type_id;constructor(s){if(!s)return this;let i,r;for(let e=0,t=NotifPayload.props.length;e<t;e++)i=NotifPayload.props[e],r=NotifPayload.props[e].default,Reflect.has(s,i.key)&&!isNull(s[i.key])&&(r="string"===i.type?String(s[i.key]).trim():parseInt(s[i.key],10)),this[i.key]=r}}class NotificationList{static logger=new UsBetaSeries.setDebug("Notification");static debug=NotificationList.logger.debug.bind(NotificationList.logger);static EventTypes=[EventTypes.SEEN,EventTypes.NEW];static fetch(e=20){e={all:!0,sort:"DESC",number:e};return UsBetaSeries.callApi(HTTP_VERBS.GET,"members","notifications",e).then(t=>{const s=new NotificationList;for(let e=0;e<t.notifications.length;e++)s.add(new NotificationBS(t.notifications[e]));return s})}static fromJSON(s){const i=new NotificationList;for(const r of["new","old"])for(let e=0,t=s[r].length;e<t;e++)i.add(s[r][e]);return isNull(s.seen)||(i.seen=s.seen),i}old;new;seen;__decorators={emitter:new EmitterDecorator(this)};constructor(){this.old=[],this.new=[],this.seen=!1}hasListeners(e){return this.__decorators.emitter.hasListeners(e)}on(e,t){return this.__decorators.emitter.on(e,t)}off(e,t){return this.__decorators.emitter.off(e,t)}once(e,t){return this.__decorators.emitter.once(e,t)}emit(e){return this.__decorators.emitter.emit(e)}*[Symbol.iterator](){yield"new",yield"old"}get length(){return this.old.length+this.new.length}add(e){var t=null===(e=e instanceof NotificationBS?e:new NotificationBS(e)).seen?"new":"old";this[t].push(e),"new"==t&&this.emit(EventTypes.NEW)}sort(){var e=(e,t)=>isNull(e)||isNull(t)?0:e.date.getTime()>t.date.getTime()?-1:e.date.getTime()<t.date.getTime()?1:0;return this.new.sort(e),this.old.sort(e),this}markAllAsSeen(){if(this.seen&&0<this.new.length){for(let e=this.new.length-1;0<=e;e--)this.new[e].seen=new Date,this.old.unshift(this.new[e]);this.new=[],this.seen=!1,this.emit(EventTypes.SEEN)}}getLastId(){return 0<this.new.length?this.new[0].id:0<this.old.length?this.old[0].id:null}hasNew(){return 0<this.new.length}toJSON(){return{new:this.new,old:this.old,seen:this.seen}}}class NotificationBS{id;type;ref_id;text;html;date;seen;payload;constructor(e){this.id=parseInt(e.id,10),this.type=NotifTypes[String(e.type).camelCase()],this.ref_id=parseInt(e.ref_id,10),this.text=e.text,this.html=e.html,this.date=new Date(e.date),this.seen=null!=e.seen?new Date(e.seen):null,this.payload=new NotifPayload(e.payload)}render(){if(0===this.text.length)return null;let e;e=0<this.payload.user.length?`<a
                    href="https://www.betaseries.com/membre/${this.payload.user}"
                    target="_blank" class="avatar" data-displaylink="1"
                    >
                <img src="${this.payload.user_picture}" width="40" height="40" alt="avatar" />
            </a>`:`<span class="avatar"><img src="${this.payload.user_picture}" width="40" height="40" alt="avatar" /></span>`;var t=0<this.payload.picture?.length?`<div class="notification__image alignSelfFlexStart" data-displayimage="1"}"><img src="${this.payload.picture}" alt="image ${this.type}" height="38" width="38" /></div>`:"";return`
            <div
                class="notification${null==this.seen?" notification--unread":""}"
                id="i${this.id.toString()}"
                data-ref-id="${this.ref_id.toString()}"
                data-type="${this.type}"
            >
                <div class="media">
                    <div class="media-left">${e}</div>
                    <div class="media-body">
                        <div class="displayFlex">
                            <div class="notification__text alignSelfFlexStart">
                                <p>${this.html}</p>
                                <div class="notification__datas">
                                    <span class="mainTime" title="${this.date.format("datetime")}">${this.date.duration()}</span>
                                    <button type="button" class="btn-reset" onclick="deleteNotification('${this.id.toString()}');"><span class="mainTime">∙</span> Masquer</button>
                                </div>
                            </div>
                            ${t}
                        </div>
                    </div>
                </div>
            </div>`.trim()}}class ParamsSearchAbstract{static valuesAllowed={};static valuesDefault;static separator=",";text;_limit;_offset;genres;_diffusions;svods;_tri;_autres;_fields;constructor(){this._diffusions=[],this._fields=[],this._limit=ParamsSearchAbstract.valuesDefault.limit,this._offset=ParamsSearchAbstract.valuesDefault.offset,this._tri=ParamsSearchAbstract.valuesDefault.tri,this.genres=[],this.svods=[]}get limit(){return this._limit}set limit(e){if(e<=0||100<e)throw new RangeError("Value of parameter 'limit' is out of range (1-100)");this._limit=e}get offset(){return this._offset}set offset(e){if(e<=0||100<e)throw new RangeError("Value of parameter 'offset' is out of range (1-100)");this._offset=e}get diffusions(){return this._diffusions}set diffusions(e){const t=this.constructor.valuesAllowed.diffusions;this._diffusions=e.filter(e=>{if(t.includes(e))return!0;throw new Error(`Value(${e}) of parameter 'diffusions' is not allowed`)})}get tri(){return this._tri}set tri(e){const t=this.constructor.valuesAllowed.tri;let s=e,i=null;if(0<e.indexOf("-")&&(s=e.split("-")[0],i=e.split("-")[1]),!t.includes(s))throw new Error("Value of parameter 'tri' is not allowed");if(i&&!["asc","desc"].includes(i))throw new Error("Value of parameter 'sort' is not allowed");this._tri=i?s+"-"+i:s}get fields(){return this._fields}set fields(e){const t=this.constructor.valuesAllowed.fields;this._fields=e.filter(e=>{if(t.includes(e))return!0;throw new Error(`Value(${e}) of parameter 'fields' is not allowed`)})}get autres(){return this._autres}set autres(e){const t=this.constructor.valuesAllowed.autres;if(!t.includes(e))throw new Error("Value of parameter 'autres' is not allowed");this._autres=e}}class ParamsSearchShows extends ParamsSearchAbstract{static valuesAllowed={diffusions:["semaine","fini","encours"],duration:["1-19","20-30","31-40","41-50","51-60","61"],tri:["nom","suivis","id","note","popularite","release"],autres:["new","mine"],fields:["id","following","release_date","poster","svods","slug","title"]};_duration;_creations;_pays;chaines;constructor(){super(),this._creations=[],this._pays=[]}getDurationAllowed(){return ParamsSearchShows.valuesAllowed.duration}get duration(){return this._duration}set duration(e){if(!ParamsSearchShows.valuesAllowed.duration.includes(e))throw new Error("Value of parameter 'duration' is not allowed");this._duration=e}get creations(){return this._creations}set creations(e){this._creations=e.filter(e=>{if(e<=1900||2100<e)throw new Error(`Value(${e.toString()}) of parameter 'creations' is out of range`);return!0})}get pays(){return this._pays}set pays(e){const t=/^\w{2}$/;this._pays=e.map(e=>e.toLowerCase()).filter(e=>{if(t.test(e))return!0;throw new Error(`Value(${e}) of parameter 'pays' is not allowed`)})}toRequest(){const e={};return this.text&&0<this.text.length&&(e.text=this.text),e.limit=this._limit,e.offset=this._offset,this.genres&&0<this.genres.length&&(e.genres=this.genres.join(ParamsSearchAbstract.separator)),this._diffusions&&0<this._diffusions.length&&(e.diffusions=this._diffusions.join(ParamsSearchAbstract.separator)),this._duration&&0<this._duration.length&&(e.duration=this._duration),this.svods&&0<this.svods.length&&(e.svods=this.svods.join(ParamsSearchAbstract.separator)),this._creations&&0<this._creations.length&&(e.creations=this._creations.join(ParamsSearchAbstract.separator)),this._pays&&0<this._pays.length&&(e.pays=this._pays.join(ParamsSearchAbstract.separator)),this.chaines&&0<this.chaines.length&&(e.chaines=this.chaines.join(ParamsSearchAbstract.separator)),this._tri&&0<this._tri.length&&(e.tri=this._tri),this._autres&&0<this._autres.length&&(e.autres=this._autres),this._fields&&0<this._fields.length&&(e.fields=this._fields.join(ParamsSearchAbstract.separator)),e}}class ParamsSearchMovies extends ParamsSearchAbstract{static valuesAllowed={diffusions:["none","salles","vente"],tri:["nom","ajout","id","note","popularite","release"],autres:["new","seen","unseen","wishlist"],fields:["id","release_date","poster","svods","slug","title"]};_releases;casting;constructor(){super(),this._releases=[]}get releases(){return this._releases}set releases(e){this._releases=e.filter(e=>{if(e<=1900||2100<e)throw new Error(`Value(${e.toString()}) of parameter 'releases' is out of range`);return!0})}toRequest(){const e={};return this.text&&0<this.text.length&&(e.text=this.text),e.limit=this._limit,e.offset=this._offset,this.genres&&0<this.genres.length&&(e.genres=this.genres.join(ParamsSearchAbstract.separator)),this._diffusions&&0<this._diffusions.length&&(e.diffusions=this._diffusions.join(ParamsSearchAbstract.separator)),this.casting&&0<this.casting.length&&(e.casting=this.casting),this.svods&&0<this.svods.length&&(e.svods=this.svods.join(ParamsSearchAbstract.separator)),this._releases&&0<this._releases.length&&(e.releases=this._releases.join(ParamsSearchAbstract.separator)),this._tri&&0<this._tri.length&&(e.tri=this._tri),this._autres&&0<this._autres.length&&(e.autres=this._autres),this._fields&&0<this._fields.length&&(e.fields=this._fields.join(ParamsSearchAbstract.separator)),e}}class Search{static logger=new UsBetaSeries.setDebug("Search");static debug=Search.logger.debug.bind(Search.logger);static searchShows(e){const i={shows:[],total:0,locale:"fr",limit:e.limit,page:e.offset};return UsBetaSeries.callApi(HTTP_VERBS.GET,"search","shows",e.toRequest()).then(e=>{const t=Object.keys(i);for(const s in e)0<=t.indexOf(s)&&(i[s]=e[s]);return i})}static getShowIds(e){return e.fields=["id"],this.searchShows(e).then(e=>{const t=[];for(const s in e.shows)t.push(e.shows[s].id);return t})}static searchMovies(e){const i={movies:[],total:0,locale:"fr",limit:e.limit,page:e.offset};return UsBetaSeries.callApi(HTTP_VERBS.GET,"search","movies",e.toRequest()).then(e=>{const t=Object.keys(i);for(const s in e)0<=t.indexOf(s)&&(i[s]=e[s]);return i})}}function validateType(e,t,s){const i=s.set,r=Reflect.getMetadata("design:type",e,t);s.set=function(e){if(e instanceof r)return i.call(this,{...e});throw new TypeError("Parameter type error. Required type: "+r.name)}}class AbstractDecorator{static logger=new UsBetaSeries.setDebug("Decorators");static debug=AbstractDecorator.logger.debug.bind(AbstractDecorator.logger);__target;constructor(e){return this.__target=e,this}get target(){return this.__target}set target(e){this.__target=e}}class FillDecorator extends AbstractDecorator{constructor(e){return super(e),this}fill(t){const h=this;var e,s=h.constructor;if("object"!=typeof t)throw e=new TypeError(s.name+".fill data is not an object: "+typeof t),console.error(e),e;if(!s.relatedProps)throw e=new Error(s.name+".fill, property static 'relatedProp' are required"),console.error(e),e;h.__changes={};for(const r in h.constructor.relatedProps)if(Reflect.has(t,r)){const n=h.constructor.relatedProps[r];var i=t[r];let e;h.__initial&&(e={configurable:!0,enumerable:!0,get:()=>h["_"+n.key],set:e=>{var t,s=((t,s,r,n,a)=>{var o=typeof n;const l=t["_"+s];var c=Reflect.has(a,"default"),e=Reflect.has(a,"transform");if(!isNull(n)&&e&&"function"==typeof a.transform?n=a.transform(t,n):isNull(n)&&c&&(n=a.default),!isNull(l)||!isNull(n)){let i=null;switch("string"==typeof r&&/^array<\w+>$/.test(r)&&(i=r.match(/<(\w+)>$/)[1],AbstractDecorator.debug("FillDecorator.fill for (%s.%s) type: array - subType: %s",h.constructor.name,s,i,n)),r){case"string":if(n=isNull(n)?c?a.default:null:String(n).trim(),l===n)return;break;case"number":if(isNull(n)||e||"string"!=o?isNull(n)&&c&&(n=a.default):n=parseInt(n,10),l===n)return;break;case"boolean":if("string"==typeof n?"true"===n.toLowerCase()||"1"===n?n=!0:"false"!==n.toLowerCase()&&"1"!==n||(n=!1):n=!!n,n="boolean"==typeof n?n:c?a.default:null,l===n)return;break;case"array":{if(!isNull(i)&&Array.isArray(n)){const d=[];let s=!1;UsBetaSeries.checkClassname(i)&&(s=!0);for(let t=0,e=n.length;t<e;t++){let e=n[t];s&&(e=UsBetaSeries.getInstance(i,[n[t]])),d.push(e)}n=d}else if(h.__initial||!Array.isArray(l))return n;let s=!1;for(let e=0,t=l.length;e<t;e++)if(l[e]!==n[e]){s=!0;break}if(s)break;return}case"date":if("string"==typeof n&&"0000-00-00"===n)return null;if("number"!=o&&!(n instanceof Date)&&"string"==o&&Number.isNaN(Date.parse(n)))throw new TypeError(`Invalid value for key "${s}". Expected type (Date | Number | string) but got `+JSON.stringify(n));if("number"!=o&&"string"!=o||(n=new Date(n)),l instanceof Date&&n.getTime()===l.getTime())return;break;default:{if("object"==o&&"object"===r?n=isNull(n)?c?a.default:null:Object.assign({},n):"function"!=typeof r||isNull(n)||n instanceof r||"object"==typeof(n=new r(n))&&Reflect.has(n,"parent")&&(n.parent=t),h.__initial||isNull(l))return n;let e=!1;try{if(isNull(l)&&!isNull(n)||!isNull(l)&&isNull(n)?e=!0:"object"!=typeof n||isNull(n)||JSON.stringify(l)!==JSON.stringify(n)&&(AbstractDecorator.debug("compare objects with JSON.stringify and are differents",{oldValue:l,value:n}),e=!0),!e)return}catch(e){throw console.warn("FillDecorator.fill => checkTypeValue: error setter[%s.%s]",t.constructor.name,s,{oldValue:l,value:n}),e}}}if("date"===r)r=Date;else if("other"===r&&e)return n;if("string"==typeof r&&typeof n!==r||"function"==typeof r&&!(n instanceof r))throw new TypeError(`Invalid value for key "${t.constructor.name}.${s}". Expected type "${"string"==typeof r?r:JSON.stringify(r)}" but got "${typeof n}"`);return n}})(h,n.key,n.type,e,n);h.__initial?h["_"+n.key]=s:(t=h["_"+n.key],void 0!==s&&(AbstractDecorator.debug("FillDecorator.fill setter[%s.%s] value changed",h.constructor.name,n.key,{type:n.type,newValue:e,oldValue:t,value:s,relatedProp:n}),h["_"+n.key]=s,h.__changes[n.key]={oldValue:t,newValue:e},this.updatePropRender(n.key)))}}),h.__initial&&(Object.defineProperty(h,n.key,e),h.__props.push(n.key)),h[n.key]=i}return h.__initial&&(h.__props.sort(),h.__initial=!1),h}updatePropRender(e){var t,s,i=this;i.elt&&i.__props.includes(e)&&(s="updatePropRender"+e.camelCase().upperFirst(),t=i.constructor,AbstractDecorator.debug("FillDecorator.updatePropRender(%s.%s)",t.name,e,s),Reflect.has(i,s)?(AbstractDecorator.debug("FillDecorator.updatePropRender call method: %s.%s",t.name,s),i[s]()):t.selectorsCSS&&t.selectorsCSS[e]&&(AbstractDecorator.debug("FillDecorator.updatePropRender default method: class: %s - selector: %s",t.name,t.selectorsCSS[e]),s=t.selectorsCSS[e],jQuery(s,i.elt).text(i[e].toString()),delete i.__changes[e]))}}class EmitterDecorator extends AbstractDecorator{__callbacks;constructor(e){if(super(e),Reflect.has(e.constructor,"EventTypes"))return this.__callbacks={},this;throw new Error(`Class: ${e.constructor.name} must have a static property "EventTypes"`)}hasListeners(e){return!!this.__callbacks[e].length}on(e,t){if(this.target.constructor.EventTypes.indexOf(e)<0)throw new Error(`EmitterDecorator.on: ${e} ne fait pas partit des events gérés par la classe `+this.target.constructor.name);this.__callbacks=this.__callbacks||{},this.__callbacks[e]=this.__callbacks[e]||[];for(const s of this.__callbacks[e])if("function"==typeof s&&s.toString()==t.toString())return this.target;return this.__callbacks[e].push(t),UsBetaSeries.debug&&AbstractDecorator.debug("EmitterDecorator.on[%s] addEventListener on event %s",this.target.constructor.name,e,this.__callbacks[e]),this.target}off(e,t){if(this.__callbacks=this.__callbacks||{},isNull(e)&&isNull(t))return this.__callbacks={},this.target;const s=this.__callbacks[e];if(!s)return this.target;if(isNull(t))return delete this.__callbacks[e],this.target;var i;for(let e=0;e<s.length;e++)if((i=s[e])===t||i.fn===t){s.splice(e,1);break}return 0===s.length&&delete this.__callbacks[e],this.target}once(t,s){const i=(...e)=>{AbstractDecorator.debug("EmiiterDecorator.once => on called"),this.off(t,i),s.apply(this.target,e)};return i.fn=s,this.on(t,i),this.target}emit(e,...s){UsBetaSeries.debug&&AbstractDecorator.debug("EmiiterDecorator.emit[%s] call Listeners of event %s",this.target.constructor.name,e,this.__callbacks),this.__callbacks=this.__callbacks||{};let i=this.__callbacks[e];if(i){s.unshift(new CustomEvent("betaseries",{detail:{event:e}}));for(let e=0,t=(i=i.slice(0)).length;e<t;++e)i[e].apply(this.target,s)}return this.target}}Media.prototype.fetchSimilars=function(){const s=this;return this.__fetches.similars||(this.similars=[],this.__fetches.similars=new Promise((e,t)=>{UsBetaSeries.callApi("GET",this.mediaType.plural,"similars",{id:this.id,details:!0},!0).then(t=>{if(t.similars)for(let e=0;e<t.similars.length;e++)s.similars.push(new Similar(t.similars[e][s.mediaType.singular],s.mediaType));s.save(),e(s),delete s.__fetches.similars},e=>{t(e),delete s.__fetches.similars})}),this.__fetches.similars)},UsBetaSeries.bsModule={Base:Base,CacheUS:CacheUS,Character:Character,CommentBS:CommentBS,CommentsBS:CommentsBS,Episode:Episode,Images:Images,Media:Media,MediaBase:MediaBase,Member:Member,Movie:Movie,Next:Next,Note:Note,NotificationBS:NotificationBS,NotificationList:NotificationList,NotifPayload:NotifPayload,Options:OptionsMember,Person:Person,PersonMedia:PersonMedia,PersonMedias:PersonMedias,Picture:Picture,Platform:Platform,PlatformList:PlatformList,ParamsSearchMovies:ParamsSearchMovies,ParamsSearchShows:ParamsSearchShows,Platforms:Platforms,RenderHtml:RenderHtml,Search:Search,Season:Season,Show:Show,Showrunner:Showrunner,Similar:Similar,Stats:Stats,Subtitle:Subtitle,UpdateAuto:UpdateAuto,User:User},UsBetaSeries.getInstance=(e,...t)=>(UsBetaSeries.bsModule[e],new UsBetaSeries.bsModule[e](t)),UsBetaSeries.checkClassname=e=>(UsBetaSeries.bsModule[e],!0);
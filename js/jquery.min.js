!function(t){var e;"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?(e=require("jquery"),module.exports=t(e)):t(jQuery)}(function(t){if(void 0===t)throw new Error("jQuery.textcomplete requires jQuery");var a,l,h;return function(s){"use strict";var r=1;s.fn.textcomplete=function(e,i){var o=Array.prototype.slice.call(arguments);return this.each(function(){var t=s(this),n=t.data("textComplete");n||((i=i||{})._oid=r++,n=new s.fn.textcomplete.Completer(this,i),t.data("textComplete",n)),"string"==typeof e?n&&(o.shift(),n[e].apply(n,o),"destroy"===e&&t.removeData("textComplete")):(s.each(e,function(i){s.each(["header","footer","placement","maxCount"],function(t){var e;i[t]&&(n.option[t]=i[t],e=t+"as a strategy param is deprecated. Use option.",console.warn&&console.warn(e),delete i[t])})}),n.register(s.fn.textcomplete.Strategy.parse(e,{el:this,$el:t})))})}}(t),function(s){"use strict";var n,o,r,a=0,l=[];function h(t,e){if(this.$el=s(t),this.id="textcomplete"+a++,this.strategies=[],this.views=[],this.option=s.extend({},h.defaults,e),!(this.$el.is("input[type=text]")||this.$el.is("input[type=search]")||this.$el.is("textarea")||t.isContentEditable||"true"==t.contentEditable))throw new Error("textcomplete must be called on a Textarea or a ContentEditable.");var i;t===t.ownerDocument.activeElement?this.initialize():((i=this).$el.one("focus."+this.id,function(){i.initialize()}),this.option.adapter&&"CKEditor"!=this.option.adapter||"undefined"==typeof CKEDITOR||!this.$el.is("textarea")||CKEDITOR.on("instanceReady",function(e){-1==s.inArray(e.editor.id,l)&&(l.push(e.editor.id),e.editor.on("focus",function(t){i.$el=s(e.editor.editable().$),i.option.adapter||(i.option.adapter=s.fn.textcomplete.CKEditor),i.option.ckeditor_instance=e.editor,i.initialize()}))}))}h.defaults={appendTo:"body",className:"",dropdownClassName:"dropdown-menu textcomplete-dropdown",maxCount:10,zIndex:"100",rightEdgeOffset:30},s.extend(h.prototype,{id:null,option:null,strategies:null,adapter:null,dropdown:null,$el:null,$iframe:null,initialize:function(){var t,e=this.$el.get(0);if(this.$el.prop("ownerDocument")!==document&&window.frames.length)for(var i=0;i<window.frames.length;i++)if(this.$el.prop("ownerDocument")===window.frames[i].document){this.$iframe=s(window.frames[i].frameElement);break}this.dropdown=new s.fn.textcomplete.Dropdown(e,this,this.option),t=this.option.adapter||(t=this.$el.is("textarea")||this.$el.is("input[type=text]")||this.$el.is("input[type=search]")?"number"==typeof e.selectionEnd?"Textarea":"IETextarea":"ContentEditable",s.fn.textcomplete[t]),this.adapter=new t(e,this,this.option)},destroy:function(){this.$el.off("."+this.id),this.adapter&&this.adapter.destroy(),this.dropdown&&this.dropdown.destroy(),this.$el=this.adapter=this.dropdown=null},deactivate:function(){this.dropdown&&this.dropdown.deactivate()},trigger:function(t,e){this.dropdown||this.initialize(),null==t&&(t=this.adapter.getTextFromHeadToCaret());var i,t=this._extractSearchQuery(t);t.length?(i=t[1],e&&this._term===i&&""!==i||(this._term=i,this._search.apply(this,t))):(this._term=null,this.dropdown.deactivate())},fire:function(t){var e=Array.prototype.slice.call(arguments,1);return this.$el.trigger(t,e),this},register:function(t){Array.prototype.push.apply(this.strategies,t)},select:function(t,e,i){this._term=null,this.adapter.select(t,e,i),this.fire("change").fire("textComplete:select",t,e),this.adapter.focus()},_clearAtNext:!0,_term:null,_extractSearchQuery:function(t){for(var e=0;e<this.strategies.length;e++){var i=this.strategies[e],n=i.context(t);if(n||""===n){var o=s.isFunction(i.match)?i.match(t):i.match,n=(t="[object String]"===Object.prototype.toString.call(n)?n:t).match(o);if(n)return[i,n[i.index],n]}}return[]},_search:(n=function(i,n,o,t){var s=this;n.search(o,function(t,e){s.dropdown.shown||s.dropdown.activate(),s._clearAtNext&&(s.dropdown.clear(),s._clearAtNext=!1),s.dropdown.setPosition(s.adapter.getCaretPosition()),s.dropdown.render(s._zip(t,n,o)),e||(i(),s._clearAtNext=!0)},t)},function(){var i,t=Array.prototype.slice.call(arguments);o?r=t:(o=!0,i=this,t.unshift(function t(){var e;r?(e=r,r=void 0,e.unshift(t),n.apply(i,e)):o=!1}),n.apply(this,t))}),_zip:function(t,e,i){return s.map(t,function(t){return{value:t,strategy:e,term:i}})}}),s.fn.textcomplete.Completer=h}(t),function(o){"use strict";var s=o(window),r={},i=(o(document).on("click",function(t){var i=t.originalEvent&&t.originalEvent.keepTextCompleteDropdown;o.each(r,function(t,e){t!==i&&e.deactivate()})}),{SKIP_DEFAULT:0,KEY_UP:1,KEY_DOWN:2,KEY_ENTER:3,KEY_PAGEUP:4,KEY_PAGEDOWN:5,KEY_ESCAPE:6});function a(t,e,i){this.$el=a.createElement(i),this.completer=e,this.id=e.id+"dropdown",this._data=[],this.$inputEl=o(t),(this.option=i).listPosition&&(this.setPosition=i.listPosition),i.height&&this.$el.height(i.height);var n=this;o.each(["maxCount","placement","footer","header","noResultsMessage","className"],function(t,e){null!=i[e]&&(n[e]=i[e])}),this._bindEvents(t),r[this.id]=this}o.extend(a,{createElement:function(t){var e=t.appendTo;return e instanceof o||(e=o(e)),o("<ul></ul>").addClass(t.dropdownClassName).attr("id","textcomplete-dropdown-"+t._oid).css({display:"none",left:0,position:"absolute",zIndex:t.zIndex}).appendTo(e)}}),o.extend(a.prototype,{$el:null,$inputEl:null,completer:null,footer:null,header:null,id:null,maxCount:null,placement:"",shown:!1,data:[],className:"",destroy:function(){this.deactivate(),this.$el.off("."+this.id),this.$inputEl.off("."+this.id),this.clear(),this.$el.remove(),this.$el=this.$inputEl=this.completer=null,delete r[this.id]},render:function(t){var e=this._buildContents(t),i=o.map(t,function(t){return t.value});t.length?((t=t[0].strategy).id?this.$el.attr("data-strategy",t.id):this.$el.removeAttr("data-strategy"),this._renderHeader(i),this._renderFooter(i),e&&(this._renderContents(e),this._fitToBottom(),this._fitToRight(),this._activateIndexedItem()),this._setScroll()):this.noResultsMessage?this._renderNoResultsMessage(i):this.shown&&this.deactivate()},setPosition:function(t){var e="absolute";return this.$inputEl.add(this.$inputEl.parents()).each(function(){return"absolute"!==o(this).css("position")&&("fixed"===o(this).css("position")?(t.top-=s.scrollTop(),t.left-=s.scrollLeft(),!(e="fixed")):void 0)}),this.$el.css(this._applyPlacement(t)),this.$el.css({position:e}),this},clear:function(){this.$el.html(""),this.data=[],this._index=0,this._$header=this._$footer=this._$noResultsMessage=null},activate:function(){return this.shown||(this.clear(),this.$el.show(),this.className&&this.$el.addClass(this.className),this.completer.fire("textComplete:show"),this.shown=!0),this},deactivate:function(){return this.shown&&(this.$el.hide(),this.className&&this.$el.removeClass(this.className),this.completer.fire("textComplete:hide"),this.shown=!1),this},isUp:function(t){return 38===t.keyCode||t.ctrlKey&&80===t.keyCode},isDown:function(t){return 40===t.keyCode||t.ctrlKey&&78===t.keyCode},isEnter:function(t){return!(t.ctrlKey||t.altKey||t.metaKey||t.shiftKey)&&(13===t.keyCode||9===t.keyCode||!0===this.option.completeOnSpace&&32===t.keyCode)},isPageup:function(t){return 33===t.keyCode},isPagedown:function(t){return 34===t.keyCode},isEscape:function(t){return 27===t.keyCode},_data:null,_index:null,_$header:null,_$noResultsMessage:null,_$footer:null,_bindEvents:function(){this.$el.on("mousedown."+this.id,".textcomplete-item",o.proxy(this._onClick,this)),this.$el.on("touchstart."+this.id,".textcomplete-item",o.proxy(this._onClick,this)),this.$el.on("mouseover."+this.id,".textcomplete-item",o.proxy(this._onMouseover,this)),this.$inputEl.on("keydown."+this.id,o.proxy(this._onKeydown,this))},_onClick:function(t){var e=o(t.target),e=(t.preventDefault(),t.originalEvent.keepTextCompleteDropdown=this.id,e.hasClass("textcomplete-item")||(e=e.closest(".textcomplete-item")),this.data[parseInt(e.data("index"),10)]),i=(this.completer.select(e.value,e.strategy,t),this);setTimeout(function(){i.deactivate(),"touchstart"===t.type&&i.$inputEl.focus()},0)},_onMouseover:function(t){var e=o(t.target);t.preventDefault(),e.hasClass("textcomplete-item")||(e=e.closest(".textcomplete-item")),this._index=parseInt(e.data("index"),10),this._activateIndexedItem()},_onKeydown:function(t){var e;if(this.shown)switch(e=null==(e=o.isFunction(this.option.onKeydown)?this.option.onKeydown(t,i):e)?this._defaultKeydown(t):e){case i.KEY_UP:t.preventDefault(),this._up();break;case i.KEY_DOWN:t.preventDefault(),this._down();break;case i.KEY_ENTER:t.preventDefault(),this._enter(t);break;case i.KEY_PAGEUP:t.preventDefault(),this._pageup();break;case i.KEY_PAGEDOWN:t.preventDefault(),this._pagedown();break;case i.KEY_ESCAPE:t.preventDefault(),this.deactivate()}},_defaultKeydown:function(t){return this.isUp(t)?i.KEY_UP:this.isDown(t)?i.KEY_DOWN:this.isEnter(t)?i.KEY_ENTER:this.isPageup(t)?i.KEY_PAGEUP:this.isPagedown(t)?i.KEY_PAGEDOWN:this.isEscape(t)?i.KEY_ESCAPE:void 0},_up:function(){0===this._index?this._index=this.data.length-1:--this._index,this._activateIndexedItem(),this._setScroll()},_down:function(){this._index===this.data.length-1?this._index=0:this._index+=1,this._activateIndexedItem(),this._setScroll()},_enter:function(t){var e=this.data[parseInt(this._getActiveElement().data("index"),10)];this.completer.select(e.value,e.strategy,t),this.deactivate()},_pageup:function(){var e=0,i=this._getActiveElement().position().top-this.$el.innerHeight();this.$el.children().each(function(t){if(o(this).position().top+o(this).outerHeight()>i)return e=t,!1}),this._index=e,this._activateIndexedItem(),this._setScroll()},_pagedown:function(){var e=this.data.length-1,i=this._getActiveElement().position().top+this.$el.innerHeight();this.$el.children().each(function(t){if(o(this).position().top>i)return e=t,!1}),this._index=e,this._activateIndexedItem(),this._setScroll()},_activateIndexedItem:function(){this.$el.find(".textcomplete-item.active").removeClass("active"),this._getActiveElement().addClass("active")},_getActiveElement:function(){return this.$el.children(".textcomplete-item:nth("+this._index+")")},_setScroll:function(){var t=this._getActiveElement(),e=t.position().top,t=t.outerHeight(),i=this.$el.innerHeight(),n=this.$el.scrollTop();0===this._index||this._index==this.data.length-1||e<0?this.$el.scrollTop(e+n):i<e+t&&this.$el.scrollTop(e+t+n-i)},_buildContents:function(t){for(var e,i,n="",o=0;o<t.length&&this.data.length!==this.maxCount;o++)e=t[o],function(t,e){for(var i,n=e.strategy.idProperty,o=0;o<t.length;o++)if((i=t[o]).strategy===e.strategy)if(n){if(i.value[n]===e.value[n])return!0}else if(i.value===e.value)return!0;return!1}(this.data,e)||(i=this.data.length,this.data.push(e),n=(n+='<li class="textcomplete-item" data-index="'+i+'"><a>')+e.strategy.template(e.value,e.term)+"</a></li>");return n},_renderHeader:function(t){this.header&&(this._$header||(this._$header=o('<li class="textcomplete-header"></li>').prependTo(this.$el)),t=o.isFunction(this.header)?this.header(t):this.header,this._$header.html(t))},_renderFooter:function(t){this.footer&&(this._$footer||(this._$footer=o('<li class="textcomplete-footer"></li>').appendTo(this.$el)),t=o.isFunction(this.footer)?this.footer(t):this.footer,this._$footer.html(t))},_renderNoResultsMessage:function(t){this.noResultsMessage&&(this._$noResultsMessage||(this._$noResultsMessage=o('<li class="textcomplete-no-results-message"></li>').appendTo(this.$el)),t=o.isFunction(this.noResultsMessage)?this.noResultsMessage(t):this.noResultsMessage,this._$noResultsMessage.html(t))},_renderContents:function(t){this._$footer?this._$footer.before(t):this.$el.append(t)},_fitToBottom:function(){var t=s.scrollTop()+s.height(),e=this.$el.height();this.$el.position().top+e>t&&(this.completer.$iframe||this.$el.offset({top:t-e}))},_fitToRight:function(){for(var t,e=this.option.rightEdgeOffset,i=this.$el.offset().left,n=this.$el.width(),o=s.width()-e;o<i+n&&(this.$el.offset({left:i-e}),!(i<=(t=this.$el.offset().left)));)i=t},_applyPlacement:function(t){return-1!==this.placement.indexOf("top")?t={top:"auto",bottom:this.$el.parent().height()-t.top+t.lineHeight,left:t.left}:(t.bottom="auto",delete t.lineHeight),-1!==this.placement.indexOf("absleft")?t.left=0:-1!==this.placement.indexOf("absright")&&(t.right=0,t.left="auto"),t}}),o.fn.textcomplete.Dropdown=a,o.extend(o.fn.textcomplete,i)}(t),function(i){"use strict";function n(t){var n,o;i.extend(this,t),this.cache&&(this.search=(n=this.search,o={},function(e,i){o[e]?i(o[e]):n.call(this,e,function(t){o[e]=(o[e]||[]).concat(t),i.apply(null,arguments)})}))}n.parse=function(t,e){return i.map(t,function(t){t=new n(t);return t.el=e.el,t.$el=e.$el,t})},i.extend(n.prototype,{match:null,replace:null,search:null,id:null,cache:!1,context:function(){return!0},index:2,template:function(t){return t},idProperty:null}),i.fn.textcomplete.Strategy=n}(t),function(n){"use strict";function o(e,i){function n(){var t=h()-a;t<i?o=setTimeout(n,i-t):(o=null,l=e.apply(r,s),r=s=null)}var o,s,r,a,l;return function(){return r=this,s=arguments,a=h(),o=o||setTimeout(n,i),l}}var h=Date.now||function(){return(new Date).getTime()};function t(){}n.extend(t.prototype,{id:null,completer:null,el:null,$el:null,option:null,initialize:function(t,e,i){this.el=t,this.$el=n(t),this.id=e.id+this.constructor.name,this.completer=e,this.option=i,this.option.debounce&&(this._onKeyup=o(this._onKeyup,this.option.debounce)),this._bindEvents()},destroy:function(){this.$el.off("."+this.id),this.$el=this.el=this.completer=null},select:function(){throw new Error("Not implemented")},getCaretPosition:function(){var t=this._getCaretRelativePosition(),e=this.$el.offset(),i=this.option.appendTo;return i&&(i=(i=i instanceof n?i:n(i)).offsetParent().offset(),e.top-=i.top,e.left-=i.left),t.top+=e.top,t.left+=e.left,t},focus:function(){this.$el.focus()},_bindEvents:function(){this.$el.on("keyup."+this.id,n.proxy(this._onKeyup,this))},_onKeyup:function(t){this._skipSearch(t)||this.completer.trigger(this.getTextFromHeadToCaret(),!0)},_skipSearch:function(t){switch(t.keyCode){case 9:case 13:case 16:case 17:case 18:case 33:case 34:case 40:case 38:case 27:return!0}if(t.ctrlKey)switch(t.keyCode){case 78:case 80:return!0}}}),n.fn.textcomplete.Adapter=t}(t),function(s){"use strict";function t(t,e,i){this.initialize(t,e,i)}s.extend(t.prototype,s.fn.textcomplete.Adapter.prototype,{select:function(t,e,i){var n=this.getTextFromHeadToCaret(),o=this.el.value.substring(this.el.selectionEnd),t=e.replace(t,i);void 0!==t&&(s.isArray(t)&&(o=t[1]+o,t=t[0]),i=s.isFunction(e.match)?e.match(n):e.match,n=n.replace(i,t),this.$el.val(n+o),this.el.selectionStart=this.el.selectionEnd=n.length)},getTextFromHeadToCaret:function(){return this.el.value.substring(0,this.el.selectionEnd)},_getCaretRelativePosition:function(){var t=s.fn.textcomplete.getCaretCoordinates(this.el,this.el.selectionStart);return{top:t.top+this._calculateLineHeight()-this.$el.scrollTop(),left:t.left-this.$el.scrollLeft(),lineHeight:this._calculateLineHeight()}},_calculateLineHeight:function(){var t,e,i,n=parseInt(this.$el.css("line-height"),10);return isNaN(n)&&(t=this.el.parentNode,e=document.createElement(this.el.nodeName),i=this.el.style,e.setAttribute("style","margin:0px;padding:0px;font-family:"+i.fontFamily+";font-size:"+i.fontSize),e.innerHTML="test",t.appendChild(e),n=e.clientHeight,t.removeChild(e)),n}}),s.fn.textcomplete.Textarea=t}(t),function(s){"use strict";function t(t,e,i){this.initialize(t,e,i),s("<span>吶</span>").css({position:"absolute",top:-9999,left:-9999}).insertBefore(t)}s.extend(t.prototype,s.fn.textcomplete.Textarea.prototype,{select:function(t,e,i){var n=this.getTextFromHeadToCaret(),o=this.el.value.substring(n.length),t=e.replace(t,i);void 0!==t&&(s.isArray(t)&&(o=t[1]+o,t=t[0]),i=s.isFunction(e.match)?e.match(n):e.match,n=n.replace(i,t),this.$el.val(n+o),this.el.focus(),(e=this.el.createTextRange()).collapse(!0),e.moveEnd("character",n.length),e.moveStart("character",n.length),e.select())},getTextFromHeadToCaret:function(){this.el.focus();var t=document.selection.createRange(),t=(t.moveStart("character",-this.el.value.length),t.text.split("吶"));return 1===t.length?t[0]:t[1]}}),s.fn.textcomplete.IETextarea=t}(t),function(p){"use strict";function t(t,e,i){this.initialize(t,e,i)}p.extend(t.prototype,p.fn.textcomplete.Adapter.prototype,{select:function(t,e,i){var n=this.getTextFromHeadToCaret(),o=this.el.ownerDocument.getSelection(),s=o.getRangeAt(0),r=s.cloneRange();r.selectNodeContents(s.startContainer);r=r.toString().substring(s.startOffset),t=e.replace(t,i);if(void 0!==t){p.isArray(t)&&(r=t[1]+r,t=t[0]),i=p.isFunction(e.match)?e.match(n):e.match,n=n.replace(i,t).replace(/ $/,"&nbsp"),s.selectNodeContents(s.startContainer),s.deleteContents();for(var a,l,h=this.el.ownerDocument.createElement("div"),c=(h.innerHTML=n,this.el.ownerDocument.createElement("div")),d=(c.innerHTML=r,this.el.ownerDocument.createDocumentFragment());a=h.firstChild;)l=d.appendChild(a);for(;a=c.firstChild;)d.appendChild(a);s.insertNode(d),s.setStartAfter(l),s.collapse(!0),o.removeAllRanges(),o.addRange(s)}},_getCaretRelativePosition:function(){var t,e=this.el.ownerDocument.getSelection().getRangeAt(0).cloneRange(),i=e.endContainer.parentNode,n=this.el.ownerDocument.createElement("span"),e=(e.insertNode(n),e.selectNodeContents(n),e.deleteContents(),setTimeout(function(){i.normalize()},0),p(n)),n=e.offset();return n.left-=this.$el.offset().left,n.top+=e.height()-this.$el.offset().top,n.lineHeight=e.height(),this.completer.$iframe&&(t=this.completer.$iframe.offset(),n.top+=t.top,n.left+=t.left,n.top-=p(this.completer.$iframe[0].contentWindow.document).scrollTop()),e.remove(),n},getTextFromHeadToCaret:function(){var t=this.el.ownerDocument.getSelection().getRangeAt(0),e=t.cloneRange();return e.selectNodeContents(t.startContainer),e.toString().substring(0,t.startOffset)}}),p.fn.textcomplete.ContentEditable=t}(t),function(t){"use strict";function e(t,e,i){this.initialize(t,e,i)}t.extend(e.prototype,t.fn.textcomplete.ContentEditable.prototype,{_bindEvents:function(){var e=this;this.option.ckeditor_instance.on("key",function(t){t=t.data;if(e._onKeyup(t),e.completer.dropdown.shown&&e._skipSearch(t))return!1},null,null,1),this.$el.on("keyup."+this.id,t.proxy(this._onKeyup,this))}}),t.fn.textcomplete.CKEditor=e}(t),a=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],l="undefined"!=typeof window,h=l&&null!=window.mozInnerScreenX,t.fn.textcomplete.getCaretCoordinates=function(t,e,i){if(!l)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");(i=i&&i.debug||!1)&&(n=document.querySelector("#input-textarea-caret-position-mirror-div"))&&n.parentNode.removeChild(n);var n=document.createElement("div"),o=(n.id="input-textarea-caret-position-mirror-div",document.body.appendChild(n),n.style),s=window.getComputedStyle?getComputedStyle(t):t.currentStyle,r=(o.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(o.wordWrap="break-word"),o.position="absolute",i||(o.visibility="hidden"),a.forEach(function(t){o[t]=s[t]}),h?t.scrollHeight>parseInt(s.height)&&(o.overflowY="scroll"):o.overflow="hidden",n.textContent=t.value.substring(0,e),"INPUT"===t.nodeName&&(n.textContent=n.textContent.replace(/\s/g," ")),document.createElement("span")),t=(r.textContent=t.value.substring(e)||".",n.appendChild(r),{top:r.offsetTop+parseInt(s.borderTopWidth),left:r.offsetLeft+parseInt(s.borderLeftWidth)});return i?r.style.backgroundColor="#aaa":document.body.removeChild(n),t},t});